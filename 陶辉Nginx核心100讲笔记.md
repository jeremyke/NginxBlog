<a name="742e8d92"></a>
## 一、初始Nginx
<a name="dbd5b60a"></a>
### 1.1 nginx应用场景
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665221885855-8e69cfdf-9e5a-47eb-b65c-3a9c1c13f846.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=586&id=LL1zE&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1172&originWidth=2112&originalType=binary&ratio=1&rotation=0&showTitle=false&size=928999&status=done&style=none&taskId=uddb9f030-3d60-4932-8c4c-cced0a440f1&title=&width=1056)


<a name="fb41ed92"></a>
### 1.2 Nginx优点
![A82E994B-DDE1-4C48-A3B1-4CC72150E101.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222143941-e2d0ae90-a832-4c60-83e7-5154f53ec9eb.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=511&id=u59c349bd&margin=%5Bobject%20Object%5D&name=A82E994B-DDE1-4C48-A3B1-4CC72150E101.png&originHeight=1022&originWidth=1938&originalType=binary&ratio=1&rotation=0&showTitle=false&size=973178&status=done&style=none&taskId=udfc4d868-cc8d-4074-9e67-588b458f05f&title=&width=969)


<a name="7466f46b"></a>
### 1.3 Nginx组成
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222223070-7a6a391d-1ff5-4748-986b-e2e092e42b59.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=413&id=u4baf27df&margin=%5Bobject%20Object%5D&name=image.png&originHeight=826&originWidth=1516&originalType=binary&ratio=1&rotation=0&showTitle=false&size=690551&status=done&style=none&taskId=u093b0ccd-1ef0-476e-8b8f-a703c56616d&title=&width=758)
<a name="8aa785b6"></a>
### 1.4 Nginx配置语法

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222240753-b460a100-854d-464e-8278-3867722fc8b5.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=415&id=u546695db&margin=%5Bobject%20Object%5D&name=image.png&originHeight=830&originWidth=1480&originalType=binary&ratio=1&rotation=0&showTitle=false&size=815741&status=done&style=none&taskId=u2c247769-0483-4af3-a4c5-377f3d3f97e&title=&width=740)
<a name="MFiqE"></a>
### ![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222324771-f041dab5-f09d-4f20-a938-3eeb16c8f6f6.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=438&id=ueaec73dd&margin=%5Bobject%20Object%5D&name=image.png&originHeight=876&originWidth=1380&originalType=binary&ratio=1&rotation=0&showTitle=false&size=328505&status=done&style=none&taskId=u790be97a-4b0b-4db9-a113-d50a1b57b6c&title=&width=690)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222302966-b7773f16-f073-4db8-bd0d-c55e583cb1c2.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=434&id=uc3b7e24a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=868&originWidth=1548&originalType=binary&ratio=1&rotation=0&showTitle=false&size=473105&status=done&style=none&taskId=u7ab99a62-6fc6-40aa-bcf5-ac954f839af&title=&width=774)
<a name="hvVnr"></a>
### ![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222338528-fe2cb99d-f688-4aac-b120-52d267606fc7.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=426&id=ufad33ad3&margin=%5Bobject%20Object%5D&name=image.png&originHeight=852&originWidth=1460&originalType=binary&ratio=1&rotation=0&showTitle=false&size=423949&status=done&style=none&taskId=ue31bfd4f-7edb-48e8-bee3-31d0eadd078&title=&width=730)
<a name="b6c1727d"></a>
### 1.5 Nginx 命令行
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222396697-a133ad40-b5cb-4734-b98f-2aee084d6782.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=432&id=ufa43ac01&margin=%5Bobject%20Object%5D&name=image.png&originHeight=864&originWidth=1456&originalType=binary&ratio=1&rotation=0&showTitle=false&size=646525&status=done&style=none&taskId=ua093ced4-fbab-4ecb-b65f-e2afac5a6ab&title=&width=728)
<a name="cd7efa5c"></a>
### 1.6 日志

web日志分析工具：goaccess

<a name="bb5f11be"></a>
### 1.7 SSl安全协议
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222434053-ea75cbbd-aea2-47e2-a38d-0a2a682248e7.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=433&id=u167fc52b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=866&originWidth=1512&originalType=binary&ratio=1&rotation=0&showTitle=false&size=771135&status=done&style=none&taskId=ueb77d876-4757-4a44-929f-609bbe79b3b&title=&width=756)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222446978-94df98ba-1ce8-4f10-bfb5-b3acf4143e25.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=428&id=uc42cac93&margin=%5Bobject%20Object%5D&name=image.png&originHeight=856&originWidth=1486&originalType=binary&ratio=1&rotation=0&showTitle=false&size=651764&status=done&style=none&taskId=u66318642-6518-4f37-881c-daa3d2ee47b&title=&width=743)
<a name="hH81X"></a>
#### 1.7.1 对称加密
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222458373-adf99033-9c6a-4ecd-9ffb-3221d9dfd963.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=418&id=u555e3556&margin=%5Bobject%20Object%5D&name=image.png&originHeight=836&originWidth=1326&originalType=binary&ratio=1&rotation=0&showTitle=false&size=194153&status=done&style=none&taskId=u171d1452-7cc7-4148-819a-3072fd184a3&title=&width=663)


基于异或算法，明文可以转为密文，密文也可以转为明文，而且性能好，只需要一次便历过程。

<a name="MuJNz"></a>
#### 1.7.2 非对称加密
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222589396-8e4d5c3e-a6bd-4155-8e99-ba7e0306eeb3.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=355&id=u8daa4a38&margin=%5Bobject%20Object%5D&name=image.png&originHeight=710&originWidth=1590&originalType=binary&ratio=1&rotation=0&showTitle=false&size=341051&status=done&style=none&taskId=u9747b1f9-8adb-4fff-904d-31432c7860a&title=&width=795)<br />自己发出去的文本用私钥加密，接收方使用公钥加密；反之，接收方回复消息使用公钥加密，自己使用私钥解密。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222601437-d8c1ef41-849a-4f29-abf5-a03551629f9c.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=450&id=u88a77c62&margin=%5Bobject%20Object%5D&name=image.png&originHeight=900&originWidth=1534&originalType=binary&ratio=1&rotation=0&showTitle=false&size=529082&status=done&style=none&taskId=ue0ecf4c4-4058-4ead-8437-50c04108c19&title=&width=767)

在Nginx上可以设置为：

```shell
ssl_verify_client on;#以便 OCSP 验证工作
ssl_ocsp on;#启用客户端证书链的 OCSP 验证
resolver 192.0.2.1;#解析器应指定为解析 OCSP 响应器主机名
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222718734-a883ea03-b4d1-4149-bc23-c1b2c16e5c1a.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=424&id=u08d2c9e7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=848&originWidth=1510&originalType=binary&ratio=1&rotation=0&showTitle=false&size=644753&status=done&style=none&taskId=u3637df4c-3da2-4c23-8cc1-93edeb8830b&title=&width=755)

浏览器获取到证书后如何生效，需要验证证书链：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222733240-b515df53-b607-4e31-9584-247ae7cbf1e1.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=403&id=u7bd89cd0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=806&originWidth=1596&originalType=binary&ratio=1&rotation=0&showTitle=false&size=706121&status=done&style=none&taskId=u25b277c3-4a01-4f3a-aa71-ab14d0bed78&title=&width=798)<br />**说明：**<br />站点证书由三部分构成（根证书、二级证书、主证书），操作系统的根证书很难修改，大部分浏览器（除firebox）使用的是操作系统的证书库。所以浏览器在验证证书是否有效时，除了验证nginx发过来的两个证书（二级证书和主站点证书）是否过期外，还要要在根证书是否有效且被认证。

<a name="a0dad338"></a>
#### 1.7.3 TLS的通信过程

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222768629-d0ef223e-d4c4-4cd8-bcf5-449ce55cc916.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=445&id=ufb99ad14&margin=%5Bobject%20Object%5D&name=image.png&originHeight=890&originWidth=1614&originalType=binary&ratio=1&rotation=0&showTitle=false&size=717638&status=done&style=none&taskId=u72971e82-41b9-420d-b364-d9cf4dc558a&title=&width=807)

第一步：浏览器向服务器发送clinet hello消息，告诉服务器我支持哪些加密算法；<br />第二步：服务器把最偏向的加密算法发送给客户端，发送server hello消息，告诉服务器最终选择哪个安全套件；<br />第三步：服务器向客户端发送证书链；<br />第四步：客户端验证服务器相关证书；<br />第五步：服务器发送server hello done,且在第五步前向客户的发送加密算法的公共参数；<br />第六步：浏览器根据公共参数生成自己的私钥，再把公钥发送给服务器；<br />第七步：服务器生成自己的一对公钥和私钥，用自己的私钥和客户端发来的私钥，生成双方加密的密钥。<br />第八步：浏览器根据服务器发来的公钥和自己生成的私钥也会生成双方加密的密钥，通过非对称加密，二者生成的密钥是相同的。<br />第九步：服务器使用生成的密钥加密发送的消息，传给浏览器。

**Nginx对加密算法的优化：**

对于小文件，Nginx需要优化非对称加密算法,适当弱化密码强度；<br />对于大文件，需要考虑优化对称加密算法（AES）。

<a name="4bf8a045"></a>
#### 1.7.4 使用免费SSL证书把Http网站改造为Https网站

```shell
[root]:yum install python2-certbot-nginx
[root]:certbot --nginx --nginx-server-root=conf目录 -d 需要安装证书的server name
```

<a name="75220692"></a>
### 1.8 基于openResty使用lua实现简单服务

<a name="de9453e1"></a>
#### 1.8.1 下载

openresty.org-->下载-->源码发布--下载-->解压

<a name="2009ab2c"></a>
#### 1.8.2 分析目录结构
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222791830-6e182d28-e9d9-4682-b63e-a7bd2fb41b24.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=216&id=u1ff86b65&margin=%5Bobject%20Object%5D&name=image.png&originHeight=432&originWidth=1130&originalType=binary&ratio=1&rotation=0&showTitle=false&size=497671&status=done&style=none&taskId=u7369271d-1f04-43a0-9dcf-43f18a49c33&title=&width=565)


<a name="f25a5203"></a>
#### 1.8.3 编译

编译一个基本的openresty .configure<br />make&make install

<a name="ef784766"></a>
#### 1.8.4 添加lua代码
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222810908-7291f3c1-0bd1-4d21-a818-4e48ffd8adfd.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=295&id=u2936c073&margin=%5Bobject%20Object%5D&name=image.png&originHeight=590&originWidth=1524&originalType=binary&ratio=1&rotation=0&showTitle=false&size=230878&status=done&style=none&taskId=uba1fba36-a7c0-4dda-9ee6-9a7020d9543&title=&width=762)
<a name="9674ceeb"></a>
#### 1.8.5 运行
	
<a name="304997b8"></a>
## 二、Nginx架构基础

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222846506-99ca0c12-c2ba-4d62-ae95-6ceacc7106f3.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=438&id=ud746df97&margin=%5Bobject%20Object%5D&name=image.png&originHeight=876&originWidth=1600&originalType=binary&ratio=1&rotation=0&showTitle=false&size=816530&status=done&style=none&taskId=ua40d20a8-ec6a-4ac8-b50b-dac5dec87ec&title=&width=800)

<a name="4305e441"></a>
### 2.1 Nginx的进程结构
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222878060-c0e0343e-f453-44b7-a64a-c7a14335ef15.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=427&id=u487ab640&margin=%5Bobject%20Object%5D&name=image.png&originHeight=854&originWidth=1412&originalType=binary&ratio=1&rotation=0&showTitle=false&size=560212&status=done&style=none&taskId=u3bf290f2-ccfd-458a-94da-318e85a25e4&title=&width=706)<br />Nginx包含master进程和子进程，子进程又分为两大类，Cache相关进程和worker进程，子进程间的通信是通过共享内存来解决的。<br />master进程：用来管理worker进程，负责监控worker进程正常工作，是否需要重新加载配置文件等。<br />缓存：是多个worker进程共享的，同时也会被cache manager（缓存的关联）和cache loader（缓存的载入）进程使用。cache manager和cache loader进程使用是用于后端发来的动态请求做缓存的来使用的。<br />为了保证Nginx的高可用性，nginx被设计为多进程的模式，因为多线程不同线程会共享一块内存空间，线程间相互影响，如果一个第三方模块导致地址越界等问题会使得整个Nginx全部挂掉。

<a name="a017e666"></a>
### 2.2 使用信号管理Nginx父子进程
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222892459-f5334b76-aa54-4cf1-8815-1749d667f2c0.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=420&id=u1019b4de&margin=%5Bobject%20Object%5D&name=image.png&originHeight=840&originWidth=1520&originalType=binary&ratio=1&rotation=0&showTitle=false&size=556853&status=done&style=none&taskId=u1a9a6968-3180-4cb3-9b6f-c758e22b7be&title=&width=760)
<a name="349047a6"></a>
### 2.3 reload流程
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222909250-b0091d2b-4b5e-415c-99dd-63f3e03807d2.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=480&id=ua44596f6&margin=%5Bobject%20Object%5D&name=image.png&originHeight=960&originWidth=1794&originalType=binary&ratio=1&rotation=0&showTitle=false&size=965935&status=done&style=none&taskId=u8e0ac1bc-328a-46e5-b34d-a6332fcd8a0&title=&width=897)
<a name="nAYXC"></a>
### ![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222926079-b419f78e-8f14-4ee3-9f84-0a6bfdc77bc6.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=494&id=ue50573a9&margin=%5Bobject%20Object%5D&name=image.png&originHeight=988&originWidth=1800&originalType=binary&ratio=1&rotation=0&showTitle=false&size=579088&status=done&style=none&taskId=ua1f257c9-6f0c-4c10-886d-298b0cd6a84&title=&width=900)
<a name="405885be"></a>
### 2.4 热升级流程
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222941044-42635f8e-94e2-46e8-8024-e79b00d6c1fe.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=393&id=u5e6dc846&margin=%5Bobject%20Object%5D&name=image.png&originHeight=786&originWidth=1450&originalType=binary&ratio=1&rotation=0&showTitle=false&size=703236&status=done&style=none&taskId=u2436f5c7-22ff-44a9-b7c7-dff30a2e78d&title=&width=725)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222950962-97e693a8-288f-48e3-929b-0420f7664c08.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=399&id=u06a3e15a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=798&originWidth=1512&originalType=binary&ratio=1&rotation=0&showTitle=false&size=442930&status=done&style=none&taskId=u6576c8e6-74a3-4490-b5e9-24029966232&title=&width=756)

<a name="b7f9ebcc"></a>
### 2.5 优化的关闭worker进程

优化的关闭只针对Http请求，对于websocket,TCP，UDP，Nginx无法得知worker是否在处理请求。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665222968068-41a100c2-95f5-48b2-a06a-189a5260dc46.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=396&id=u267339ed&margin=%5Bobject%20Object%5D&name=image.png&originHeight=792&originWidth=1426&originalType=binary&ratio=1&rotation=0&showTitle=false&size=504452&status=done&style=none&taskId=ubc2ac892-79a0-4e7d-ba7b-80c350f4624&title=&width=713)

<a name="d1e7e213"></a>
### 2.6 网络收发和Nginx事件间的对应关系

Nginx是一个事件驱动的框架，事件是指网络事件，一个网络连接对应两个事件（读事件和写事件）

<a name="b3b2d79d"></a>
#### 2.6.1 网络传输
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223026625-b89b03eb-c37c-42ce-a5a3-035d8dac58e0.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=674&id=u0565fcd0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1348&originWidth=2472&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1078525&status=done&style=none&taskId=u633d97ba-b09e-4edb-94b3-01ebc78ba71&title=&width=1236)
<a name="1f37e31e"></a>
#### 2.6.2 TCP流和报文

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223039120-67dfa146-012a-49a7-a378-8e749f3ad94d.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=672&id=u5ede5806&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1344&originWidth=2434&originalType=binary&ratio=1&rotation=0&showTitle=false&size=971254&status=done&style=none&taskId=u834386c2-d0e9-410e-85a1-edc29a53265&title=&width=1217)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223048625-79df7386-5f43-433f-add3-9301e4aabc16.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=657&id=ue85904c3&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1314&originWidth=2394&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1049871&status=done&style=none&taskId=uaea3a798-39f8-4825-9bcb-400c221f76b&title=&width=1197)

<a name="9188ecab"></a>
### 2.7 Nginx事件循环
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223062805-4a8a0616-ae06-4b28-8053-be0f9e5c83fd.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=659&id=u1e9fce32&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1318&originWidth=2266&originalType=binary&ratio=1&rotation=0&showTitle=false&size=570999&status=done&style=none&taskId=u6cc79520-a8d8-41a7-9be6-5c635283aa3&title=&width=1133)


<a name="d7c431ab"></a>
#### 2.7.1 epool优劣已经原理

上图nginx等待服务器内核的事件队列使用epool来处理的。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223079425-2d40cecd-b36a-4919-bc8f-c9ed3e6a4323.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=677&id=uf37f6e9b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1354&originWidth=2398&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1073766&status=done&style=none&taskId=udcf0d437-d241-47e1-b3bc-2995e6b7fb1&title=&width=1199)

<a name="4f4bfb9a"></a>
### 2.8 Nginx的请求切换
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223099895-f740ad47-6ebe-4f0e-be97-cbc13c153ca2.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=673&id=u30e09ba8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1346&originWidth=2418&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1149441&status=done&style=none&taskId=u6a575f63-c9a8-4d8e-87d2-dc1be5c0ebc&title=&width=1209)

nginx是用户态直接切换的，除非操作系统分给worker的时间分片到期了，否则一直工作，所以将worker的优先级调为-19，可以使得操作系统给worker分配更多的时间分片，提高Nginx性能。

<a name="0d932f4c"></a>
### 2.9 同步和异步、阻塞和非阻塞的区别
阻塞和非阻塞是线程在访问某个资源时，数据是否准备就绪的一种处理方式。

阻塞方法：操作系统或者底层C库提供的方法或者是一个系统调用，这个方法可能是我的进程进入sleep状态（当前条件不满足，操作系统把我的进程切换到另外一个进程）。<br />非阻塞方法：我们调用该方法永远不会在我们时间分片未用完时，切换到另外一个进程。

同步和异步是用户态的调用方式而言。

同步：调用方法时，需要等待返回结果。<br />异步：调用方法后，无需等待返回结果，被调用方法处理完成后后主动通知给调用方。（支付回调）

<a name="ZUHtJ"></a>
#### 2.9.1 阻塞调用：
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223124881-dfdd3391-7c42-4799-8c3e-1e00a36a6cee.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=635&id=mmbW1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1270&originWidth=2308&originalType=binary&ratio=1&rotation=0&showTitle=false&size=756496&status=done&style=none&taskId=ufef84591-1516-49f2-bdb2-77410e81f32&title=&width=1154)
<a name="PgqX3"></a>
#### 2.9.2 非阻塞调用：
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223207619-1b899000-0e6e-4989-99b1-7906465c05ba.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=668&id=ue53dda1d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1336&originWidth=2320&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1003491&status=done&style=none&taskId=uc340540a-9101-4d2d-b070-8579213e891&title=&width=1160)


<a name="JY1nP"></a>
#### 2.9.3 非阻塞调用下的同步和异步：
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223224225-57fa5713-68e1-4b2b-aa2c-253304250b3a.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=670&id=u34e4073a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1340&originWidth=2498&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1394172&status=done&style=none&taskId=u5d50ab4e-b982-4007-8151-ab0a6cb8a63&title=&width=1249)<br />openResty使得我们可以通过写同步的的方法，实际上以异步的来执行。

<a name="2f81b251"></a>
### 2.10 Nginx模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665223253817-2d4e8aaf-21cb-4c8c-956e-109bf55e2266.png#clientId=u4080493f-2439-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=682&id=u8e0d1bec&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1364&originWidth=2400&originalType=binary&ratio=1&rotation=0&showTitle=false&size=951445&status=done&style=none&taskId=u1e94db26-886a-48c5-9d00-3bb89d8d66e&title=&width=1200)
<a name="3375deef"></a>
#### 2.10.1 Nginx模块分类
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665226085326-018c7e5f-e0a2-4427-af60-f7f5e61be0ce.png#clientId=ue2063783-0659-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=504&id=uceec0e31&margin=%5Bobject%20Object%5D&name=image.png&originHeight=1008&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=765616&status=done&style=none&taskId=u78964cdd-88b3-461b-bb13-9d9927ab610&title=&width=1000)
<a name="IDZTv"></a>
### 2.11 Nginx连接池

---

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665227718155-ef6275e3-8753-4908-8d4f-962d7f430298.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=671&id=u2edc5181&name=image.png&originHeight=1342&originWidth=2176&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1075974&status=done&style=none&taskId=ub9a708f6-400c-43e5-bb62-6a080795aa9&title=&width=1088)<br />**说明：**<br />每一个连接对应2个事件（读事件和写事件），如上图是通过数组序号来配合使用的。消耗的内存如下：<br />一个connection(232)+2个event(96*2) = 424字节。设置的连接数越多，消耗的内存就越大。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665227755760-90debc69-79a5-4665-baf7-473a387713f5.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=683&id=uea9eb9a4&name=image.png&originHeight=1366&originWidth=2308&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1102347&status=done&style=none&taskId=ua83ed654-a29f-483d-900a-1acfe8ebbf1&title=&width=1154)
<a name="WQomZ"></a>
### 2.12 Nginx内存池
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665227826887-5f4df0c3-5394-46dd-b74b-65771ec76f32.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=685&id=u9d682e1b&name=image.png&originHeight=1370&originWidth=2496&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1101550&status=done&style=none&taskId=u11883477-040e-4b65-934d-82d132cc825&title=&width=1248)
<a name="bJ4cY"></a>
#### 2.12.1 connection_pool_size:

- Default：connection_pool_size:256|512

内存池配置512字节，并不意味着只能分配512字节，当内存超过预分配内存大小时，是可以继续分配的。提前分配内存空间，减小分配的资源消耗。

<a name="CySFJ"></a>
#### 2.12.2 request_pool_size:

- Default：request_pool_size:4k

请求池大小，默认4K。

<a name="YtJWB"></a>
#### 2.12.3 为什么请求内存池大于远远大于连接内存池？
<br />因为连接需要存储的上下文信息很少，只需要帮助后面的请求读取最初一部分字节就行；对于请求而言，需要保存大量上下文信息，比如：url和header。其对性能的影响比较小，极端场景下，url特别长，可以修改配置，增大请求内存池预分配的空间大小；通常情况下，url和header都很小，可以考虑降低请求内存池的预分配空间大小，最大化Nginx的并发量。

内存池对减小内存碎片和第三方模块开发是很有意义的。

<a name="Hhnry"></a>
### 2.13 Nginx进程间通信方式
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228139673-77625fa5-3654-4c4e-8f7e-840fb0da3c6a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=708&id=u9c0c24c0&name=image.png&originHeight=1416&originWidth=2282&originalType=binary&ratio=1&rotation=0&showTitle=false&size=955517&status=done&style=none&taskId=u9f2d6623-bb12-468d-961b-40fee147dd2&title=&width=1141)
<a name="MzFu1"></a>
#### 2.13.1 哪些官方模块使用了共享内存呢？

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228217845-2f00291e-fb09-4e50-a39e-f3551060c9a1.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=672&id=ude87e806&name=image.png&originHeight=1344&originWidth=2074&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1368399&status=done&style=none&taskId=u21e8e61c-7f9d-4b14-a36c-889d9462d00&title=&width=1037)

- Nginx_http_lua_api是OpenResty的核心模块：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228294887-e1ea5f4b-60c5-48b2-b521-18e431b416c1.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=732&id=u894c9956&name=image.png&originHeight=1464&originWidth=2156&originalType=binary&ratio=1&rotation=0&showTitle=false&size=790151&status=done&style=none&taskId=ue8a870d8-0236-4ced-bfec-8fa5868675d&title=&width=1078)

在如上代码中，同时使用了rbtree和链表：

```bash
lua_shared_dict dogs 10m;//使用红黑树来保存每一个key-value,每一个节点是它的key,节点值就是value。
//当内存大于10m时，使用lru方式淘汰，最先设置了key-value就会被淘汰，这就说明每个key-value连在了一起形成了一张链表。
```

<a name="PidMk"></a>
#### 2.13.2 Slab内存分配管理

如何把一整块内存切割成小块分配给每个红黑树节点使用的？Slab内存管理<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228353782-85f22f0e-da64-4212-a2e9-bd99010613d0.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=714&id=uc8b61ac4&name=image.png&originHeight=1428&originWidth=2150&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1044918&status=done&style=none&taskId=ucaeb45db-00e7-45ad-9a48-9dd4e2bd3a3&title=&width=1075)

Slab会把共享内存切割很多页面（4K），每个页面被切分为不同的slot（不同的slot分配内存空间不同128|256|512,乘2方式向上增长)。

Bestfit:比如30字节的内存，会被分配到32字节的slot。

<a name="v9pmD"></a>
#### 2.13.3 查看slot使用状态
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228475821-51ecd5a8-588c-4660-ad22-d838037e8a10.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=573&id=u5a29766c&name=image.png&originHeight=1146&originWidth=2332&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1450711&status=done&style=none&taskId=u0ee5b638-8b87-4280-a9f2-2d443df5e78&title=&width=1166)
<a name="YAG60"></a>
#### 2.13.4 在OpenResty上使用tengine的slab_stat模块查看共享内存分配情况

编译安装（在编译安装OpenResty时，使用add-module把tengine的slab_stat模块安装进来）：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228543027-03460c63-0a58-4998-92e0-c3222175326f.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=64&id=ude3bca4c&name=image.png&originHeight=128&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=135877&status=done&style=none&taskId=ue255fe3b-06a6-47ba-8deb-c1591c9524f&title=&width=1000)<br />案例：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228564158-cf62e461-39dc-40f5-85bb-9ceb31c21095.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=407&id=u7aa29405&name=image.png&originHeight=814&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=858625&status=done&style=none&taskId=u81cf57fc-9196-4703-9346-d8578f1ffc3&title=&width=1000)
<a name="hyUfZ"></a>
### 2.14 Nginx数据容器
> nginx的数据容器包括：数组、链表、队列、哈希表、红黑树、基数树


<a name="nAQ5L"></a>
#### Nginx数组（nginx_array_T)：
多块连续内存，每块连续内存中可以存放许多元素。

<a name="dB7T9"></a>
#### 链表：
nginx_list_T

<a name="dcKfh"></a>
#### 队列：
nginx_queue_T

<a name="s2i1K"></a>
#### 哈希表
nginx_hash_elt_T

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228762793-1247f03f-b7fc-4ebe-bc3d-a2763cb37303.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=561&id=ud982806d&name=image.png&originHeight=1121&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=494507&status=done&style=none&taskId=ubfa06cbf-a89c-4017-9499-1e5293f1202&title=&width=1000)

哈希表每个元素占用连续的内存。value是指针，指向用户数据，len长度，name就是hash的key。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228781943-9f02918e-a93a-497f-b4a7-ce9df207c88a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=622&id=u69b922b5&name=image.png&originHeight=1244&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=934135&status=done&style=none&taskId=ue482508c-4f45-4921-96b2-176152e289e&title=&width=1000)

Hash表应用于静态不变的内容。

Max size:控制了最大的hash表Bucket的个数，并不是实际最大hash表bucket的个数。

Bucket size:每个bucket的大小，向上对齐(cache line)。比如64位操作系统,操作系统每次读取64个字节，但bucket size配置60，这个时候实际是Nginx会设置为64，与操作系统对齐。,bucket size配置尽量不要超过64字节，以免占用内存过高。

<a name="ycwJ3"></a>
#### 红黑树

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665228848048-559b9ae8-c7e2-4c07-a325-af7da0d37455.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=488&id=u424f5a62&name=image.png&originHeight=976&originWidth=1628&originalType=binary&ratio=1&rotation=0&showTitle=false&size=402749&status=done&style=none&taskId=u98adaab4-f767-41c3-81b7-1e033c68993&title=&width=814)

红黑树本身是一个二叉树，包含左节点和右节点。其次是一个查找二叉树，左节点比右节点小。可能会退化成一个链表，如右图。

- **红黑树优点：**

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229013420-19ce783a-0c16-4812-b699-b9078a36036b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=327&id=u77270f5b&name=image.png&originHeight=654&originWidth=1616&originalType=binary&ratio=1&rotation=0&showTitle=false&size=316148&status=done&style=none&taskId=u4f46f9ff-0f84-4e1f-abd9-f3a0244eb25&title=&width=808)

- **使用红黑树的模块：**

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229029948-efda261b-2f1f-4084-86b9-930a639ed7f6.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=525&id=uea89e8cc&name=image.png&originHeight=1050&originWidth=1754&originalType=binary&ratio=1&rotation=0&showTitle=false&size=754681&status=done&style=none&taskId=u31987b40-acfa-44e7-8365-91bfbc03cb6&title=&width=877)

<a name="qWyH6"></a>
### 2.15 动态模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229163186-db1a9972-7451-4c61-9efa-8d947600955a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=501&id=u3c0c5f63&name=image.png&originHeight=1002&originWidth=1788&originalType=binary&ratio=1&rotation=0&showTitle=false&size=717599&status=done&style=none&taskId=u80305238-76e0-4740-88e5-c19e21c8971&title=&width=894)

<a name="CMpFj"></a>
#### 使用案例：

(1)查看哪些模块支持动态模块：./configure —help | more<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229214507-cde85b15-ed33-4976-9d32-0e4189482ca1.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=514&id=u18c5cd47&name=image.png&originHeight=1028&originWidth=1888&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1385331&status=done&style=none&taskId=udf4300b1-f708-48c3-9dbb-ad65cd08418&title=&width=944)<br />(2)把一个模块动态编译到nginx<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229230709-f1463043-c857-482e-89e1-d856de0ee363.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=63&id=ud2f7fa36&name=image.png&originHeight=126&originWidth=1964&originalType=binary&ratio=1&rotation=0&showTitle=false&size=172028&status=done&style=none&taskId=u61e8f22b-981c-42c6-bfc7-f2c1114db89&title=&width=982)<br />(3)打开动态模块配置
```bash
load_module module/nginx_http_image_filter_module.so
image_filter resize 15 10;
```
<a name="KsIpz"></a>
### 2.16 配置指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229264191-9a58509f-8487-4635-a51f-521ede05517a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=376&id=uee91cf5d&name=image.png&originHeight=752&originWidth=1100&originalType=binary&ratio=1&rotation=0&showTitle=false&size=159617&status=done&style=none&taskId=u78b84d84-e3c1-4b17-a1ca-2e0b8be7ab8&title=&width=550)

<a name="h3TM7"></a>
#### 2.16.1 什么是指令的context?

该条配置指令能处于的配置块。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229291396-fd9c8d66-e848-4634-a950-a7d0e4235a0a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=222&id=u25364b2e&name=image.png&originHeight=444&originWidth=1096&originalType=binary&ratio=1&rotation=0&showTitle=false&size=179939&status=done&style=none&taskId=u7e31941a-0ff4-4a21-aacb-8890fff588e&title=&width=548)

上图表明：log_format能在http模块上配置；access_log能在http,server…等模块配置。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229306834-2ea65478-25c1-46f0-84f2-a2e3c7420a05.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=377&id=u8c8c9957&name=image.png&originHeight=754&originWidth=1196&originalType=binary&ratio=1&rotation=0&showTitle=false&size=247860&status=done&style=none&taskId=u1e748647-0a19-4ad9-91c1-bbf008c725e&title=&width=598)

一个配置存在多个配置块是是可以合并的。值指令可以合并；动作类指令不可以合并。判断依据：看该条配置的生效阶段。

**值指令向上覆盖：**

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229326246-82705233-3bc2-467f-a6c3-e212f4f5fbf6.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=318&id=uf58114e7&name=image.png&originHeight=636&originWidth=1260&originalType=binary&ratio=1&rotation=0&showTitle=false&size=272789&status=done&style=none&taskId=u99056e36-b4e2-448e-90f4-4ce9a6a3e4e&title=&width=630)

http模块指令合并规则：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229366500-8558e9aa-cb60-4bdf-908e-c8cc109c24cf.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=350&id=u8f6cafbb&name=image.png&originHeight=700&originWidth=1216&originalType=binary&ratio=1&rotation=0&showTitle=false&size=411683&status=done&style=none&taskId=u43941979-c6f5-4a20-a877-b55783c2e87&title=&width=608)

<a name="qMRFH"></a>
## 三、详解HTTP模块

<a name="nQyPY"></a>
### 3.1 Listen指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665229431834-bca896e4-dfbd-4e1f-9b54-79cd4181b6d9.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=341&id=u60d3528b&name=image.png&originHeight=682&originWidth=1258&originalType=binary&ratio=1&rotation=0&showTitle=false&size=331627&status=done&style=none&taskId=ua39737a0-eccc-4937-bcbd-c75c576af98&title=&width=629)
<a name="tDo46"></a>
### 3.2 接收请求的事件模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230156349-2bbff842-b3df-4838-b9d1-375d98cae351.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=367&id=u2631b7bf&name=image.png&originHeight=734&originWidth=1110&originalType=binary&ratio=1&rotation=0&showTitle=false&size=254315&status=done&style=none&taskId=ud09b442e-077a-4906-b29f-28a9c256363&title=&width=555)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230169922-d1586445-a60c-4518-b131-29573b30fef4.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=429&id=ue8b9a22d&name=image.png&originHeight=858&originWidth=1288&originalType=binary&ratio=1&rotation=0&showTitle=false&size=359041&status=done&style=none&taskId=u96d158f5-fec5-4777-883a-bca1f515af2&title=&width=644)
<a name="b4JS6"></a>
### 3.3 正则表达式：
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230187123-e833248e-fc95-45f0-b76b-e7febdd5d1a3.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=457&id=u3048b0c3&name=image.png&originHeight=914&originWidth=1596&originalType=binary&ratio=1&rotation=0&showTitle=false&size=591282&status=done&style=none&taskId=u6b333553-24df-4e0b-a727-0b69318d343&title=&width=798)
<a name="FPTsS"></a>
### 3.4 如何找到处理请求的server指令块
<a name="FHZX1"></a>
#### 3.4.1 server_name

- **指令说明：**

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230257672-c0d46967-282d-444e-be13-f758be7a1c33.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=294&id=udc7c42de&name=image.png&originHeight=588&originWidth=1470&originalType=binary&ratio=1&rotation=0&showTitle=false&size=360435&status=done&style=none&taskId=ue986cc63-96c9-412a-aa8c-1da2dbca5ee&title=&width=735)

- **server_name多域名：**

例如：
```bash
server{
		server_name [aa.com](http://aa.com) [bb.com](http://bb.com); #其中aa.com是主域名
		server_name_in_redirect off;
		redirect 302 /redirect;
}
```

如上配置：如果访问bb.com，会直接跳转到bb.com/redirect

如果配置：

```bash
server{
		server_name [aa.com](http://aa.com) [bb.com](http://bb.com); #其中aa.com是主域名
		server_name_in_redirect on;
		redirect 302 /redirect;
}
```

如上配置：如果访问bb.com,会302到aa.com/redirect

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230375274-3de68de4-e87a-4238-9504-d5cb76a75e90.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=336&id=u664220b3&name=image.png&originHeight=672&originWidth=1188&originalType=binary&ratio=1&rotation=0&showTitle=false&size=252630&status=done&style=none&taskId=ufeb6c9a2-ac40-408c-855d-eadf5102871&title=&width=594)

- **server_name匹配顺序：**

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230389246-a3650733-e37e-4c76-966b-f766770629bb.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=342&id=u326a1985&name=image.png&originHeight=684&originWidth=1368&originalType=binary&ratio=1&rotation=0&showTitle=false&size=294236&status=done&style=none&taskId=u69a336b2-991c-4586-9de7-570c4b8bd77&title=&width=684)
<a name="HUAit"></a>
### 3.5 HTTP请求11个阶段
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230458893-25f867f1-42d3-4b9b-a56f-580f39282802.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=406&id=u879fb4f5&name=image.png&originHeight=812&originWidth=1508&originalType=binary&ratio=1&rotation=0&showTitle=false&size=737786&status=done&style=none&taskId=u4a242e0a-2559-4462-b6b0-6bf1c39eb18&title=&width=754)

HTTP请求11个阶段的执行顺序：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230473444-5c196ac8-a66a-4a54-84e7-b9f109f85e1a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=462&id=u9cbdca7a&name=image.png&originHeight=924&originWidth=1630&originalType=binary&ratio=1&rotation=0&showTitle=false&size=768474&status=done&style=none&taskId=u52131a98-430b-446e-8612-bf69ae0e359&title=&width=815)<br />上图说明：

（1）每一个阶段会有多个模块得到执行。

（2）limit_req和limit_conn都在preaccess阶段得到执行，但是如果limit_req阻止了本次请求，就会直接返回，limit_conn就得不到执行。

（3）access阶段的access执行通过后，后续auth_basic和auth_request两个阶段不会执行，直接跳到precontent阶段，同理content阶段也是如此。

<a name="lsIDY"></a>
#### 3.5.1  postread阶段

（1）realip模块

**把realip模块编译进Nginx模块？**

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230506252-3a4a4834-dd9e-457d-b452-9f7b0e98ef94.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=553&id=u5f6c7c8e&name=image.png&originHeight=1106&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=423093&status=done&style=none&taskId=u8e4b619c-ab2c-47c8-aa43-f97e9562e1a&title=&width=1000)

三个指令：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230523777-f9f99238-96e7-4a6a-87de-1ef37587cd25.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=498&id=uc4bf0684&name=image.png&originHeight=996&originWidth=1854&originalType=binary&ratio=1&rotation=0&showTitle=false&size=435413&status=done&style=none&taskId=ue7fb1ceb-2065-4487-84e8-515a1db14ae&title=&width=927)

set_real_ip_from：设置可信赖的ip(如本机IP或者机器某台机器IP)，找到用户真实ip

real_ip_header:ip值从哪个参数中取（X-Real_Ip |X-Forwarded-For）

real_ip_recursive:环回地址，取 X-Forwarded-For最后一个地址如果和客户端地址一样就pass掉，取上一个地址。

(2)**如何拿到真实的用户IP地址？**<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230544443-a4b00b74-348a-4bd3-8d1f-53a91140ced4.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=544&id=u7970d253&name=image.png&originHeight=1087&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=903740&status=done&style=none&taskId=u5718688a-f81c-4113-9814-2a86008f775&title=&width=1000)<br />说明：当网络请求过程中，存在很多反向代理服务器时，Nginx会把用户真实的ip写在X-Real_IP中，而每经过一层反向代理，会吧上一层IP追加在X-Forwarded-For中。

**拿到真实用户IP后如何使用？**<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665230559756-62ffa23e-13cc-4ad0-9d90-7ea0bcc463df.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=524&id=ud0ee02dd&name=image.png&originHeight=1048&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=517782&status=done&style=none&taskId=u054b91ef-a484-4ea6-9981-e02a5873a80&title=&width=960)

<a name="CcGUx"></a>
#### 3.5.2  rewrite阶段

（1）rewrite模块return指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231365595-24393a63-b9af-4899-bf29-b5832dde15b0.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=563&id=u03e7dea9&name=image.png&originHeight=1125&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=850117&status=done&style=none&taskId=ue6c09676-a7b2-47cd-95d9-130de3836b9&title=&width=1000)

error_page:收到某个特定的返回码时，重定向某个url或者给用户返回特定内容。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231384237-c528ce8c-5200-4f76-8b10-16d89912ec44.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=568&id=u677b141e&name=image.png&originHeight=1136&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=875922&status=done&style=none&taskId=ud6c88c3d-4730-44d9-ad32-ba7bcf29218&title=&width=1000)

return示例：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231392156-e920aeb9-3476-4504-902d-ad77dde94c8e.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=565&id=ue304df7f&name=image.png&originHeight=1129&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=632983&status=done&style=none&taskId=u25356a70-a042-499d-817e-1731ca03b4d&title=&width=1000)

server与location块下的return指令关系？

server块的return先于location块的return执行。

return与error_page指令的关系？

访问不存在的资源，执行error_page指令；如果执行了return指令，error_page得不到执行。

(2) rewrite指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231436098-8366e522-24a8-4d4e-8a0e-11c255950389.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=574&id=u65c9d118&name=image.png&originHeight=1147&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1201552&status=done&style=none&taskId=ua8f63ce2-765f-495d-89ae-0a2a4643395&title=&width=1000)

案例：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231442706-7c339ba8-6f70-4640-8790-8fe892552514.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=547&id=ua26ce834&name=image.png&originHeight=1094&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=911220&status=done&style=none&taskId=u2eb80dc7-ae7e-4e5c-844e-e4b231297ea&title=&width=1000)

问题1：rewrite指令优先级高于return

问题2：依次返回“test3”、“test3”、”third!”

问题3：不携带break，就往下执行到return 200 ‘second’模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231446222-14254966-4ad4-4535-9e34-a181ad4249b1.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=547&id=ueced671f&name=image.png&originHeight=1094&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=911220&status=done&style=none&taskId=u08de7b45-4a12-4a1d-b417-4eb4749d228&title=&width=1000)

问题：依次返回301、302、302、301

**rewrite日志记录：rewrite_log:on就可以开启了**

（3）if指令<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231466908-3bb2a133-1c4b-4343-a127-13efb9bc0ebd.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=507&id=u051c78d1&name=image.png&originHeight=1014&originWidth=1114&originalType=binary&ratio=1&rotation=0&showTitle=false&size=422316&status=done&style=none&taskId=u1d843cd1-382a-4096-be7f-edafcb750db&title=&width=557)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231482042-8b1086e5-2b86-4abc-89c0-1e7e07fd957b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=608&id=u934d6173&name=image.png&originHeight=1216&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1286703&status=done&style=none&taskId=uc117ff10-f4ae-4614-a072-c10796c74a8&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231493196-ff5c9144-0f60-453f-8ac6-59b82ef49a9f.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=698&id=u2c08d0a4&name=image.png&originHeight=1396&originWidth=1168&originalType=binary&ratio=1&rotation=0&showTitle=false&size=464992&status=done&style=none&taskId=u65c1adeb-90a3-4802-8998-0452f04ada0&title=&width=584)

<a name="kW14j"></a>
#### 3.5.3 find_config阶段

（1）location指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231522352-1a81367a-14dd-4189-a650-5e16c51f2491.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=549&id=u0e87eeac&name=image.png&originHeight=1098&originWidth=1694&originalType=binary&ratio=1&rotation=0&showTitle=false&size=501788&status=done&style=none&taskId=u6af0a4ae-0740-4313-93af-ab9c0df06b2&title=&width=847)

匹配规则：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231541340-d791b0cf-637c-4583-a368-80da29be4d9f.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=520&id=u0041b8c9&name=image.png&originHeight=1040&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=915541&status=done&style=none&taskId=u8f98686e-03ed-41d6-9e6c-5c4424d3265&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231553059-78281c56-8829-470b-aad2-b4219de09cad.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=615&id=u18e4d689&name=image.png&originHeight=1229&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=956388&status=done&style=none&taskId=ua590ff09-d068-4b56-927c-2b313c11c0b&title=&width=1000)

匹配结果：

/Test1:5,6;

/Test1/:1,3,5;

/Test1/Test2:2,4,5

/Test1/Test2/:4,5

/test1/Test2：2

匹配顺序

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231565343-97e59946-9e9d-4c2d-8e59-734c05648b7a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=566&id=ue1d3f4b7&name=image.png&originHeight=1131&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=796195&status=done&style=none&taskId=ud5fa3d90-b8b3-47eb-8324-c87d22814b0&title=&width=1000)

同上问题，返回什么？

/Test1:exact match!

/Test1/:stop regular expressions match!

/Test1/Test2:lonest regular expressions match!

/Test1/Test2/:lonest regular expressions match!

/test1/Test2:lonest regular expressions match!

<a name="nuOm6"></a>
#### 3.5.4 preaccess阶段

(1)limit_conn指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231597180-ad7edaa9-5d65-4628-8d7d-5d56efe29596.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=579&id=u625a8abf&name=image.png&originHeight=1158&originWidth=1912&originalType=binary&ratio=1&rotation=0&showTitle=false&size=570136&status=done&style=none&taskId=u7406ec1f-6285-4ee3-845f-cc6360a4eed&title=&width=956)

key一般为用户的IP地址(remote_addr变量)。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231625130-cf27bf5b-de04-47f5-a2dd-8c48323326d1.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=548&id=u4525afc5&name=image.png&originHeight=1096&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=871314&status=done&style=none&taskId=ub52a45e7-9e7c-42c1-8614-ddfedc04483&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231632681-5b2f0fd5-6185-4633-ae95-d26547ad4f2c.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=435&id=ua2ac8768&name=image.png&originHeight=870&originWidth=1638&originalType=binary&ratio=1&rotation=0&showTitle=false&size=546483&status=done&style=none&taskId=u3996b678-c8e5-495f-a18f-7f7f4090905&title=&width=819)

$binary_remote_addr 关键字，这里是限制同一客户端ip地址；

限制连接数:

要限制连接，必须先有一个容器对连接进行计数，在http段加入如下代码：

"zone=" 给它一个名字，可以随便叫，这个名字要跟下面的 limit_conn 一致

$binary_remote_addr = 用二进制来储存客户端的地址，1m 可以储存 32000 个并发会话

上图配置说明：现在某个ip的并发数为1，超过1就返回500，记warn级别日志，网站返回速率为50字节/s

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231651267-60e53a5a-934f-4a48-aaba-5f0e0ef4d7fb.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=613&id=u5be874aa&name=image.png&originHeight=1226&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1109279&status=done&style=none&taskId=u15dc7206-fff2-486e-8472-a2186832dd0&title=&width=1000)

(1)limit_req指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231664147-91e94140-068f-4a9e-88f3-e3c87b0018a6.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=560&id=u83651af5&name=image.png&originHeight=1119&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=843707&status=done&style=none&taskId=ub19cd38d-7b14-4753-9dc6-64cb924c181&title=&width=1000)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231710319-039f9d22-f789-44ec-b5d6-4077764eaa3b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=547&id=ubf3435cd&name=image.png&originHeight=1094&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=821706&status=done&style=none&taskId=u786294a9-5a31-469a-8401-d73f8b9a5d0&title=&width=1000)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231741416-298db053-10ef-4501-aa45-5a9caa4f8eea.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=618&id=ufa0da0da&name=image.png&originHeight=1236&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1202082&status=done&style=none&taskId=ufafcfe6b-3687-4fc5-bb15-600839d84a9&title=&width=1000)<br />leaky bucket算法：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231751573-c95295f8-0869-462d-b286-1c02d2576d0c.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=622&id=ua2cf5ebd&name=image.png&originHeight=1244&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1027694&status=done&style=none&taskId=ua53f1eae-235c-486c-a5f7-4170ee532dc&title=&width=1000)
```bash
limit_req_zone:$binary_remote_addr zone=one:10m rate=2r/m;
location / {
	limit_req zone=one burst=3 nodely;
}
```

**第一段配置参数：**

- $binary_remote_addr ：表示通过remote_addr这个标识来做限制，“binary_”的目的是缩写内存占用量，是限制同一客户端ip地
- zone=one:10m：表示生成一个大小为10M，名字为one的内存区域，用来存储访问的频次信息
- rate=2r/s：表示允许相同标识的客户端的**访问频次**，这里限制的是每秒1次，即每秒只处理一个请求，还可以有比如**30r/m的，即限制每2秒访问一次，即每2秒才处理一个请求。**

**第二段配置参数：**

- zone=one ：设置使用哪个配置区域来做限制，与上面limit_req_zone 里的name对应
- burst=5：重点说明一下这个配置，burst爆发的意思，这个配置的意思是设置一个大小为5的缓冲区当有大量请求（爆发）过来时，超过了**访问频次**限制的**请求可以先放到这个缓冲区内等待，但是这个等待区里的位置只有5个**，超过的请求会直接报503的错误然后返回。
- nodelay：
- **如果设置，会在瞬时提供处理(burst + rate)个请求的能力**，请求超过**（burst + rate）**的时候就会直接返回503，永**远不存在请求需要等待的情况**。（这里的rate的单位是：r/s）
- 如果没有设置，则所有请求会依次等待排队

`说明：limit_conn模块优先级大于limit_req。`

<a name="Hiqwy"></a>
#### 3.5.5 access阶段

- access模块（对用户ip校验）

判断请求是否可以继续向下访问。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231786919-74bc58a5-7a07-4889-bb16-c696ed6f2d6e.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=465&id=uba7ef204&name=image.png&originHeight=929&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=664114&status=done&style=none&taskId=uc288fa91-bc30-4885-ab44-89e2e824105&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231801011-49f5e57d-5546-4d55-a15c-f17d0d662a06.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=529&id=uc80d0c86&name=image.png&originHeight=1057&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=798328&status=done&style=none&taskId=ufee97673-5152-4fec-a458-e8f147a6c19&title=&width=1000)

- auth_basic模块（对用户用户名+密码验证）

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231820167-d50c19a6-a7a4-40d6-908c-0995fa112b39.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=494&id=ubba0e2bf&name=image.png&originHeight=987&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=721550&status=done&style=none&taskId=u6acd9dc6-3a29-4cf4-9cd9-45ab98be93c&title=&width=1000)

示例：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231832650-a0dba16d-15c9-4581-bf45-805b1649be4b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=591&id=udcf6d75c&name=image.png&originHeight=1182&originWidth=1812&originalType=binary&ratio=1&rotation=0&showTitle=false&size=735292&status=done&style=none&taskId=u0049f518-ee27-462d-b7af-fb0883b428f&title=&width=906)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231860738-c7bc6333-a301-4b50-8eaf-a1e35133ecad.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=153&id=u69087c9b&name=image.png&originHeight=306&originWidth=1066&originalType=binary&ratio=1&rotation=0&showTitle=false&size=115553&status=done&style=none&taskId=ue3758239-158e-4973-b6cd-5b3c967819d&title=&width=533)

- auth_request模块（用于做统一用户鉴权系统）

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231885087-216d5402-2ee9-4031-a933-5b5f152f199c.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=564&id=udf09e18e&name=image.png&originHeight=1128&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1254786&status=done&style=none&taskId=ube30fe00-6d12-464d-a061-b80e89fb61a&title=&width=1000)

- satisfy指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231896519-000d276d-b17f-4fdf-8ee1-4569a39db73a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=518&id=u1b76a237&name=image.png&originHeight=1036&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=967687&status=done&style=none&taskId=u3a198d0c-b7b6-4c00-8ccc-b2728f39b3f&title=&width=1000)

satisfy all：access的3和指令均放行这个请求，这个请求才向下执行，任何一个拒绝，400或500返回。

```
   anny:access的3和指令有一个指令放行这个请求，这个请求就向下执行。
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231908475-3e20d39f-09af-4e4b-94be-2a4a83b46fe6.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=468&id=u9357e9ab&name=image.png&originHeight=935&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=811843&status=done&style=none&taskId=u5a6e82aa-5d45-4b00-ba3a-7277c68652d&title=&width=1000)

1. 不会。
2. 有影响。
3. 可以
4. 可以
5. 没有机会输入

<a name="UPf2u"></a>
#### 3.5.6 precontent阶段

- try_file指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231923680-66a2b0a6-6755-45cf-8bde-93979ee4b938.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=543&id=u7dd3f21d&name=image.png&originHeight=1085&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=987520&status=done&style=none&taskId=u3c28e7c6-85d5-4561-9feb-ac1e825432d&title=&width=1000)

- mirror模块（做流量拷贝）

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231941361-d9dddfb3-3371-408c-96cf-e3836c094a13.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=583&id=u7ae99bb7&name=image.png&originHeight=1166&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1155933&status=done&style=none&taskId=u6a33cf06-664f-43ff-81c1-d2ab86bf79b&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231949574-1e0edc0d-a145-4d9c-9c79-59c52c0cde14.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=449&id=u861fac84&name=image.png&originHeight=898&originWidth=1856&originalType=binary&ratio=1&rotation=0&showTitle=false&size=527046&status=done&style=none&taskId=u2fc95a1d-50ac-440f-8e19-f632ea4f9da&title=&width=928)

<a name="On4Ov"></a>
#### 3.5.7 content阶段

- static模块

（1）root和alias指令<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231971036-cd4dcaa5-ac0a-4774-abac-8d646327c35d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=516&id=u01386fe9&name=image.png&originHeight=1032&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=864611&status=done&style=none&taskId=u05b09f18-67ef-475d-b9c6-36b83b26fc0&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665231980888-c50dd8d9-8477-4af8-bb3e-1fcccc457a09.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=588&id=ue91acd34&name=image.png&originHeight=1175&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=790478&status=done&style=none&taskId=u4a1e467f-9607-4ea3-8855-d0a6ce8c454&title=&width=1000)

/root :404

/root/1.txt :—>html/first/root/1.txt 也是404

/alias:—>html/index.html 200

/alias/1.txt:—>html/first/1.txt 200

（2）3个nginx变量<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232000353-5012cae1-037c-4c44-a7e4-d596b6e610c0.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=588&id=u92a20006&name=image.png&originHeight=1175&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=790478&status=done&style=none&taskId=udde3ae68-952f-41fc-94c5-017ae30dfad&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232007085-a3d57e7e-b69a-4a8f-8d51-221bd533e7a3.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=630&id=u72853d54&name=image.png&originHeight=1260&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=982481&status=done&style=none&taskId=u8ebc6e7b-7916-4dc5-8b19-fc4e3ac13b3&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232016050-423ad00a-bd85-4e2f-bbf5-e870e39459f4.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=446&id=u8def6da4&name=image.png&originHeight=892&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=588027&status=done&style=none&taskId=ucec5ef2f-a1bf-4722-8c79-fce56bfb6d8&title=&width=1000)<br />（3）static模块对url不以斜杠结尾却访问目录的的做法<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232030859-e9b6b9ce-5305-4352-b04c-cab257bda536.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=535&id=u3312fb28&name=image.png&originHeight=1069&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=572179&status=done&style=none&taskId=u7221efc3-10f2-4328-865e-fe5dd8df07f&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232045165-211098f5-1a36-4787-8a76-946b3250098d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=621&id=u10c2898e&name=image.png&originHeight=1242&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=974692&status=done&style=none&taskId=uef25806f-01c1-4963-ad53-887f1f1efb2&title=&width=1000)

- index模块和autoindex模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232217205-bdae8c72-1d09-4994-96d1-f110fedb3d5d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=605&id=u7579471a&name=image.png&originHeight=1209&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=909556&status=done&style=none&taskId=udb2468cf-0f45-4e37-b5bb-e61e8742bdf&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232228724-1fabacaa-675a-4f9b-9f9a-97215e071128.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=552&id=ufc4c2f9e&name=image.png&originHeight=1103&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=941494&status=done&style=none&taskId=ua9aae574-645f-4146-b63f-4c8a415e54b&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232238300-31ad03eb-6527-4714-bf73-4a5805ea8ba5.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=589&id=u6837a028&name=image.png&originHeight=1178&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=953426&status=done&style=none&taskId=ufb5d74d7-8cca-4ab3-9029-33497d22d2c&title=&width=1000)

- concat模块（合并小文件，提升网络性能）

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232256885-d7dbf9b8-1b75-4fe2-b82c-ae0fa27fe2bc.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=604&id=ue429a9fa&name=image.png&originHeight=1207&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1434476&status=done&style=none&taskId=ud9c90584-432c-4b94-be91-daf13adde1a&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232266110-1c881c6a-4cd6-4be2-bff5-d130f21c2a05.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=604&id=u875b33ec&name=image.png&originHeight=1207&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1434476&status=done&style=none&taskId=u9494f8a0-9886-4f78-a059-2178a187a0a&title=&width=1000)

<a name="JUn4A"></a>
#### 3.5.8 log阶段

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232282806-69c073ce-0b10-42bf-8589-06ba6899e688.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=451&id=ue6cdf38e&name=image.png&originHeight=902&originWidth=1762&originalType=binary&ratio=1&rotation=0&showTitle=false&size=479998&status=done&style=none&taskId=uc6eb4304-9e23-41d7-a79f-3242cf308c5&title=&width=881)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232295089-cbe73cdb-21a9-43f6-9b91-f892500daae3.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=533&id=u8f306427&name=image.png&originHeight=1065&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=807256&status=done&style=none&taskId=ua102ac8e-6ab7-4601-bb0e-2703a8cc42a&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232310247-abc12cab-689c-4c5b-8a03-368e90779535.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=594&id=u040684ca&name=image.png&originHeight=1188&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1477564&status=done&style=none&taskId=ub2126f58-18fd-4f18-9c1b-559b522aaf7&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232319571-2f9fab54-3a96-442f-8058-07c241c61bc3.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=572&id=u10a0877d&name=image.png&originHeight=1144&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1549000&status=done&style=none&taskId=u774257d4-1dd2-4a27-a03a-418427618fa&title=&width=1000)

<a name="k1wFV"></a>
#### 3.5.9 HTTP过滤模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232342034-f79ff12f-330c-41a4-9cf7-e085726f86dc.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=581&id=uea7631bb&name=image.png&originHeight=1162&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1335758&status=done&style=none&taskId=uded6b676-3bc3-4291-b8c3-6c250dd3cbf&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232352016-91f5a228-4998-49bc-9428-5286dbbf962b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=581&id=u3db5af7d&name=image.png&originHeight=1162&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1335758&status=done&style=none&taskId=u6fe70edc-9dd3-468c-a44c-ff88357be24&title=&width=1000)

- sub模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232366172-b6750dc4-4850-4b98-a130-cdf70952c6ad.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=568&id=u919d5f1a&name=image.png&originHeight=1135&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=902270&status=done&style=none&taskId=u495ef623-63f8-42f1-be35-2793a4d1771&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232388237-abe5c404-3008-487a-8c4c-74626ca5d26b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=639&id=QI6ms&name=image.png&originHeight=1278&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=941415&status=done&style=none&taskId=ucbf2fb25-f810-4bf1-889e-751cbb9275d&title=&width=1000)

示例：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232372978-9fae4e7a-711e-48d2-a6a1-3bd73a245ea3.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=357&id=ZnMqv&name=image.png&originHeight=714&originWidth=1714&originalType=binary&ratio=1&rotation=0&showTitle=false&size=459131&status=done&style=none&taskId=ueb77a283-0dfe-4ecb-b8ec-7473bd0cdb7&title=&width=857)

- addition模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232438634-98af98c7-01da-4158-bfa4-17266bc21f43.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=476&id=u8a781586&name=image.png&originHeight=952&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=759401&status=done&style=none&taskId=u876d46c7-3cca-4168-a156-93162aa6c60&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232447907-21d896a0-8479-4a72-a372-33a8468fe757.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=476&id=ud4b7c3ce&name=image.png&originHeight=952&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=759401&status=done&style=none&taskId=u575592f5-c841-4fa1-bfd4-50a1f5b1f41&title=&width=1000)

<a name="jR86D"></a>
### 3.6 HTTP的变量

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232587145-0e18d74b-b598-4365-9931-6dafc3b265f3.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=570&id=u0b3676f1&name=image.png&originHeight=1139&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=835207&status=done&style=none&taskId=u554d3bf2-07e9-4da3-a7ea-f66e587aa9d&title=&width=1000)

<a name="Y4cqb"></a>
#### 3.6.1 HTTP请求相关变量

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232603238-b5ce5616-95ef-40c1-91c1-8cd23b2134fa.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=443&id=u4529375c&name=image.png&originHeight=886&originWidth=1922&originalType=binary&ratio=1&rotation=0&showTitle=false&size=882102&status=done&style=none&taskId=ua435cd92-59f8-4ddf-9b0a-c3655115500&title=&width=961)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232612307-bfddd606-2996-4ed2-a3e9-04188aafe69a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=550&id=u54a0c618&name=image.png&originHeight=1100&originWidth=1950&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1092277&status=done&style=none&taskId=uabd2edd1-7fed-436f-9f58-152f0d24d01&title=&width=975)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232620175-1e56a846-0c8c-4932-b02c-95e202b09038.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=470&id=u2d1aa0b5&name=image.png&originHeight=940&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1028310&status=done&style=none&taskId=u2ac8a627-4e67-4b03-9048-3b240a76efc&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232638109-3a52eaa3-bef6-4ceb-88cf-58e0fa4f85c8.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=358&id=ua7b53c66&name=image.png&originHeight=715&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=668558&status=done&style=none&taskId=u7db7d0b1-383f-4e86-a9af-7b4bc69ae39&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232647856-cf29fb5a-f672-4a72-ace2-1b41911080fc.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=508&id=u878db115&name=image.png&originHeight=1016&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=551880&status=done&style=none&taskId=u42990468-352a-4910-a7b2-4a1dd740659&title=&width=1000)

<a name="Qtv9n"></a>
#### 3.6.2 TCP连接相关的变量

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232663981-a8ec16a6-36b6-4e1a-8375-89819ef789c3.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=408&id=u75b67dc6&name=image.png&originHeight=816&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=763138&status=done&style=none&taskId=ue842783c-fbcb-4fcd-89f5-328d21d3604&title=&width=1000)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665232687241-cc2fe0d5-4d94-4a25-90b1-c3a38174b56d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=424&id=u5ee7cc2f&name=image.png&originHeight=847&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=653340&status=done&style=none&taskId=ue9c85e44-c36f-4d57-bb7c-995bdea7380&title=&width=1000)
<a name="dmAep"></a>
#### 3.6.3 请求中产生的变量

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234252362-90d08f96-959a-463b-9a4d-4c3b7c64c9df.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=607&id=uee0221c6&name=image.png&originHeight=1214&originWidth=1960&originalType=binary&ratio=1&rotation=0&showTitle=false&size=944171&status=done&style=none&taskId=u7455b29a-4248-40b8-a53c-3a45f1e624f&title=&width=980)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234262239-114f8a8f-100f-4237-b91e-4ff31253a341.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=538&id=u695b6f28&name=image.png&originHeight=1076&originWidth=1974&originalType=binary&ratio=1&rotation=0&showTitle=false&size=870930&status=done&style=none&taskId=uf46b641b-5a97-4e2d-a75c-de6411db89e&title=&width=987)

<a name="y5uhi"></a>
#### 3.6.4 方式HTTP响应时相关的变量

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234278777-56d66f15-c583-4ae8-b2b4-c0f171f88c49.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=472&id=u94f39b43&name=image.png&originHeight=944&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=903329&status=done&style=none&taskId=u34171cb6-f393-45c4-ae38-f8d1394e732&title=&width=1000)
<a name="IWBbY"></a>
#### 3.6.5 系统变量

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234287936-b599e0c6-b042-43e9-abbf-a711939b1ecf.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=472&id=u85eecda5&name=image.png&originHeight=944&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=903329&status=done&style=none&taskId=u7de98b57-1903-4318-981c-e813242074c&title=&width=1000)

<a name="tm9S1"></a>
### 3.7 referer模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234382560-f80db22f-1857-4212-a6fd-333b818bce3e.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=587&id=uce5f87cd&name=image.png&originHeight=1173&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1177532&status=done&style=none&taskId=u428d9e1f-cda3-408e-81e8-e7a7b653168&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234395805-9bc3858d-36d3-4f93-a713-e2fd9f347df4.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=640&id=u7f1744c6&name=image.png&originHeight=1280&originWidth=1792&originalType=binary&ratio=1&rotation=0&showTitle=false&size=605681&status=done&style=none&taskId=u76251b68-6a8b-45cc-9fce-44d9e500c52&title=&width=896)

<a name="KyEfu"></a>
#### valid_referers指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234411289-b089513b-2d68-4a5a-a093-c82e3988458e.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=603&id=u3689a3a7&name=image.png&originHeight=1206&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1319253&status=done&style=none&taskId=u36888645-f75b-464f-8bfc-5d2cc487b88&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234442563-180a5f98-e516-4ae3-b3c1-43eea5c61cb7.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=502&id=u3439c375&name=image.png&originHeight=1004&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=848354&status=done&style=none&taskId=ud6e3aff6-34ff-4467-818e-8478ff7d0a8&title=&width=1000)

结果：403，valid，valid，valid,403,valid,403,valid

<a name="Y5QHA"></a>
### 3.8 map模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234460506-56c3fffb-4c73-4e01-ad70-ab7a000cb6d9.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=547&id=ub244ebdd&name=image.png&originHeight=1094&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1086250&status=done&style=none&taskId=ue5f6e2f6-747c-47c1-8b44-3a2dfdfbaf0&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234505918-96a89c75-1130-4ab7-867c-2de353080393.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=605&id=u95d61598&name=image.png&originHeight=1210&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=851265&status=done&style=none&taskId=ub26f07f1-f8a7-4169-a519-5613b9d58a4&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234521486-095ac71e-24d7-4b38-b95c-c328244ed6d2.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=485&id=u6952d7d8&name=image.png&originHeight=970&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1202774&status=done&style=none&taskId=u030e684f-7e82-4e92-be4c-3fe66be4567&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234485870-251b9293-cbaa-456f-a81f-660b1e00ae08.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=577&id=u0f02affe&name=image.png&originHeight=1154&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=955572&status=done&style=none&taskId=u2b7aaae9-e428-4dba-b984-8b9a5c4856d&title=&width=1000)

<a name="KxyWz"></a>
### 3.9 split_clients模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234563957-58515e73-82c0-4bbe-a81e-f0debafde3b4.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=565&id=u615c7dd7&name=image.png&originHeight=1130&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1837204&status=done&style=none&taskId=u531f8023-8155-4bd6-949c-7f2cb98ba8f&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234573636-2e5d2dfb-53db-4f88-ae3c-f6d72af3fbe9.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=665&id=ud4c8b967&name=image.png&originHeight=1330&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=842299&status=done&style=none&taskId=ue3a87d8b-0932-4c1f-9d56-df2d9dd8d52&title=&width=1000)

<a name="PbEL0"></a>
### 3.10 geo模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234586335-174ce934-fa9d-45fd-b077-e9f578e634d2.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=523&id=ue0315b48&name=image.png&originHeight=1045&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=927668&status=done&style=none&taskId=udaa322a9-1e7f-491f-b216-8d35fb79233&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234598247-e4ef8f29-9998-4078-9ca9-4d6592a6779e.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=598&id=u6896706f&name=image.png&originHeight=1196&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1353502&status=done&style=none&taskId=u9eecbe76-5327-4bf2-b220-209db08d881&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234607079-f3590fbc-6312-46ea-904b-c4438e602ee0.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=541&id=u48cd657e&name=image.png&originHeight=1081&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1085681&status=done&style=none&taskId=u7450160d-a54b-490f-8ff5-963e771cf65&title=&width=1000)

<a name="kdTyp"></a>
### 3.11 geoip模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234623731-e8ffbe23-74b1-4c5b-afd2-4ae206339e8d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=540&id=u9bf26c7f&name=image.png&originHeight=1080&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1307407&status=done&style=none&taskId=u159367ae-38a4-43d5-84f7-645defa3a72&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234647385-50fca371-010e-4f08-8ee2-b0e6755d46c3.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=479&id=u8f7fbe16&name=image.png&originHeight=957&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=862408&status=done&style=none&taskId=u3193962a-8bd0-4b10-96b4-da1f221eef0&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234667789-4fdc0fd9-f1bc-4183-a8f1-45c2a708e2e3.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=521&id=uf7ac2c4a&name=image.png&originHeight=1042&originWidth=1912&originalType=binary&ratio=1&rotation=0&showTitle=false&size=415251&status=done&style=none&taskId=u19240b9d-ecaf-43ee-b355-43a86eff5ef&title=&width=956)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234683166-a569bc2f-3549-47bf-8ba0-8a5ef42d5203.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=632&id=ucfc95c0b&name=image.png&originHeight=1264&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1601928&status=done&style=none&taskId=uda034e54-ecd3-4c6e-a13a-c50fa3360af&title=&width=1000)

3.12 keepalive

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234694434-292a83bf-b929-4076-bb62-8aaec14215e9.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=502&id=u11941dd2&name=image.png&originHeight=1003&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1082983&status=done&style=none&taskId=u046496e3-d5e8-417c-9351-d91708e3a80&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234702932-53baded1-62fb-4c81-9ac1-450939747fdf.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=585&id=uae48e6e4&name=image.png&originHeight=1170&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1112462&status=done&style=none&taskId=u605eb330-29d7-492e-8efb-3b85a574e92&title=&width=1000)

---

<a name="kfoKn"></a>
## 四、反向代理和负载均衡

<a name="ixh03"></a>
### 4.1 基本介绍

<a name="F4K5F"></a>
#### 4.1.1 负载均衡

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234755948-01cde64d-9886-4173-a71c-ccd4dee141b0.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=577&id=u209c2cb2&name=image.png&originHeight=1154&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=882399&status=done&style=none&taskId=u3f4d2567-d667-4563-9585-0ff1eb81006&title=&width=1000)

一个服务的扩展方向：

A:水平扩展，加机器；

B:纵向扩展：把业务复杂的服务，拆分为业务小的服务，上层nginx通过location把请求分发到不同的服务中去；

C:Z轴扩展：基于用户的信息进行扩展。例如根据请求ip或者其他信息，把请求分发到特定的服务中去；

<a name="W3DQY"></a>
#### 4.1.2 反向代理

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234770375-e26617ec-71d9-4a83-9de3-e53d74f2c86e.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=612&id=u1e3087f0&name=image.png&originHeight=1224&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=596544&status=done&style=none&taskId=u2a0cf7e6-1486-4833-a29b-602acf2bcc3&title=&width=1000)

<a name="rLJVn"></a>
#### 4.1.3 缓存

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234782199-03e4344f-e83f-40c9-a4ce-428d16895b0b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=564&id=u6c2abacc&name=image.png&originHeight=1127&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1304508&status=done&style=none&taskId=u051f3fbe-983f-4a74-9161-a95fdcdd80a&title=&width=1000)

时间缓存：Nginx从下游服务拿到信息后，一边发给客户端，一边把返回内容缓存在nginx中；

空间缓存：上游服务请求nginx，nginx可以预请求下游服务，把数据缓存到nginx中；

<a name="rvNmQ"></a>
### 4.2 负载均衡策略

<a name="Dw9oR"></a>
#### 4.2.1 upstream与server指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234817869-d11664be-eab0-48de-8d7e-0d257676c0db.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=542&id=u55557710&name=image.png&originHeight=1083&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=759151&status=done&style=none&taskId=ue2baa07b-8bf2-4f8b-8a6a-9bf740d4916&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234829958-0a6392ef-ab7b-4205-a4a1-e1c5da2fce9a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=510&id=u35a8f712&name=image.png&originHeight=1019&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1050736&status=done&style=none&taskId=u24376768-5878-4cb5-9b1c-95a620ad602&title=&width=1000)

- **加权Round-Robin负载均衡算法：**

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234844047-30854938-22d4-4955-a0ae-f62ed8454c3b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=552&id=uc7290882&name=image.png&originHeight=1103&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1088642&status=done&style=none&taskId=ud77e6a23-2ba5-4203-b502-52ce0c32239&title=&width=1000)

- **对下游服务使用keepalive长链接：**

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234867021-5fec3ffa-db29-4eec-b7f8-f999a0415e51.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=471&id=ud1f73d9e&name=image.png&originHeight=941&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=742216&status=done&style=none&taskId=u3acdd1f9-9996-4b7c-b601-9db8ddbe33f&title=&width=1000)


- upstream_keepalive指令：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234884096-5d2da795-92aa-43cb-9d84-02e20b9c7b16.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=615&id=u3980cb74&name=image.png&originHeight=1229&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=934790&status=done&style=none&taskId=ua8cb431e-d58c-48f7-9592-0ba8839ed30&title=&width=1000)

keepalive:nginx和下游服务最多保持多少个空闲的http连接

keepalive_request:一个tcp最多跑多少个请求

keepalive_timeout:一个tcp连接空闲多少秒后关闭

- resolver指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234896409-8c426a9d-6bd5-4fcf-badf-1c569feb9d0f.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=570&id=ud1dbc6f9&name=image.png&originHeight=1139&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=818418&status=done&style=none&taskId=u14995238-ea46-4f12-a077-bf75a87ab45&title=&width=1000)

官方解释下就是：反向代理的场景，upstream后端用域名时，配置resolver以便于nginx能够解析该域名。

当proxy_pass 后面接变量时，而且设置了resolver,会把变量的负载值通过resolver来解析，其他情况通过本地dns服务，etc或host 来解释域名。

[https://www.jianshu.com/p/5caa48664da5](https://www.jianshu.com/p/5caa48664da5)

<a name="RMuUT"></a>
### 4.3 负载均衡哈希算法

<a name="o7thC"></a>
#### 4.3.1 upstream_ip_hash模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234918758-d9c6ae3e-f854-4ae6-9304-afa58138b34d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=432&id=u9af2efad&name=image.png&originHeight=863&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=858601&status=done&style=none&taskId=u69f4e58f-7df1-4d7d-85e8-558bc0d244f&title=&width=1000)

<a name="uiNTL"></a>
#### 4.3.2 upstream_hash模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234937966-0c3bc85c-5717-489d-899f-3d579570d6d5.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=451&id=u19ed8892&name=image.png&originHeight=901&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=855775&status=done&style=none&taskId=uf0f88da8-60ee-4610-bfc6-9032dcf66c8&title=&width=1000)

<a name="xtdca"></a>
#### 4.3.3 演示

```bash
upstream iphashtest { 
	ip_hash;
	hash user_$arg_username;#使用username作为hash算法的关键字
	server 127.0.0.1:8011;
	server 127.0.0.1:8012;
}
```

<a name="S8aeK"></a>
### 4.4 一致性hash算法

使用hash算法，下游服务器异常会导致大量请求的路由策略失效。一致性hash算法能有效解决该问题。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234956671-461d4199-68dc-4a48-a42d-df3f767c747b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=647&id=u6c636114&name=image.png&originHeight=1294&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=970015&status=done&style=none&taskId=u06cc4925-c24f-4fda-981b-f1c818c003f&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234969336-5b55c82c-0ad0-4410-8dc6-a14594bdac48.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=581&id=ue9127fb5&name=image.png&originHeight=1161&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=718328&status=done&style=none&taskId=u13c2312c-8de3-4cbb-8e1d-de6948b6fe3&title=&width=1000)

把0-232围成一个环，4个服务均有的分布在环上，0-230请求第一个服务，以此类推；

扩容后：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665234982045-872bee72-7b58-4c8c-9a46-833a1bf6ab8d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=637&id=u9a4b6352&name=image.png&originHeight=1273&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=808552&status=done&style=none&taskId=uda4c909e-8238-4263-8f76-055b566e522&title=&width=1000)

扩容后只会改变node2—node4前半段的hash点。

<a name="HuvsG"></a>
#### 4.4.1 使用方法

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235013249-1013d660-e270-4af2-8615-dca385e0fb90.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=209&id=ud8eeb6a7&name=image.png&originHeight=418&originWidth=1224&originalType=binary&ratio=1&rotation=0&showTitle=false&size=194759&status=done&style=none&taskId=u8745c38b-2258-410e-8073-8b5bff89f51&title=&width=612)

<a name="ezvze"></a>
### 4.5 最小连接数算法

<a name="qoLdi"></a>
#### 4.5.1 upstream_least_conn模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235024898-6d6ea1e2-f41e-447e-968c-f5b39fab68e4.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=457&id=ude31a868&name=image.png&originHeight=914&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=939905&status=done&style=none&taskId=uad8d0535-7dd6-41a5-abc6-f3c9d74ab5e&title=&width=1000)

<a name="r05Kq"></a>
### 4.6 怎么跨worker生效：upstream_zone模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235037106-a4b74d52-df53-4611-8eb1-60ec5101065d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=447&id=u0168dc27&name=image.png&originHeight=894&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=960816&status=done&style=none&taskId=u6d942b42-6dc9-4ad5-8591-a81a1232790&title=&width=1000)

如上所有算法均可以使用upstream_zone来使得所有worker生效。

<a name="Xhy7B"></a>
### 4.7 upstream模块间的顺序

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235053435-2deaa6bf-f36a-4d2c-afd0-eb5ba9d258ca.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=655&id=uda97eca7&name=image.png&originHeight=1309&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=959154&status=done&style=none&taskId=u5fa1a711-44da-4192-a531-60eebd4986a&title=&width=1000)

<a name="Vv5xZ"></a>
### 4.8 http upstream提供的变量

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235072227-f06b1c4d-cc19-43ee-a6aa-4dbda112ac8f.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=595&id=uf04a62ac&name=image.png&originHeight=1190&originWidth=1874&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1281068&status=done&style=none&taskId=uc974ea24-a43a-4119-98bd-9029a74c259&title=&width=937)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235084496-c6adedde-b45c-443b-97f4-1c26c928bb5a.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=603&id=u512bd22a&name=image.png&originHeight=1206&originWidth=1968&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1148944&status=done&style=none&taskId=ufc8990db-5872-4587-ae0f-b11ccd1cf1b&title=&width=984)

<a name="MunE5"></a>
### 4.9 反向代理

<a name="NIgXu"></a>
#### 4.9.1 http反向代理proxy处理请求的流程

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235095653-d64d8e47-38a2-45d5-b5dc-91d42cea476b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=549&id=uec0406c4&name=image.png&originHeight=1097&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1155150&status=done&style=none&taskId=u894d3e33-2727-446f-a68e-85f9402689e&title=&width=1000)

<a name="NVVIf"></a>
#### 4.9.2 proxy模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235114415-1c8e2247-b4d0-4970-8452-8f0cc8d9ca2e.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=403&id=u00b22762&name=image.png&originHeight=806&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=634994&status=done&style=none&taskId=ua03e9d2c-2662-45d7-a3fd-f21b1de14ec&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235126621-f76cc966-505b-442d-a22b-7fca9c70a303.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=403&id=u3e1b0648&name=image.png&originHeight=806&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=634994&status=done&style=none&taskId=u5b372a9b-2bdf-4123-9178-a970551c8bd&title=&width=1000)

- 案例

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235137876-362f3cb3-7dda-4f4a-b608-24cca7ffad10.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=403&id=u8240680e&name=image.png&originHeight=806&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=634994&status=done&style=none&taskId=u8c5de22d-ace2-4197-8aa0-31fb973c6bc&title=&width=1000)

http://proxyups/addurl会被换为：[http://proxyups/a](http://proxyups/a)

<a name="hACEF"></a>
#### 4.9.3 修改请求下游服务的的请求

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235164903-3583cbfe-11e5-4709-93c4-14506baf2a21.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=539&id=u734d4771&name=image.png&originHeight=1077&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=773598&status=done&style=none&taskId=ub0fc13b9-763f-4000-9f30-83dc45fe52b&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235171619-b343dca1-69be-4d3b-bd31-f8a66147dc4b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=548&id=uf0ebf071&name=image.png&originHeight=1096&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1164795&status=done&style=none&taskId=uc008a702-a52e-4732-b078-2e3a6837bc8&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235179058-c51a0616-c81b-45f7-a23d-796b0b3ca292.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=573&id=u6cd5665b&name=image.png&originHeight=1146&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=797573&status=done&style=none&taskId=uc6898171-f5f9-4d66-8eb0-6bf11c0d877&title=&width=1000)

<a name="GGW4U"></a>
### 4.10 接收用户请求body

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235191120-a7649772-68ae-4c3d-b8a0-f56e19e1cfa7.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=554&id=u167e2fe9&name=image.png&originHeight=1108&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1175699&status=done&style=none&taskId=u1c59e64b-eb30-4f7b-8f8a-0e92fa9f0b6&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235200760-13fb9385-18de-478d-b19d-27bb7accd86d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=527&id=ud7e7649e&name=image.png&originHeight=1054&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1243875&status=done&style=none&taskId=u40304d30-36d3-4a21-8169-ea2ad493fac&title=&width=1000)

client_body_buffer_size：Nginx分配给请求数据的Buffer大小，如果请求的数据小于client_body_buffer_size直接将数据先在内存中存储。如果请求的值大于client_body_buffer_size小于client_max_body_size，就会将数据先放到client_body_buffer_size的内存中，再一遍一遍地写到临时文件中。

client_body_in_single_buffer:客户端请求数据的body一律存储到内存buffer中。当然，如果HTTP包体的大小超过了下面client_body_buffer_size设置的值，包体还是会写入到磁盘文件中。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235231239-11a58c10-78a7-4f0d-9326-2f6ad03bfc48.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=514&id=u67b6f2fc&name=image.png&originHeight=1027&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=864584&status=done&style=none&taskId=u739e1d9a-1cd9-4762-848e-1b36a7b1e0d&title=&width=1000)

client_max_body_size 默认 1M，表示 客户端请求服务器最大允许大小，在“Content-Length”请求头中指定。如果请求的正文数据大于client_max_body_size，HTTP协议会报错 413 Request Entity Too Large。就是说如果请求的正文大于client_max_body_size，一定是失败的。如果需要上传大文件，一定要修改该值。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235243270-7283c11f-c3e1-4a53-a87e-34acc7eff7bb.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=512&id=u56721754&name=image.png&originHeight=1023&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=893295&status=done&style=none&taskId=ub2b4f941-f5e1-40cc-a9e0-c934c95413b&title=&width=1000)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235252428-905a367c-c828-4ea1-8230-2464ded753ac.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=527&id=u5b39b037&name=image.png&originHeight=1053&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=728447&status=done&style=none&taskId=ua2b6094e-17c5-4f1f-ace6-bf59949b240&title=&width=1000)

2次读取body时间超过60s后，返回408.

<a name="XBuwX"></a>
### 4.11 连接下游服务器

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235263722-a8bcf302-5557-44b9-bf5e-5718ae37c096.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=580&id=u5dac0662&name=image.png&originHeight=1160&originWidth=1614&originalType=binary&ratio=1&rotation=0&showTitle=false&size=478176&status=done&style=none&taskId=u6f497749-fdaa-4f24-b279-3f4aece8084&title=&width=807)<br />当与下游服务建立连接超时时，再换一台服务器重新连接。

<a name="VHmUZ"></a>
#### 4.11.1 TCP keepalive

关闭无用的连接，减少资源浪费。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235302462-5df3ff8d-2a66-4d9e-be58-3594354fd8d5.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=683&id=uf66cff10&name=image.png&originHeight=1366&originWidth=1700&originalType=binary&ratio=1&rotation=0&showTitle=false&size=562231&status=done&style=none&taskId=u82478acc-6c92-455f-b609-a127c36e157&title=&width=850)

使用操作系统设置的默认keepalive相关配置来控制tcp的keepalive来降低资源使用。

<a name="waRzj"></a>
#### 4.11.2 HTTP keepalive

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235312272-4810429f-298a-4c94-8795-cb87d7224b46.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=355&id=uc1eb371b&name=image.png&originHeight=710&originWidth=1172&originalType=binary&ratio=1&rotation=0&showTitle=false&size=247553&status=done&style=none&taskId=uf7c01854-e930-4f4d-92cd-cfb0954c42b&title=&width=586)
<a name="vdqKK"></a>
#### 4.11.3 修改TCP连接中的local address

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235321214-cea1adf3-d587-481d-b4d3-4e656fc88e37.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=366&id=uf7b48db4&name=image.png&originHeight=732&originWidth=2000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=491636&status=done&style=none&taskId=uca0755c7-6426-4a7c-8928-52cc805d17f&title=&width=1000)

proxy_bind隶属于proxy_module，为向后端建立连接时的local ip，在nginx源码中只支持bind一个ip进行回源，若想使用多个ip进行回源时，可以修改源码支持bind ip数组。在实际应用中我就是这样做的。bind ip数据轮询选择ip进行回源与upstream建立连接，以解决单ip回源连接数限制问题。

proxy_bind：它的用法主要有两类用途，第一类用途就是当我们nginx上有多个ip地址时，可能有多个路由的策略是不同的，比如内网或者外网等，这个时候不要使用系统默认给我们选择的ip地址，而是主动使用一个ip地址。这个时候用proxy_bind。第二种场景，很可能为了传递一个ip地址，就是透传ip地址的策略，比如在stream反向代理中会很常用，在之后还会详述。这里先说下proxy_bind用法。

proxy_bind $remote_addr 也就是客户端的地址绑定到这里。绑定变量的时候呢，如果地址不是本地的地址，linux必须要加transparent。非linux操作系统呢需要保证worker进程有root 权限的，才能人为的修改socket的local address。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235349712-b2f1b8c6-f412-4083-8fb8-de8a17e2459b.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=356&id=u98d08a45&name=image.png&originHeight=712&originWidth=1346&originalType=binary&ratio=1&rotation=0&showTitle=false&size=352099&status=done&style=none&taskId=u12fcf809-13a8-4efd-8029-5e04465e8d4&title=&width=673)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235358600-22faf062-256a-4e23-bb1a-e0c87a77caca.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=306&id=u601e1c86&name=image.png&originHeight=612&originWidth=1196&originalType=binary&ratio=1&rotation=0&showTitle=false&size=286158&status=done&style=none&taskId=uf14204e3-9d74-40e3-8ff7-643c868503b&title=&width=598)

<a name="a8hRJ"></a>
### 4.12 接收下游的响应
<a name="M71wH"></a>
#### 4.12.1 接收下游服务的响应头部

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235372217-79dc4351-7e78-47b0-97d2-44ada569fb95.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=510&id=uc60c7759&name=image.png&originHeight=1020&originWidth=1620&originalType=binary&ratio=1&rotation=0&showTitle=false&size=480449&status=done&style=none&taskId=u7e5d571b-ac68-49be-9495-61f14cfeadf&title=&width=810)

proxy_buffer_size：限定了接收自上游的http response中header的最大值。所以当上游的server发送了http响应，如果有set cookie这种特别长的header可能就会导致整个全部的response header超出了这个值。超出完之后这个请求就不能够被nginx正确的处理了。我们的error.log中会看到`upstream sent too big header`<br />就是这样的一个原因。

<a name="zZ88f"></a>
#### 4.12.2 接收下游服务的响应body

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235380428-2c29a5f9-0e1b-468b-b917-b7aa274d1d66.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=436&id=uacc417ad&name=image.png&originHeight=872&originWidth=1528&originalType=binary&ratio=1&rotation=0&showTitle=false&size=313858&status=done&style=none&taskId=u75d3b99d-a2a3-4541-8252-bdc1cb5648b&title=&width=764)

proxy_buffering：来控制我们是不是先接收完整的包体，接收完了才开始转发。或者说不接收完，而是每接收一部分就同步的向客户端发送我收到的那部分响应。这两种方式各有各的好处。通常情况下默认开启（on）。因为我们认为上游服务和我们nginx走的是内网，网速更快。如果我们边发边接收上游边往客户端发。因为客户端跟nginx之间的网速可能很慢。所以就会导致，对于比较大的body 的时候，nginx长时间与上游建立连接。而上游比如说tomcat、Django等它们的并发能力是很弱的。当然如果我们用了proxy_buffering off 它的优点是能让客户端及时接收到响应，特别是一些大包体的情况下。客户端不用再等待。

在我们接收上游发来的HTTP包体，即使我们开启了proxy_buffering on也并不一定向磁盘中写入包体，因为如果包体非常的小，在内存中就可以放入的话，就没有必要写到磁盘中，因为磁盘io总是比较慢的。所以这个时候就有了proxy_buffers指令。也就是包体大小没有超过这个设定值就不用写入磁盘。否则的话就要写入磁盘了。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235388815-c44cba7d-ef3a-4dc3-9d74-b5641b2b1c9f.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=584&id=u9f010ecb&name=image.png&originHeight=1168&originWidth=1966&originalType=binary&ratio=1&rotation=0&showTitle=false&size=695032&status=done&style=none&taskId=ua95b193d-bf39-4e95-946d-78f8d8e0147&title=&width=983)

proxy_buffering ，默认开启，希望尽快释放上游服务器的连接，当然proxy_buffering 还有一个nginx特定的header。这个header（X-Accel-Buffering头部）只有nginx才会认。当上游的tomcat 如果在response中加入X-Accel-Buffering头部，如果配置为yes，就会强制要求nginx先接收完上游的http body 再向client发送。也就是它会替换指定的内容。

当我们向磁盘中写入包体的时候还有三个指令，proxy_max_temp_file_size、proxy_temp_file_write_size、proxy_temp_path。

proxy_max_temp_file_size：限制写入磁盘中这个文件的最大值。如果上游服务中返回了非常大的文件超出了临时文件大小也会出错的。默认是1G。

proxy_temp_file_write_size：每一次向磁盘文件中写入的字节数。

proxy_temp_path：设定了存放临时文件的目录在哪里，以及目录level层级。

<a name="rCiVg"></a>
#### 4.12.3 及时转发body

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235401049-cbcc1ec4-6229-43e0-b75c-aa3ac1896cb7.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=181&id=u6d37a5aa&name=image.png&originHeight=362&originWidth=1510&originalType=binary&ratio=1&rotation=0&showTitle=false&size=187598&status=done&style=none&taskId=u26cb7513-8abe-4aa3-a89d-43ee3e34356&title=&width=755)

proxy_busy_buffers_size。虽然被缓存所有的响应，我们希望更及时的向客户端发送部分响应。比如我们收到1G文件。当我们接收到前8k或前16k（proxy_busy_buffers_size 8k|16k）的时候，就先向客户端转发接收到的这一部分响应的话就可以使用proxy_busy_buffers_size 。

<a name="Qr8qZ"></a>
#### 4.12.4 接收下游服务时网络速度相关指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235409353-f5ece408-5b69-48dc-acd3-3fed60b9c5f5.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=519&id=uffe78824&name=image.png&originHeight=1038&originWidth=1650&originalType=binary&ratio=1&rotation=0&showTitle=false&size=554403&status=done&style=none&taskId=ufaf4134b-2c30-4504-aa74-aeaeea8881f&title=&width=825)

proxy_read_timeout：两次读取操作之间最多60秒的超时。两次读取是一个TCP层的一个概念。

proxy_limit_reate：限速，和客户端limit_rate 有些类似，但是它限制的是读取上游的响应，而不是发送给上游服务的网速。设置为0表示不限制读取上游响应的速度。

<a name="kTEbL"></a>
#### 4.12.5 上游body的持久化
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235443661-fd68b1ec-c9c4-490e-ac84-a409db0a2a7d.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=514&id=ucb9779f1&name=image.png&originHeight=1028&originWidth=1774&originalType=binary&ratio=1&rotation=0&showTitle=false&size=521716&status=done&style=none&taskId=ubdc3d640-87da-44c8-a610-8009498a32f&title=&width=887)<br />proxy_store_access：配置指定目录权限。

proxy_store：把临时文件改名到root对应的目录下，默认不开启，如果是`string`，可再次指定，使用变量的方式，指定这个文件存放的位置。

<a name="opsc9"></a>
### 4.13 处理下游响应头部
<a name="pumCu"></a>
#### 4.13.1 返回响应-加工响应内容
我们接收到了上游发来的http header跟http body，其实对上游发来的http header是有很多控制nginx行为的这样一些头部的。我们在反向代理这一层也可以去修改上游发来的header中的内容，以及它们所产生的效用。接下来看看这两种行为是怎么发生的。

第三部分讲的http 过滤模块。当我们生成的响应向客户端发送的时候。这个内容必须经历过滤模块的处理。对于nginx作为反向代理的时候也是同样的。nginx下游服务返回的一些header会被那些过滤模块处理（图中）。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665298124851-41596499-a5c0-44ac-b1f0-30d787b532df.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=638&id=ueec939bc&name=image.png&originHeight=1276&originWidth=2262&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1814847&status=done&style=none&taskId=u785b9f60-c8a2-438a-a43f-884f933619c&title=&width=1131)<br />比如ngx_http_modified_filter_module，它根据上游服务返回的cache control等等这些header，去修改到底是发送200还是304响应码给客户端。所以上游一些header的内容会改变作为反向代理的nginx的行为。

- proxy_ignore_header指令
> proxy_ignore_header可以禁止某些响应头改变nginx行为。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235478919-c9574cc8-1ae6-4379-a8ef-e3f7ce4658cf.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=305&id=ua35bcb1d&name=image.png&originHeight=610&originWidth=1022&originalType=binary&ratio=1&rotation=0&showTitle=false&size=402808&status=done&style=none&taskId=uab334906-eea6-48cd-8b77-82cdaf6bba7&title=&width=511)

- proxy_hide_header指令
> nginx提供了一个指令proxy_ignore_header，禁用上游中一些header 的功能。当然不是所有的header 都具有功能，这个指令只针对于具有特殊功能的header才发生作用。


![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235500664-e8f2ed10-fc98-4892-ba6c-0082ebcd79ac.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=250&id=u18dfb530&name=image.png&originHeight=500&originWidth=986&originalType=binary&ratio=1&rotation=0&showTitle=false&size=249295&status=done&style=none&taskId=uba6bb07c-7877-4a59-853b-df0e1655a89&title=&width=493)<br />说明：<br />（1）X-Pad：是apache 使用的header，目前已经很少用了。<br />（2）X-Aceel-：只有nginx才认。<br />（3）如果上述这四类header你想发送给客户端，就使用proxy_pass_header。

- 修改返回的set-cookie头部

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665298895995-9593633f-7752-482a-afb5-c36c94e54fee.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=336&id=u176d8c65&name=image.png&originHeight=672&originWidth=1434&originalType=binary&ratio=1&rotation=0&showTitle=false&size=392769&status=done&style=none&taskId=ue553823d-8cfa-4472-8ede-60ba2b9aede&title=&width=717)<br />修改下游服务器response header中的头部set-cookie中的内容。proxy_cookie_domain修改下游服务器返回的cookie中的域名；

- 修改返回的Location头部
> proxy_dedirect：对于我们上游服务发送的响应中有一个location，location后面的url可以做一次替换。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665299012719-3b1b64b1-c046-416d-9e32-3fc218668b3d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=166&id=u04470049&name=image.png&originHeight=332&originWidth=1372&originalType=binary&ratio=1&rotation=0&showTitle=false&size=209582&status=done&style=none&taskId=u5a85af6b-df42-4442-93b9-521619e2ec3&title=&width=686)

<a name="Oe3F7"></a>
#### 4.13.2 处理返回响应演示
（1）反向代理服务配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665299215256-df97e024-5a6a-4d4a-9557-2e303ca42c38.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=567&id=u5345cd7e&name=image.png&originHeight=1134&originWidth=1598&originalType=binary&ratio=1&rotation=0&showTitle=false&size=732467&status=done&style=none&taskId=u9f115a3e-2b52-44fc-93fe-4a03c7b6d31&title=&width=799)<br />（2）下游服务配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665299282968-51ba3142-4f4e-4890-ab00-6daa7289f026.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=582&id=uf33df932&name=image.png&originHeight=1164&originWidth=1928&originalType=binary&ratio=1&rotation=0&showTitle=false&size=626909&status=done&style=none&taskId=u8ecc6875-dc53-4448-8c75-5e482464ffe&title=&width=964)<br />直接访问localhost:8012如下所示有个aaa的header：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665299411209-2bf7ea22-ecfe-4391-bff7-e73c0e82ce79.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=285&id=ud4900997&name=image.png&originHeight=570&originWidth=1550&originalType=binary&ratio=1&rotation=0&showTitle=false&size=454663&status=done&style=none&taskId=uef48aea9-d1fe-422d-b4e5-c3c2bf1336d&title=&width=775)<br />访问反向代理服务时也有个aaa的header：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665299515801-30e61100-703d-4419-819b-0260f5ef3ef2.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=293&id=ucc10b817&name=image.png&originHeight=586&originWidth=1734&originalType=binary&ratio=1&rotation=0&showTitle=false&size=487551&status=done&style=none&taskId=uc4a797c0-1a0e-4a5c-a7e5-47d6a87eb52&title=&width=867)<br />（3）禁用反向代理服务的aaa:
```shell
proxy_hide_header aaa;
```
再次访问反向代理服务，发现没有了aaa的header。<br />（4）打开proxy_pass_header,可以把下游服务的nginx版本返回给客户端：
```shell
proxy_pass_header server
```
再次访问反向代理服务，发现server是nginx 1.15.6而非反向代理的openresty。

总结：以上几节课包括从proxy_pass指令来指定由反向代理来指定请求到生成向上游发送请求的内容，以及接收客户端发来的http body并与上游服务建立连接并上游服务的响应内容以及处理响应头部，以上几个环节，就是nginx作为反向代理处理客户端与上游服务之间的所有流程。 
<a name="IFnAc"></a>
#### 4.13.3 下游返回失败时处理方法
> 我们讨论了nginx作为反向代理时，从客户端接收http body，到完整的接收下游的响应并转发响应的流程。其中在nginx与下游服务建立连接时。提到过proxy_next_upstream指令，这个指令可以在第一台的错误的响应后重新选择另一台下游服务器处理请求返回给客户端这样的功能。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235524257-6313d1a4-cffc-4292-abc5-5c6425a358bf.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=212&id=u4608ba18&name=image.png&originHeight=424&originWidth=904&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113552&status=done&style=none&taskId=u7208081d-d8e0-426b-8bfc-a58f4552aa4&title=&width=452)<br />能够生效的前提是没有向客户端发送一个字节。只要向客户端已经发送了一个字节了，说明下游的服务已经生效了，就不能选用一个新的下游服务了。它一定是在接收到并开始转发一个字节之前nginx判定为错误，这个功能才能生效。proxy_next_upstream后面可以跟很多不同的参数（error、timeout那些）。<br />**配置：**

- error：

nginx与上游建立连接读取响应，发送请求等等这些过程中，只要出现错误等等。error都可以满足这样的场景。这种错误主要是网络错误。比如TCP层、IP层的错误。

- timeout：

超时有connection timeout 、read timeout、 write timeout，这个timeout可以命中这些场景。当出现这种场景的时候将执行重选另一个下游服务。

- invalid_header：

则是我们收到的下游服务http header，它是不合法的。

- http_：

http_可以跟一个明确的响应code。上游返回一个403或500，其实它既不是网络错误，也不是超时，也不是invalid_header。但是我们就是可以针对这样的错误从新选择一个新的upstream上游去处理。

- non_idempotent：

根据RFC 7231文档中规定了post、lock等method的请求。在下游服务不能使用next_upstream上游服务的，去重选一个新的服务时候，当我们配置了这个non_idempotent就可以启用proxy_next_upstream功能。

- off：

关闭 proxy_next_upstream功能。

两个相关指令：
> proxy_next_upstream_timeout 超时时间；proxy_next_upstream_tries 重试次数

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665235537116-197f5bcf-9c41-41a4-97a7-3039e298ced6.png#clientId=uf334e644-6b14-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=224&id=uaf41976c&name=image.png&originHeight=448&originWidth=872&originalType=binary&ratio=1&rotation=0&showTitle=false&size=155069&status=done&style=none&taskId=ueb10a9f6-cde5-4a73-b16e-3d4ae03b56a&title=&width=436)
<a name="mwVpa"></a>
#### 4.13.4 下游返回失败时处理演示
反向代理配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665301268436-faf9339f-a6db-4e40-8002-b630d2f5236a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=720&id=uf2a07ff1&name=image.png&originHeight=1440&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=909814&status=done&style=none&taskId=udc9661b4-81ed-44bc-9f89-4b398a0fa6e&title=&width=1280)<br />下游服务：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665301295977-a854c910-5c5a-4ee7-ba1f-6cfda8a7f64a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=720&id=uaac93213&name=image.png&originHeight=1440&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1081929&status=done&style=none&taskId=ue99e1f68-31ad-4bf1-a257-a8df5776da1&title=&width=1280)<br />（1）关闭proxy_next_upstream，访问反向代理服务就会在8011和8012端口服务上轮询<br />（2）打开proxy_next_upstream，且关闭下游8013服务，访问反向代理服务，一直是8011服务做响应。<br />（3）修改反向代理服务配置：
```shell
location /httperr {
	proxy_next_upstream http_500;//下游服务返回500时生效
	proxy_pass http://nextups;
}
```
访问反向代理服务，一直是8011服务做响应。
<a name="uFjV7"></a>
#### 4.13.5 使用error_page拦截下游失败响应
> 当下游响应码大于等于 300时，就应该使用error_page来处理请求返回给客户端。

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665302047007-0416fba3-218a-4b66-a40a-3de5320c4b52.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=127&id=u129a3d45&name=image.png&originHeight=254&originWidth=2124&originalType=binary&ratio=1&rotation=0&showTitle=false&size=193559&status=done&style=none&taskId=u51725b26-f72e-444e-97af-4c47f9c4eae&title=&width=1062)<br />proxy_intercept_errors 默认off。这个时候上游返回怎样的响应，客户端就会原封不动的拿到这个响应。比如上游返回来一个404，我们的error_page 配置的404是不会生效的。只有把proxy_intercept_errors 设置为on的时候error_page 就会生效了。

- 演示：

代理服务配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665302237201-5c9c288c-9e42-49f0-9b63-b95b37a14b8c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=496&id=u872e2d3c&name=image.png&originHeight=992&originWidth=2102&originalType=binary&ratio=1&rotation=0&showTitle=false&size=489585&status=done&style=none&taskId=u10e947fa-f464-4994-9d9b-232864c37eb&title=&width=1051)<br />proxy_intercept_errors 为on时，配置了error_page，发现500错误码的时候返回test1.txt。

<a name="a6rvT"></a>
### 4.14 对下游使用SSL连接
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665305521253-035be8bb-21f1-4187-a534-9ebfcf8bd308.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=720&id=u2aac5704&name=image.png&originHeight=1440&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=936744&status=done&style=none&taskId=u38b99f76-54db-4e63-9988-3ce829ee2e8&title=&width=1280)<br />Nginx提供以上4种关于证书的指令。

- 对上游使用证书

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665305633938-cb60922f-c2ca-40d6-abec-42f18f5c87e9.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=297&id=ubac5cd42&name=image.png&originHeight=594&originWidth=1894&originalType=binary&ratio=1&rotation=0&showTitle=false&size=216362&status=done&style=none&taskId=u680cd43e-71ea-4499-8d84-5b20265a222&title=&width=947)

- 验证上游证书

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665305856740-eefd3c22-c7cd-4b84-9ea7-02fede3acbab.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=298&id=u4d239267&name=image.png&originHeight=596&originWidth=2202&originalType=binary&ratio=1&rotation=0&showTitle=false&size=298632&status=done&style=none&taskId=ucb2903e0-c758-4fc6-9a48-bc40afa30bb&title=&width=1101)

- 对下游使用证书

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665305933067-f35477a8-865a-47d9-a1bc-4f275e3d1b5f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=345&id=u91850fa2&name=image.png&originHeight=690&originWidth=2226&originalType=binary&ratio=1&rotation=0&showTitle=false&size=265934&status=done&style=none&taskId=u1a7e422d-f5de-4d35-83e9-4cfec1a925c&title=&width=1113)

- 验证下游证书

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665305986858-fe1d6c53-bf3d-4365-9499-3c70d3a2f9bf.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=315&id=u1e3c1e0e&name=image.png&originHeight=630&originWidth=2168&originalType=binary&ratio=1&rotation=0&showTitle=false&size=303287&status=done&style=none&taskId=u8fc643cf-6a05-4991-9c9f-f50fec3bbf8&title=&width=1084)

<a name="vYQku"></a>
#### 4.14.1 SSL模块提供的变量
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665306045736-ef48b65b-0172-4ef6-a482-dd67bba1f121.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=440&id=uf56e83fa&name=image.png&originHeight=880&originWidth=1930&originalType=binary&ratio=1&rotation=0&showTitle=false&size=811669&status=done&style=none&taskId=u0321b968-5682-44c1-88d0-0d1cc1d0f92&title=&width=965)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665306111703-d40f904f-46ee-420e-a06a-567c3b42659e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=542&id=ue769da6a&name=image.png&originHeight=1084&originWidth=2078&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1255220&status=done&style=none&taskId=u5803e389-20f2-4828-a5ad-eda37257c0d&title=&width=1039)

<a name="nem5l"></a>
#### 4.14.2 创建证书命令示例
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665306757597-6e8b7a1d-0127-41bb-9788-fd220014b629.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=586&id=u85db25f0&name=image.png&originHeight=1172&originWidth=2212&originalType=binary&ratio=1&rotation=0&showTitle=false&size=593354&status=done&style=none&taskId=uf86e6809-137f-42a4-b6fe-7c0fa38cdfb&title=&width=1106)
<a name="yYiTF"></a>
### 4.15 浏览器缓存
在互联网中使用缓存是最有效的提升访问速度的方法。在web服务器场景中不仅要考虑nginx作为缓存服务时的使用方法，还要考虑浏览器缓存生效的场景。浏览器的缓存是否生效可以通过nginx的指令去控制。而浏览器的缓存对用户的体验提升也是最大的。
<a name="WgqOI"></a>
#### 4.15.1 浏览器缓存和Nginx缓存的比较
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665307127982-14bf0c9a-9027-451e-83c8-6b23fb9ea5da.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=473&id=u02ef1321&name=image.png&originHeight=946&originWidth=1520&originalType=binary&ratio=1&rotation=0&showTitle=false&size=528146&status=done&style=none&taskId=u4990f625-a592-4d01-826d-84ae5799b58&title=&width=760)
<a name="s9KVI"></a>
#### 4.15.2 浏览器缓存
<a name="GPcRO"></a>
#### ![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665307238891-a06ba389-9a69-4a58-a914-fae0ac5e87b5.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=574&id=uc21a6b7d&name=image.png&originHeight=1148&originWidth=1284&originalType=binary&ratio=1&rotation=0&showTitle=false&size=331926&status=done&style=none&taskId=u088b1279-e656-4117-b952-77390362478&title=&width=642)  

- Etag头部

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665307306790-9490b637-17ec-463f-8700-52d468e5e5fa.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=470&id=u256fc396&name=image.png&originHeight=940&originWidth=2006&originalType=binary&ratio=1&rotation=0&showTitle=false&size=974103&status=done&style=none&taskId=u12e57366-ddfa-42bc-9ef5-9c6b2ae7841&title=&width=1003)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665307349152-d947a9e6-17cd-4d9e-91f9-27465250d85c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=414&id=u04661df9&name=image.png&originHeight=828&originWidth=2238&originalType=binary&ratio=1&rotation=0&showTitle=false&size=333428&status=done&style=none&taskId=u55e0cbad-eee3-4938-a7ea-db0d820e72e&title=&width=1119)

- If-None-Match

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665307414071-729715ac-d45a-4020-b690-aca58a7a23b8.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=523&id=u2aed43a3&name=image.png&originHeight=1046&originWidth=2050&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1688357&status=done&style=none&taskId=ud22bfc2e-97b1-44c0-8ab2-df3402b1ade&title=&width=1025)

- If-Modified-Since

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665307504831-3325dc9a-7749-4578-a6bc-1a2fd6f14248.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=304&id=u437f608f&name=image.png&originHeight=608&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&size=697154&status=done&style=none&taskId=ue73a0995-ab0b-40b6-a010-79f2eb56581&title=&width=960)<br />Last-Modified：比较简单，也就是我们访问的资源，比如我们使用了一个js文件，这个js文件的在服务器上上次被修改时间。
<a name="qVgem"></a>
### 4.16 Nginx决策浏览器过期缓存是否有效
<a name="tqDDD"></a>
#### 4.16.1 Expires指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665308272803-dd26cb8f-d0d4-42cc-ae6c-8f313546995c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=579&id=u7b92ab39&name=image.png&originHeight=1158&originWidth=2164&originalType=binary&ratio=1&rotation=0&showTitle=false&size=884501&status=done&style=none&taskId=u3885e696-9546-4e95-8424-fb2e519ceac&title=&width=1082)<br />演示：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665308425860-5b6114e2-6ead-49b1-980b-cd731ab0e9ce.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=720&id=u902c410c&name=image.png&originHeight=1440&originWidth=2560&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1304706&status=done&style=none&taskId=u1dc05d6d-8d40-4759-ab92-d5dfc5ff0af&title=&width=1280)
<a name="fAzoY"></a>
#### 4.16.2 not_modified过滤模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665308562189-b617c45a-5abd-4d77-81e9-69bf1ffbf873.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=269&id=uc729a88a&name=image.png&originHeight=538&originWidth=2144&originalType=binary&ratio=1&rotation=0&showTitle=false&size=446055&status=done&style=none&taskId=ud12d385e-24d3-4d02-b996-1f3ce2217b5&title=&width=1072)

not_modified过滤模块处理过程：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665308633467-6f7be09a-3c6e-4be2-9c39-cd8946ee5bad.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=626&id=u812009d8&name=image.png&originHeight=1252&originWidth=2200&originalType=binary&ratio=1&rotation=0&showTitle=false&size=881237&status=done&style=none&taskId=u3087d538-846b-41a9-94c2-2db969b231b&title=&width=1100)

- if_modified_since

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665308697874-ec7aa8c6-9d34-417d-a8eb-b9ec80379774.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=445&id=inM9I&name=image.png&originHeight=890&originWidth=2250&originalType=binary&ratio=1&rotation=0&showTitle=false&size=463412&status=done&style=none&taskId=u277f3154-0930-4e2b-9288-407570871e1&title=&width=1125)

- If-Match

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665308792241-14562cb4-d061-42a7-9b52-fe817944471e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=427&id=u0359e3c3&name=image.png&originHeight=854&originWidth=1980&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1124572&status=done&style=none&taskId=u0621d45a-d46a-49da-8eda-d36cdaa5fc3&title=&width=990)

- If-Unmodified-Match

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665308870737-5a4d5b25-23a8-4fd5-af0f-c3f9e56f94c1.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=374&id=uc2f1da1b&name=image.png&originHeight=748&originWidth=2166&originalType=binary&ratio=1&rotation=0&showTitle=false&size=966075&status=done&style=none&taskId=u0a22c7be-b879-4344-8b3d-1a9e6263b18&title=&width=1083)
<a name="eJipA"></a>
### 4.17 Nginx缓存
这节课介绍在nginx之上配置上游服务器返回的响应的缓存。会涉及到一些指令的值，它是与第二部分课程中介绍过nginx进程结构的时候谈到的Cache Manager、Cache Loader 这两个进程。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665309247107-21c3a7cb-f30a-4f69-acca-fcb20531e4a9.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=440&id=u7011aa9f&name=image.png&originHeight=880&originWidth=2182&originalType=binary&ratio=1&rotation=0&showTitle=false&size=747579&status=done&style=none&taskId=ucb4acaf8-7fdc-4874-88f7-3d46b6a04e2&title=&width=1091)


<a name="dn5rM"></a>
#### 4.17.1 nginx的cache使用
内容是放到磁盘上的，但是它的元素信息为了加快访问是放到内存中的。所以首先在proxy_cache_path指令中定义好共享内存。因为我们有多个worker进程，所以这些元信息一定是在共享内存中的。第二个定义在磁盘中哪个位置去存放缓存文件。proxy_cache_path定义好以后，其中keys_zone的name就是共享内存的名字，size就是共享内存的大小。共享内存的名字就是给proxy_cache使用的。也就是在proxy_cache_path定义了一批缓存文件存放的位置和共享内存的名称。也许有很多location，它们定义了各自独立的缓存的key或缓存策略。但是它们都可以使用同一个proxy_cache_path指定的keys_zone。所以proxy_cache在location中可以通过这个zone指定使用哪一个proxy_cache中的设置。

<a name="XRz48"></a>
#### 4.17.2 proxy_cache_path
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665309706617-eeae4d6a-faca-4b97-a2b6-f7832c823269.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=484&id=u3fa55ef6&name=image.png&originHeight=968&originWidth=1702&originalType=binary&ratio=1&rotation=0&showTitle=false&size=705183&status=done&style=none&taskId=u45313633-795e-40ed-ba95-40f10a1af1e&title=&width=851)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665309799030-a8ae2fba-4926-4676-a602-2b7f64ea7a8f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=498&id=u4da1ed24&name=image.png&originHeight=996&originWidth=1710&originalType=binary&ratio=1&rotation=0&showTitle=false&size=751038&status=done&style=none&taskId=ua8373215-faf0-4f02-9a08-1b6bd1277fe&title=&width=855)<br />use_temp_path：使用这个临时文件目录，最后改名都会放到path中。但为什么会有这个设置呢？是因为，很可能nginx所在的机器中有多个文件系统，甚至有些网络文件系统。如果我们开始的use_temp_path 目录是在一个磁盘上，而path是在另外一个磁盘上。跨磁盘复制是在cp文件。如果在一个磁盘上，那最后的改名也只是改名而已。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665309960798-c64475db-9731-422e-8136-e0bf42e8d6e1.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=314&id=u90907d79&name=image.png&originHeight=628&originWidth=2132&originalType=binary&ratio=1&rotation=0&showTitle=false&size=329857&status=done&style=none&taskId=u73df13b1-27cc-4178-ae67-0c903a870f3&title=&width=1066)
<a name="t8WPI"></a>
#### 4.17.3 proxy_cache_valid: 缓存什么样的响应
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665310054124-7fb8522a-7ba3-4b27-b704-02945e6fd6f3.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=570&id=u99d50050&name=image.png&originHeight=1140&originWidth=1136&originalType=binary&ratio=1&rotation=0&showTitle=false&size=514148&status=done&style=none&taskId=u885f5329-ac7b-49d9-81aa-1091fad5458&title=&width=568)

<a name="hBx8A"></a>
#### 4.17.4 proxy_no_cache: 什么样的响应不缓存
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665310198990-ec904d3f-51a7-436b-8342-8988a1f6ffd0.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=454&id=u1d897c7e&name=image.png&originHeight=908&originWidth=1910&originalType=binary&ratio=1&rotation=0&showTitle=false&size=397211&status=done&style=none&taskId=u04c284ba-cc9a-4bb6-8959-cfe3a01d8c3&title=&width=955)

proxy_cache_convert_head：默认为on，会把header方法转换成get方法。

<a name="z66My"></a>
#### 4.17.5 upstream_cache_status变量
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665310320091-054a37c1-13a5-4ffc-833b-96b5c964f8f4.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=375&id=u60439f14&name=image.png&originHeight=750&originWidth=1590&originalType=binary&ratio=1&rotation=0&showTitle=false&size=442319&status=done&style=none&taskId=ue22b47f8-e02f-4717-9d9a-a430543bb1f&title=&width=795)<br />EXPIRED：表示nginx cache_vaild设置的时间还没有过期，用户的请求获取到缓存，但是上游服务器指定的缓存时间也许是小于cache_vaild设置的时间，根据上游的说法来说缓存已经过期了，但nginx配置的时候，这个缓存仍然在使用。所以和这个时候是EXPIRED，缓存已经过期。
<a name="r6qQx"></a>
### 4.18 对客户端请求的缓存处理
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665372058109-017a04a7-884a-441c-9969-eb7411223e27.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=548&id=ub57b1d57&name=image.png&originHeight=1096&originWidth=1936&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1083749&status=done&style=none&taskId=u9aa0495c-ae85-4ad2-beab-f56c2365ac1&title=&width=968)

补充说明：
```latex
proxy_cache_methods GET | POST|HEAD...//对哪些请求方法使用缓存
```
<a name="KuzbP"></a>
### 4.19 接收下游响应缓存处理
补充说明：

- X-Accel-Expires头部：

从下游服务定义缓存多少时间（0不缓存；@前缀表示缓存当天的某个时间）

- Vary头部：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665372811074-1cc4b7f9-a14f-4f28-9f8e-1dee63664dcf.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=457&id=ued2bb0ba&name=image.png&originHeight=914&originWidth=2228&originalType=binary&ratio=1&rotation=0&showTitle=false&size=976290&status=done&style=none&taskId=u18f177af-d69a-4702-aa91-385713d2023&title=&width=1114)

- Set-Cookie:

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665372926907-0639897e-038a-48d8-a409-b444b90b396a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=453&id=u560456be&name=image.png&originHeight=906&originWidth=1732&originalType=binary&ratio=1&rotation=0&showTitle=false&size=801598&status=done&style=none&taskId=u38d5bd81-08ef-4ca9-84d5-59770472fd0&title=&width=866)
<a name="c49VE"></a>
#### 4.19.1 缓存流程
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665373005693-8e64c0eb-853c-488a-842e-a116375d914f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=548&id=ud2fcf38a&name=image.png&originHeight=1096&originWidth=1936&originalType=binary&ratio=1&rotation=0&showTitle=false&size=829445&status=done&style=none&taskId=u70c011ac-ecac-4a61-8bec-5215862afde&title=&width=968)
<a name="lInAe"></a>
#### 4.19.2 使用分片提示缓存效率

- slice模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665392367025-3ab5c6df-4388-4fac-a92a-fd429a3b2f57.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=367&id=u713c3f52&name=image.png&originHeight=734&originWidth=2214&originalType=binary&ratio=1&rotation=0&showTitle=false&size=378151&status=done&style=none&taskId=u62cb447f-2f35-4cd9-a025-c26afddfa9a&title=&width=1107)

- slice模块运行流程

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665392406373-3b23bc96-36de-4e35-b08b-45d8e4318742.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=384&id=ucfb62749&name=image.png&originHeight=768&originWidth=1530&originalType=binary&ratio=1&rotation=0&showTitle=false&size=214649&status=done&style=none&taskId=u1a878672-fcda-4510-81a2-b3b7c16a894&title=&width=765)
<a name="KUvDp"></a>
#### 4.19.3 open_flie_cache提示系统性能
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665392801651-7b96b472-83fc-494f-a328-8417f10acdeb.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=148&id=u504a80ec&name=image.png&originHeight=296&originWidth=1594&originalType=binary&ratio=1&rotation=0&showTitle=false&size=194985&status=done&style=none&taskId=ue4fe9e06-a97f-45bc-becd-4031cc5a598&title=&width=797)

- 缓存元信息

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665392865446-6b21e793-3900-4c5e-be26-d9e09171b24c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=554&id=ubb2742cf&name=image.png&originHeight=1108&originWidth=2250&originalType=binary&ratio=1&rotation=0&showTitle=false&size=910483&status=done&style=none&taskId=u4942a13e-a006-4729-a1fd-699867c9f9a&title=&width=1125)

- 其他open_flie_cache指令

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665392930915-e3587fcf-4b03-44ca-9c18-286f624da615.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=476&id=ub7d05708&name=image.png&originHeight=952&originWidth=2018&originalType=binary&ratio=1&rotation=0&showTitle=false&size=518175&status=done&style=none&taskId=uc5cc9886-6473-4615-95f7-2ecb0ec2525&title=&width=1009)

- 案例

下游服务配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665393034794-efe6b0cc-3b94-4c34-ab76-d00e545888bc.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=183&id=u17040192&name=image.png&originHeight=366&originWidth=1340&originalType=binary&ratio=1&rotation=0&showTitle=false&size=196637&status=done&style=none&taskId=u5ee618d9-76d0-4c9e-9b3a-984926048e7&title=&width=670)<br />第一次访问：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665393257988-696bc209-0bf5-4168-9d0b-e02e7c795925.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=488&id=u1d900a68&name=image.png&originHeight=976&originWidth=2424&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1535387&status=done&style=none&taskId=ud0a40502-2751-49cf-af22-8b7d49fb429&title=&width=1212)<br />第二次访问：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665393309828-f4f492ca-22b2-4d24-8636-158dd23d264f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=384&id=u2a67d5ae&name=image.png&originHeight=768&originWidth=2516&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1220272&status=done&style=none&taskId=u82c8f410-beb4-4b84-8f09-c2ce3d12ee4&title=&width=1258)
<a name="CNv7J"></a>
### 
<a name="RQFPp"></a>
### 4.20 Nginx缓存失效时如何减轻下游服务压力
> nginx重启或者意外退出时，所以缓存就会失效，这个时候接收下游服务全部穿透Nginx打到下游服务，导致下游服务压力剧增。

<a name="QXCU7"></a>
#### 4.20.1 合并回源请求
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665373445361-642e92cf-4c28-4cea-9351-e6cae0eaf306.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=548&id=uda47c565&name=image.png&originHeight=1096&originWidth=1936&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1109965&status=done&style=none&taskId=u3ad08019-0411-40e0-a330-626a41202b2&title=&width=968)
<a name="OQQCy"></a>
#### 4.20.1 减少回源请求
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665373614353-bbdd81c1-7165-4a5f-a74a-43b29141d81b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=548&id=uca128e27&name=image.png&originHeight=1096&originWidth=1936&originalType=binary&ratio=1&rotation=0&showTitle=false&size=837538&status=done&style=none&taskId=u166a327c-f40a-44f8-a7d2-08fb528f6fd&title=&width=968)<br />proxy_cache_use_stale：第一个请求来了后打到下游服务，后续的请求给客户端响应旧的缓存内容，直至第一个请求的下游响应被缓存。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665373991341-37e3f793-a05a-4151-8a9f-11bc51cde54e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=548&id=u154f900b&name=image.png&originHeight=1096&originWidth=1936&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1021117&status=done&style=none&taskId=u6f22dbd1-79ac-4920-b535-d5345094fcf&title=&width=968)<br />对应缓存有问题的响应：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665374127638-6fcb6578-c1b8-430a-a9f1-4470fd812aed.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=489&id=u650350d8&name=image.png&originHeight=978&originWidth=2022&originalType=binary&ratio=1&rotation=0&showTitle=false&size=749433&status=done&style=none&taskId=u40337dd1-7a16-4954-a92c-d9ec80c0575&title=&width=1011)<br />例子：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665374204311-b6cd1b1a-79c9-4619-976a-7c525080f1bf.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=588&id=u44cd7aab&name=image.png&originHeight=1176&originWidth=1748&originalType=binary&ratio=1&rotation=0&showTitle=false&size=522880&status=done&style=none&taskId=u6303ce6a-afc1-4794-b284-06f96bf21f8&title=&width=874)<br />proxy_cache_background_update:第一个请求来了把旧的缓存响应给客户端，同时向下游服务发送一个子请求，后续的请求给客户端响应旧的缓存内容。直至第一个请求的子请求收到下游服务响应内容后，更新缓存，后续的请求均可使用到新缓存。
<a name="OGqZc"></a>
### 4.21 及时清除缓存
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665374327470-473cdb87-aade-44b4-b0dc-32709d834dd5.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=438&id=u59bd6c10&name=image.png&originHeight=876&originWidth=1492&originalType=binary&ratio=1&rotation=0&showTitle=false&size=386028&status=done&style=none&taskId=u1d24a034-d4fa-4cc5-8b64-becf4977e3a&title=&width=746)
<a name="BqqSs"></a>
### 4.22 http反向代理和uwcgi、fastcgi、scgi反向代理的指令对照
<a name="R7NhV"></a>
#### 4.22.1 构造请求内容的指令对照
<a name="QYzOq"></a>
#### ![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665386093617-0fbf6da6-1699-45bb-aee6-a647c90c9d64.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=402&id=uc2001283&name=image.png&originHeight=804&originWidth=2198&originalType=binary&ratio=1&rotation=0&showTitle=false&size=962916&status=done&style=none&taskId=u4c54c28e-904d-4a4f-96fa-7509dd5113b&title=&width=1099)
<a name="ZaIFK"></a>
#### 4.22.2 建立连接并发送请求的指令对照
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665386286545-d568ceff-a38c-42d5-a0a4-df727c368179.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=377&id=u4dc06116&name=image.png&originHeight=754&originWidth=2270&originalType=binary&ratio=1&rotation=0&showTitle=false&size=951239&status=done&style=none&taskId=u25e98979-d761-4ed5-a273-43517590851&title=&width=1135)
<a name="mVSBu"></a>
#### 4.22.3 接收下游响应的指令对照
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665386412470-50a6b1db-ddf2-4466-bf4a-963136397595.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=509&id=u5a8c5858&name=image.png&originHeight=1018&originWidth=2252&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1513853&status=done&style=none&taskId=ucc24ee36-31fc-4202-b43f-8bfa9de51e2&title=&width=1126)
<a name="f22ua"></a>
#### 4.22.4 转发响应的指令对照
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665386539300-81222a32-819f-4083-9a28-cc71ef0b202b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=513&id=u6cf470c8&name=image.png&originHeight=1026&originWidth=2402&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1446566&status=done&style=none&taskId=ue62788a0-2c8a-4bc4-8206-edc5274bdfc&title=&width=1201)
<a name="ivICZ"></a>
#### 4.22.5 SSL的指令对照
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665386642288-151a8de0-2f52-452e-a2ac-175bd3b502a8.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=512&id=uca564db8&name=image.png&originHeight=1024&originWidth=2328&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1305286&status=done&style=none&taskId=uaf999ad2-767e-4f0e-908a-a73017aa018&title=&width=1164)
<a name="RRY1m"></a>
#### 4.22.6 缓存的指令对照
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665386760612-1983e117-8812-4e28-a0ea-885b55b11c62.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=483&id=u30c005e4&name=image.png&originHeight=966&originWidth=2402&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1525455&status=done&style=none&taskId=ub500f9e9-0e16-4483-87b5-b36f01bb39f&title=&width=1201)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665386831769-6c8383f2-7dae-4076-8bcf-348ae5b54849.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=380&id=u2364ee4b&name=image.png&originHeight=760&originWidth=2406&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1128817&status=done&style=none&taskId=u180ac14d-f48b-422f-8231-60cac524856&title=&width=1203)
<a name="P7kkt"></a>
#### 4.22.7 独有配置
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665386896889-2d38de7b-7fd3-4f58-b922-27220b2b6a26.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=265&id=u3fbb3c43&name=image.png&originHeight=530&originWidth=2152&originalType=binary&ratio=1&rotation=0&showTitle=false&size=267405&status=done&style=none&taskId=ue1280888-226b-4f13-b53b-805a2f3651a&title=&width=1076)
<a name="jPY7b"></a>
### 4.23 memcached反向代理用法
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665387056343-b29eaa2b-ec7c-4dbf-a632-6d085d245f8e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=362&id=u9f36cc36&name=image.png&originHeight=724&originWidth=1898&originalType=binary&ratio=1&rotation=0&showTitle=false&size=540988&status=done&style=none&taskId=u0339ae59-a101-4dae-9507-256039c5df0&title=&width=949)
<a name="JbyqT"></a>
#### 4.23.1 memcached指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665387237330-971d6820-9f14-4e66-a4c3-5d7fcc7a2bea.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=389&id=uc12d7b79&name=image.png&originHeight=778&originWidth=1622&originalType=binary&ratio=1&rotation=0&showTitle=false&size=692000&status=done&style=none&taskId=u6e3bb3d2-8f09-4535-a3dd-651eff6d6ee&title=&width=811)<br />演示：<br />代理服务器配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665387434357-3d857997-98b3-4207-bd5a-84003eee9521.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=158&id=u89f88217&name=image.png&originHeight=316&originWidth=1510&originalType=binary&ratio=1&rotation=0&showTitle=false&size=161723&status=done&style=none&taskId=ufb68f301-2803-47a1-9889-096a6f838bf&title=&width=755)
```shell
[root]:#curl xxx.com/get?key=hello
[root]:#world//取出了hello的值
```
补充说明：<br />memcached_gzip_flag：如果设置的key使用了gzip压缩，取出的时候需要这个指令来标识。
<a name="jPpgX"></a>
### 4.24 webSocket反向代理

- 功能

由nginx_http_proxy_module模块实现

- 配置

proxy_http_version 1.1;<br />proxy_set_header Upgrade $http_upgrade;<br />proxy_set_header Connection "upgrade";<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665391423333-ad48c735-eec4-4e4f-ba94-1ce1a84e6e88.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=488&id=ue16c94b0&name=image.png&originHeight=976&originWidth=1772&originalType=binary&ratio=1&rotation=0&showTitle=false&size=789763&status=done&style=none&taskId=u05ca22e1-18df-41be-9781-c8ebe0c93c6&title=&width=886)
<a name="sTdQC"></a>
#### websocket协议帧
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665391552501-4d297e32-1e7d-43eb-b26f-7528243508c5.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=419&id=u65d96271&name=image.png&originHeight=838&originWidth=1548&originalType=binary&ratio=1&rotation=0&showTitle=false&size=871014&status=done&style=none&taskId=u24da9acc-f6b9-4fa6-ac24-2f56c7b03c4&title=&width=774)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665391625739-932ef547-a270-4640-813d-5caac54761e1.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=430&id=u02d05191&name=image.png&originHeight=860&originWidth=1438&originalType=binary&ratio=1&rotation=0&showTitle=false&size=607404&status=done&style=none&taskId=ub3f0a8f1-ba1f-431e-b420-a8e9b842078&title=&width=719)
<a name="gyPXI"></a>
#### websocket协议和扩展
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665391671798-d3f4dc80-4dda-49d1-99e5-cd5dd9e4d1a0.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=428&id=u845832c1&name=image.png&originHeight=856&originWidth=1820&originalType=binary&ratio=1&rotation=0&showTitle=false&size=787841&status=done&style=none&taskId=u0967e899-8210-40e9-96e7-25476e7ea2d&title=&width=910)

<a name="Ax3Nu"></a>
#### 测试
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665391977251-5658aad4-67d8-4e04-af7d-a93152f190bc.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=480&id=u5ba1ed55&name=image.png&originHeight=960&originWidth=1304&originalType=binary&ratio=1&rotation=0&showTitle=false&size=188281&status=done&style=none&taskId=u58b78469-b0ca-479c-a3eb-c705ca413b7&title=&width=652)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665391961441-3531f5d8-d24e-4f5b-a773-f97a95342e64.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=582&id=u0a599869&name=image.png&originHeight=1164&originWidth=2472&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1093903&status=done&style=none&taskId=u8ad29eb4-e013-454d-af99-530e96f6118&title=&width=1236)

<a name="ITSV4"></a>
### 4.25 HTTP2.0
<a name="tRLpW"></a>
#### 4.25.1 http2.0特性
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665393487955-2ce6c5e0-99eb-4ccf-85dc-6e61f9c6562a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=454&id=u571188ca&name=image.png&originHeight=908&originWidth=1004&originalType=binary&ratio=1&rotation=0&showTitle=false&size=306333&status=done&style=none&taskId=ue8f00474-7fbf-454d-9565-2f3c72861b7&title=&width=502)
<a name="fR7Dr"></a>
#### 4.25.2 http2.0核心概念
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665393611806-d1954bdc-69d2-4d3f-8797-c75e6431982b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=488&id=uee1ce919&name=image.png&originHeight=976&originWidth=2132&originalType=binary&ratio=1&rotation=0&showTitle=false&size=723696&status=done&style=none&taskId=uf47182f3-a7bd-45b4-be19-f8d3cdf6af5&title=&width=1066)

- 协议分层：

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665393728958-946eeff8-20b8-499c-ad79-79617248cc35.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=525&id=uade3ef0b&name=image.png&originHeight=1050&originWidth=2050&originalType=binary&ratio=1&rotation=0&showTitle=false&size=420083&status=done&style=none&taskId=uc454dac6-6875-46ef-ad80-086b680f075&title=&width=1025)

- 多路复用

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665393807120-5373d5a5-1f33-4fcf-b673-4e26a705487a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=541&id=u8b8c54c5&name=image.png&originHeight=1082&originWidth=1346&originalType=binary&ratio=1&rotation=0&showTitle=false&size=413843&status=done&style=none&taskId=u99f7f499-36bc-4d91-9603-632b7db66b4&title=&width=673) 

- 传输无序，接收时组装

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665393896759-5afeb8bb-31fa-4ebd-bf4a-d12d6b3da782.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=341&id=u1f19ab41&name=image.png&originHeight=682&originWidth=2264&originalType=binary&ratio=1&rotation=0&showTitle=false&size=332882&status=done&style=none&taskId=ufba2f8c9-6193-4991-9491-e5892c99b51&title=&width=1132)

- 数据流优先级

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665393953843-7cd644c4-54ed-4d53-affe-a754641afef4.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=455&id=u193c8511&name=image.png&originHeight=910&originWidth=2382&originalType=binary&ratio=1&rotation=0&showTitle=false&size=466408&status=done&style=none&taskId=uea9619b4-973b-4386-84aa-842b993b410&title=&width=1191)

- 标头压缩

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665394006165-f4c2300a-3161-4c84-a219-9377bf8b7766.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=536&id=u15020911&name=image.png&originHeight=1072&originWidth=1526&originalType=binary&ratio=1&rotation=0&showTitle=false&size=619688&status=done&style=none&taskId=u45d332db-93c4-4574-a749-3f13534afd2&title=&width=763)

- Frame格式

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665394063887-67a8b441-3ace-45ae-84ad-62a9b3789b2b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=584&id=u48b5299f&name=image.png&originHeight=1168&originWidth=1888&originalType=binary&ratio=1&rotation=0&showTitle=false&size=910361&status=done&style=none&taskId=u44a735d3-65fd-4d1f-96a7-9c60fc06ced&title=&width=944)

- 服务器PUSH

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665394165877-9d899312-3ba7-485d-ab56-05bb0d97acb3.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=409&id=u1dcaba08&name=image.png&originHeight=818&originWidth=2022&originalType=binary&ratio=1&rotation=0&showTitle=false&size=439400&status=done&style=none&taskId=uc8cd5356-7306-473e-9361-0ecba00d74e&title=&width=1011)
<a name="cW5Zt"></a>
#### 4.25.3 搭建http2.0服务并推送资源

1. 使用模块ngx_http_v2_module

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665394348139-e9e069cf-dfab-49b3-8746-4faf1106e303.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=417&id=u53028d1d&name=image.png&originHeight=834&originWidth=2156&originalType=binary&ratio=1&rotation=0&showTitle=false&size=446044&status=done&style=none&taskId=uefcf821b-a57d-40c7-aa6a-1d1dc171aeb&title=&width=1078)

2. 推送资源

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665394434634-b760607d-9f55-44e4-b5bb-e2759e5b3b0c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=471&id=u7574abb4&name=image.png&originHeight=942&originWidth=2432&originalType=binary&ratio=1&rotation=0&showTitle=false&size=561998&status=done&style=none&taskId=u389a1564-a592-4f68-9747-20392db808d&title=&width=1216)

3. 测试

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665394641969-2f716c01-3b63-4b27-bf00-af5d23934190.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=662&id=ue72999d7&name=image.png&originHeight=1324&originWidth=1496&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1014538&status=done&style=none&taskId=u570bf417-e794-48b0-aa41-f392ad56195&title=&width=748)<br />服务器配置：
> 设置了http2_push和http3_push_preload

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665394715514-eaae8bc4-2a60-4efb-97c4-5a2037607704.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=376&id=u11247740&name=image.png&originHeight=752&originWidth=1838&originalType=binary&ratio=1&rotation=0&showTitle=false&size=548764&status=done&style=none&taskId=uc93fa71f-1931-4fee-9489-8e928e9aa8f&title=&width=919)<br />请求：nghttp2 -ns https://localhost:4430/<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665394910945-0f245019-cf49-440e-a29c-85fb608ed11a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=99&id=uc076eab2&name=image.png&originHeight=198&originWidth=1522&originalType=binary&ratio=1&rotation=0&showTitle=false&size=232074&status=done&style=none&taskId=ua95846e8-866e-4903-b1b9-e3bf2f492a0&title=&width=761)<br />请求：nghttp2 -ns https://localhost:4430/test/test.html<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665395000287-81b66e7d-5794-465a-aafa-334db3aee08b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=102&id=ue0a85bff&name=image.png&originHeight=204&originWidth=1692&originalType=binary&ratio=1&rotation=0&showTitle=false&size=298968&status=done&style=none&taskId=u75169058-199d-45c6-9cf2-94316bd52e6&title=&width=846)

4. 其他指令
- 最大并行推送数

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665395080657-afc9b891-9b11-4805-bbc7-e6a5b8f44901.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=128&id=u32f2f3c9&name=image.png&originHeight=256&originWidth=1930&originalType=binary&ratio=1&rotation=0&showTitle=false&size=184728&status=done&style=none&taskId=ua46402df-d906-44fe-934d-bdba43cbbc6&title=&width=965)

- 超时控制

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665395117300-31e67878-3e64-4634-8eb5-4d928ab035b1.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=309&id=u67c727ef&name=image.png&originHeight=618&originWidth=1518&originalType=binary&ratio=1&rotation=0&showTitle=false&size=287252&status=done&style=none&taskId=u3b13d9d8-cb66-47a9-bf3b-2b886562083&title=&width=759)

- 并发请求控制

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665395144181-38359389-1847-40d4-a0bc-efc4a25e028b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=466&id=u86a88ee7&name=image.png&originHeight=932&originWidth=1508&originalType=binary&ratio=1&rotation=0&showTitle=false&size=512194&status=done&style=none&taskId=u3b7e9e87-d9ad-489b-b44e-54da62f8ae3&title=&width=754)

- 连接最大请求数

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665395203835-27502e7d-d5f1-4bdf-9fff-65b81ed5ad33.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=298&id=u1f5261ce&name=image.png&originHeight=596&originWidth=1502&originalType=binary&ratio=1&rotation=0&showTitle=false&size=308400&status=done&style=none&taskId=u8ccafe7a-9dd1-4978-bf1b-8b489fb4456&title=&width=751)

- 缓存区大小设置 

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665395239250-7bf37ad0-2d9f-42ca-a268-3720494e9234.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=435&id=uf258f65c&name=image.png&originHeight=870&originWidth=1654&originalType=binary&ratio=1&rotation=0&showTitle=false&size=468438&status=done&style=none&taskId=u92b6e66f-269a-4882-9d29-e4dcc5d328e&title=&width=827)
<a name="DbtHT"></a>
### 4.26 grpc反向代理
协议：grpc协议（https://grpc.io）<br />模块：ngx_http_grpc_module,默认开启，可以通过without--ngx_http_grpc_module禁用<br />依赖：ngx_http_v2_module模块
<a name="qjGHX"></a>
#### 2.26.1 grpc代理和http反向代理指令对照
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665395669882-0695606f-c8ae-4dec-8ba3-e106770bbd4c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=587&id=ue6dbf7e2&name=image.png&originHeight=1174&originWidth=2130&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1215637&status=done&style=none&taskId=u049899ac-6cbd-4f6c-abec-1c520449184&title=&width=1065)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665395774086-6a51b555-c00c-4c88-ba58-39844d91c300.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=511&id=ua3580572&name=image.png&originHeight=1022&originWidth=2192&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1149438&status=done&style=none&taskId=udb2c9923-f7b0-4f2c-8c27-06c49ad747c&title=&width=1096)

<a name="hrROt"></a>
### 4.27 传输层stream四层反向代理的七个阶段

- 七个阶段

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665556651125-2edae5f3-290b-4f8d-98e6-0f52966b01cc.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=368&id=u965d000b&name=image.png&originHeight=736&originWidth=1928&originalType=binary&ratio=1&rotation=0&showTitle=false&size=326800&status=done&style=none&taskId=u7dbec46e-0278-4b62-bf1d-8ddfa5499c7&title=&width=964)

- stream模块的ssl阶段

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665556914756-b37cc5da-4041-48a5-8fce-b97a22bcdf48.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=439&id=u6eedbe27&name=image.png&originHeight=878&originWidth=2206&originalType=binary&ratio=1&rotation=0&showTitle=false&size=438875&status=done&style=none&taskId=u4eb39e69-21cd-4818-9d81-895f8a7fb8a&title=&width=1103)

- content阶段return模块

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665557175828-a3826123-58d3-4cbf-90d6-cb0c9701bbbe.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=141&id=ufa9b81dc&name=image.png&originHeight=282&originWidth=994&originalType=binary&ratio=1&rotation=0&showTitle=false&size=106630&status=done&style=none&taskId=u435651ba-9fc5-4f27-9c02-03542781a3d&title=&width=497)
<a name="pWjVz"></a>
#### 4.27.1 常用变量
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665556987347-15926370-f9d4-4cbb-8530-72d06e0e23d1.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=462&id=u797445c8&name=image.png&originHeight=924&originWidth=2266&originalType=binary&ratio=1&rotation=0&showTitle=false&size=779493&status=done&style=none&taskId=ub3a6aa6d-d0de-4d19-b37b-76f2bc0caae&title=&width=1133)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665557032047-915a33d7-e253-4f0e-8403-2d7422b2bb7b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=275&id=u2f6d75d9&name=image.png&originHeight=550&originWidth=2026&originalType=binary&ratio=1&rotation=0&showTitle=false&size=265809&status=done&style=none&taskId=uc6a929e7-f975-496f-a602-fdab79dbe8a&title=&width=1013)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665557051663-8894b1ed-570d-4b3b-9343-8f0deac5f47b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=509&id=u41416060&name=image.png&originHeight=1018&originWidth=1934&originalType=binary&ratio=1&rotation=0&showTitle=false&size=635305&status=done&style=none&taskId=ua83c86d1-3b0b-49fd-b938-2faf85f4c85&title=&width=967)

- 系统变量

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665557122221-a84df100-13ea-4fd3-8929-f06951f29499.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=469&id=u637d0f4a&name=image.png&originHeight=938&originWidth=2146&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1091499&status=done&style=none&taskId=uace3397e-b44a-4eec-ac5e-de65f2f8f70&title=&width=1073)

- 演示

服务器配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665557358813-71e82464-6a28-40b2-9718-fafbc2c7af95.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=445&id=u9fb168cc&name=image.png&originHeight=890&originWidth=1482&originalType=binary&ratio=1&rotation=0&showTitle=false&size=542986&status=done&style=none&taskId=u641cf6c3-ea26-407d-92f9-158c4a3cfe0&title=&width=741)<br />连接：<br />telnet localhost:10004,返回如下：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665557417901-fd184db9-8b65-483c-bbdc-770736600978.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=471&id=ue10e9c4b&name=image.png&originHeight=942&originWidth=1122&originalType=binary&ratio=1&rotation=0&showTitle=false&size=595401&status=done&style=none&taskId=u74406985-63e1-48cb-9c52-94b09b01836&title=&width=561)
<a name="RR7o4"></a>
#### 4.27.2 POST_ACCEPT阶段realip模块
<a name="loBNl"></a>
##### proxy_protocol协议
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665557784671-13a3f211-b126-490f-b300-a76bd2c977b0.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=468&id=ue8bcf911&name=image.png&originHeight=936&originWidth=2468&originalType=binary&ratio=1&rotation=0&showTitle=false&size=889753&status=done&style=none&taskId=u02e5b30d-5904-40d2-9360-43db57f7c8d&title=&width=1234) Nginx读取proxy_protocol协议超时控制：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665557959420-7dd3c6fb-f02a-4285-aee3-aee05e1850c9.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=137&id=uce959d34&name=image.png&originHeight=274&originWidth=1724&originalType=binary&ratio=1&rotation=0&showTitle=false&size=221411&status=done&style=none&taskId=uecc44fa3-d625-44b1-8972-ab45f6bcab5&title=&width=862)
<a name="hGeYJ"></a>
##### stream处理proxy_protocol流程
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665558025507-d2871aec-45e8-4d2f-8e0d-142dc954a233.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=601&id=u8dc0a88c&name=image.png&originHeight=1202&originWidth=1312&originalType=binary&ratio=1&rotation=0&showTitle=false&size=711242&status=done&style=none&taskId=u7583ce7c-ac7f-4aab-9f1c-592bec894de&title=&width=656)
<a name="G0Pan"></a>
##### post_accept阶段：realip模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665558137660-b4bcb9e7-ee68-4e6a-8e88-a1e764d05f16.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=530&id=uc86e0ea4&name=image.png&originHeight=1060&originWidth=2066&originalType=binary&ratio=1&rotation=0&showTitle=false&size=768106&status=done&style=none&taskId=u097984fd-59ea-4602-9590-21a67e9f5ed&title=&width=1033)
<a name="m98Bu"></a>
##### 演示
服务器配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665558320283-551a13d0-d8d6-4504-b68d-7353140e86ac.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=439&id=u66194b73&name=image.png&originHeight=878&originWidth=1662&originalType=binary&ratio=1&rotation=0&showTitle=false&size=656974&status=done&style=none&taskId=u2df6b5d6-df37-4058-8572-c6a43b916c1&title=&width=831)<br />连接：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665558509147-6fc53048-47c7-4bae-b5b0-d8f3ee8b9f39.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=545&id=u96f5489a&name=image.png&originHeight=1090&originWidth=2050&originalType=binary&ratio=1&rotation=0&showTitle=false&size=831736&status=done&style=none&taskId=ud4c01241-658d-4037-b970-e33ef070119&title=&width=1025)

<a name="zhLxR"></a>
#### 4.27.3 PREACCESS阶段limit_conn模块限制并发
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665558828799-fea51411-41c8-4fe6-858d-fe9342bdfcd8.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=268&id=S88Dh&name=image.png&originHeight=536&originWidth=2070&originalType=binary&ratio=1&rotation=0&showTitle=false&size=403067&status=done&style=none&taskId=uc9b836a9-e349-4de0-9424-fba2d74c59f&title=&width=1035)
<a name="WQKMc"></a>
##### limit_conn模块指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665558890049-726ea6ba-fc8d-4b22-971e-1680ae74b909.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=460&id=u32428a26&name=image.png&originHeight=920&originWidth=1854&originalType=binary&ratio=1&rotation=0&showTitle=false&size=537543&status=done&style=none&taskId=u10c74f4f-9277-4dac-91ae-d00033267fb&title=&width=927) 
<a name="JB8V0"></a>
#### 4.27.4 ACCESS阶段access模块限制ip
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665558942588-700d2f5b-1f2d-484f-8742-ddb6476bb52e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=208&id=ue69f76f9&name=image.png&originHeight=416&originWidth=1918&originalType=binary&ratio=1&rotation=0&showTitle=false&size=311832&status=done&style=none&taskId=uda9896a5-3a13-461b-93d5-a892eaa0a88&title=&width=959)
<a name="X4590"></a>
##### access模块指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665558996965-541654a9-22e4-495a-bba9-29eac30a09d3.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=323&id=u1419a9ee&name=image.png&originHeight=646&originWidth=1916&originalType=binary&ratio=1&rotation=0&showTitle=false&size=304530&status=done&style=none&taskId=uc9f61d8e-0046-4a69-9f1d-8973bf318a8&title=&width=958)
<a name="ybPkP"></a>
#### 4.27.5 LOG阶段stream_log模块记录日志 
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665559046332-0fb3b765-d7eb-41d8-9020-d13c7809220f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=499&id=uc5b95b96&name=image.png&originHeight=998&originWidth=2142&originalType=binary&ratio=1&rotation=0&showTitle=false&size=648292&status=done&style=none&taskId=u861a63e7-063d-4f82-92d1-7103ffe9f2a&title=&width=1071) 
<a name="zJcWA"></a>
#### 4.27.6 stream四层反向代理处理SSL上游客户端请求
<a name="aICAB"></a>
##### stream模块TSL/SSL应用场景
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665559485577-93606333-55a2-4432-b060-61fb0f4dace9.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=445&id=u20e41673&name=image.png&originHeight=890&originWidth=1938&originalType=binary&ratio=1&rotation=0&showTitle=false&size=291309&status=done&style=none&taskId=u745f0f2d-621d-4750-b6dd-2e4f3721f03&title=&width=969)

<a name="WKR0C"></a>
##### stream中的ssl
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665559646732-60b03c94-5744-4379-b36b-23865b929c75.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=301&id=uee88027e&name=image.png&originHeight=602&originWidth=1550&originalType=binary&ratio=1&rotation=0&showTitle=false&size=275837&status=done&style=none&taskId=u7d072762-68fd-4374-a947-ae1e8b31265&title=&width=775)
<a name="CL2ar"></a>
##### 对比stream模块的ssl和http模块的ssl配置
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665559725885-b0363f25-5c54-4cbc-8136-2f71cbb17f51.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=313&id=u7438c53c&name=image.png&originHeight=626&originWidth=2022&originalType=binary&ratio=1&rotation=0&showTitle=false&size=536618&status=done&style=none&taskId=u78343a9f-6b11-4af7-9b66-b29d707f076&title=&width=1011)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665559902334-881f051c-aaa1-4711-a9fc-e45f407413f6.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=137&id=ud7136e7f&name=image.png&originHeight=274&originWidth=2050&originalType=binary&ratio=1&rotation=0&showTitle=false&size=295409&status=done&style=none&taskId=u268945d1-3f39-42e8-aaed-a50ee381343&title=&width=1025)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665559927305-0622f5a5-db37-4c30-b18a-b6adcaf4b39e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=140&id=u96c7526e&name=image.png&originHeight=280&originWidth=2058&originalType=binary&ratio=1&rotation=0&showTitle=false&size=275788&status=done&style=none&taskId=uf03e5068-82f2-4c1e-b9f9-c7718c0dfb6&title=&width=1029)
<a name="mBvuo"></a>
##### stream中的ssl模块提供的变量
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665559962355-1f7aedf8-bd85-490c-a2d4-eef9c727e04b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=389&id=u9ae3fe62&name=image.png&originHeight=778&originWidth=1850&originalType=binary&ratio=1&rotation=0&showTitle=false&size=652394&status=done&style=none&taskId=u1081c715-1d07-492c-b68c-8b426575211&title=&width=925) ![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665560044154-670c3dca-05f2-4a22-b7c8-0a04e2d77791.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=407&id=u10c1e4a4&name=image.png&originHeight=814&originWidth=1520&originalType=binary&ratio=1&rotation=0&showTitle=false&size=665741&status=done&style=none&taskId=udbcb12f6-9d22-4d61-a87c-953377d3e6d&title=&width=760)
<a name="RWPDL"></a>
##### stream ssl模块实战
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665560245386-4c727b50-316b-4556-adba-d20df2f5d770.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=434&id=u8f768d56&name=image.png&originHeight=868&originWidth=1422&originalType=binary&ratio=1&rotation=0&showTitle=false&size=205691&status=done&style=none&taskId=u8d0ef698-a4b4-4c28-a107-bc14b65253d&title=&width=711)

反向代理配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665560655561-b021cdf6-3acb-4746-926f-349060c9aff0.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=146&id=u5aad4a40&name=image.png&originHeight=292&originWidth=2228&originalType=binary&ratio=1&rotation=0&showTitle=false&size=243718&status=done&style=none&taskId=uae0ec36c-7c67-474c-8984-cceed3b917c&title=&width=1114)<br />下游服务配置：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665560637688-6ea553a0-9637-493b-abb9-390926b2c927.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=530&id=u1dce263f&name=image.png&originHeight=1060&originWidth=2162&originalType=binary&ratio=1&rotation=0&showTitle=false&size=725348&status=done&style=none&taskId=ufe399380-3319-4361-b8ae-d0fc6b43eb5&title=&width=1081)<br />收到上游带ssl的请求，剥离调ssl证书，向下游服务发送请求。
<a name="R6aLU"></a>
##### stream_preread取出ssl关键信息
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665561012908-1560f70b-edcd-406e-acd5-7aee92609eb9.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=307&id=ua731bfbc&name=image.png&originHeight=614&originWidth=1262&originalType=binary&ratio=1&rotation=0&showTitle=false&size=291579&status=done&style=none&taskId=u9dce3c26-b2dc-4352-a4ec-e0f44be4216&title=&width=631) <br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665561165357-cfc22a9a-2a9e-4462-b9fb-2e87a7376525.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=297&id=uc08651ca&name=image.png&originHeight=594&originWidth=1062&originalType=binary&ratio=1&rotation=0&showTitle=false&size=212232&status=done&style=none&taskId=ue68ca22e-5350-4a86-ba4d-9169cb04ce4&title=&width=531)<br />实战：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665561360225-ed364917-c032-4e9d-93be-c9af73b7059d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=152&id=u66fef57a&name=image.png&originHeight=304&originWidth=1142&originalType=binary&ratio=1&rotation=0&showTitle=false&size=80423&status=done&style=none&taskId=u9e1b006e-e9ef-49ee-bcb4-ba130af0a84&title=&width=571)<br />反向代理层根据域名代理到不同的下游服务。
<a name="tUwVa"></a>
#### 4.27.7 stream proxy四层反向代理的用法
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665561542248-f17c1636-289b-46a1-8ef3-9287c7e846d5.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=236&id=u808d5e78&name=image.png&originHeight=472&originWidth=1290&originalType=binary&ratio=1&rotation=0&showTitle=false&size=192824&status=done&style=none&taskId=ub460454e-2f10-4018-beb6-56e23ef624f&title=&width=645)

<a name="N7rYv"></a>
##### proxy模块对上下游的的限速指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665561634138-7f030346-c8f7-48d4-a0be-dbe2424f6671.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=352&id=u7f815745&name=image.png&originHeight=704&originWidth=1870&originalType=binary&ratio=1&rotation=0&showTitle=false&size=368357&status=done&style=none&taskId=u2aea35b2-7007-4a77-ad75-35e625f1736&title=&width=935)
<a name="V0SN3"></a>
##### 反向代理相关指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665561800444-5c76f332-c681-4579-af0b-5a685ed2dc65.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=356&id=u9226662e&name=image.png&originHeight=712&originWidth=1662&originalType=binary&ratio=1&rotation=0&showTitle=false&size=572554&status=done&style=none&taskId=u0ae6b37f-f796-4e56-9d12-45ba063a662&title=&width=831)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665562036731-b95d922e-1b30-43ea-a932-58d5449e8fd0.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=376&id=ua8f36d42&name=image.png&originHeight=752&originWidth=1654&originalType=binary&ratio=1&rotation=0&showTitle=false&size=658284&status=done&style=none&taskId=ua13fa29b-989e-4dd7-944f-c0bbb1ced13&title=&width=827)

<a name="K2f7k"></a>
### 4.28 UDP反向代理
基本流程：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665562774700-8790cf3d-d392-48e1-ac9e-9ab12d7c8f9a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=327&id=udfeab67a&name=image.png&originHeight=654&originWidth=2086&originalType=binary&ratio=1&rotation=0&showTitle=false&size=281179&status=done&style=none&taskId=u70089902-718a-414a-ade1-65c00ac733d&title=&width=1043)<br />简要说明：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665562823973-ae065486-1a91-4149-b84f-ebd4545419ff.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=473&id=u4c12ce6a&name=image.png&originHeight=946&originWidth=1806&originalType=binary&ratio=1&rotation=0&showTitle=false&size=609331&status=done&style=none&taskId=u0910471f-a7cc-4a91-83d3-3c1ba87e195&title=&width=903)<br />实战：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665562924662-1dda16be-26cd-4b62-8f6e-f0bf59f2a43b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=166&id=u49281721&name=image.png&originHeight=332&originWidth=1076&originalType=binary&ratio=1&rotation=0&showTitle=false&size=156635&status=done&style=none&taskId=u1fe51d62-d7d5-4f45-b7a8-6f060662451&title=&width=538)
<a name="EAhBu"></a>
### 4.29 透传IP地址的3种解决方案
方案一：protocol协议<br />方案二：修改IP报文<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665563247104-c3ba8a33-419c-4d31-81d6-bcea4276b125.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=242&id=u3678b5c6&name=image.png&originHeight=484&originWidth=1672&originalType=binary&ratio=1&rotation=0&showTitle=false&size=274139&status=done&style=none&taskId=ufc8cdcbd-4a61-4cde-815a-580ce0243ec&title=&width=836)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665563338119-80a2249f-9db4-4f5a-8b16-125fdbc76154.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=531&id=uab08d465&name=image.png&originHeight=1062&originWidth=1634&originalType=binary&ratio=1&rotation=0&showTitle=false&size=477666&status=done&style=none&taskId=u56eb86fa-6c29-41f5-9c51-1ca5145291a&title=&width=817)<br />B-->A:<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665563495601-95d93628-483a-4fb0-aba0-2f1c08884b11.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=407&id=ueda40b23&name=image.png&originHeight=814&originWidth=2120&originalType=binary&ratio=1&rotation=0&showTitle=false&size=648979&status=done&style=none&taskId=u0cd5e500-63cb-46c3-99c4-8722dc58eb5&title=&width=1060)
<a name="l84Ar"></a>
## ![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665563557726-7a428235-44f2-4fb8-b2a4-0378acf41f1c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=547&id=u0cbe3a0e&name=image.png&originHeight=1094&originWidth=1594&originalType=binary&ratio=1&rotation=0&showTitle=false&size=343944&status=done&style=none&taskId=u6ba88db4-a8a8-4b50-a741-c1c990c8244&title=&width=797)
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665563571308-4019d296-3e58-4855-b759-a902686ad962.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=542&id=u2661d94f&name=image.png&originHeight=1084&originWidth=1958&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1086385&status=done&style=none&taskId=ua4c66c8c-a793-4e63-8bbc-299c13d7516&title=&width=979)
<a name="PWw5I"></a>
## 五、Nginx的系统层性能优化
优化方法论：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665567213514-e05efcf2-5389-4354-a878-ecab350745d5.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=427&id=u4326c91b&name=image.png&originHeight=854&originWidth=2024&originalType=binary&ratio=1&rotation=0&showTitle=false&size=787012&status=done&style=none&taskId=ua96d7e42-fbfd-402e-861f-5f74da81149&title=&width=1012)
<a name="yiXBQ"></a>
### 5.1 内存效率
<a name="MYg2A"></a>
#### 5.1.1 用tcmalloc优化内存分配
<a name="tk1iL"></a>
##### tcmalloc是什么？
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665650272301-2893b6af-5290-42ac-b942-b33eb1e8fb47.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=227&id=zlSDl&name=image.png&originHeight=454&originWidth=1198&originalType=binary&ratio=1&rotation=0&showTitle=false&size=205400&status=done&style=none&taskId=u42138d33-634c-4862-9156-d4e2b821bc6&title=&width=599)
<a name="eAH1d"></a>
##### 使用方法？
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665650521851-8424b995-46f5-4de2-ba7b-6ff0bd09c21e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=315&id=ZEtRo&name=image.png&originHeight=630&originWidth=1394&originalType=binary&ratio=1&rotation=0&showTitle=false&size=373676&status=done&style=none&taskId=u8b287367-3c5d-4067-8fc4-825eba5389d&title=&width=697)
<a name="tKNBo"></a>
### 5.2 CPU效率
<a name="he8wL"></a>
#### 5.2.1 如何增大Nginx使用CPU的有效时长？
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665567638818-87a88f6a-8f1d-49ba-8d82-db9219fdf1cb.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=434&id=ua4cf0c0a&name=image.png&originHeight=868&originWidth=962&originalType=binary&ratio=1&rotation=0&showTitle=false&size=434119&status=done&style=none&taskId=ua417aaa3-d8b8-4b3f-adbc-68870b2c62c&title=&width=481)
<a name="v8d12"></a>
##### worker进程数等于cpu核数
```shell
worker_process number | auto #一般设置为cpu核数
```

**为何一个CPU能同时运行多个进程？**<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665567995739-d4f7db37-140e-40ef-ae67-cc849a81b225.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=423&id=ucaaa4760&name=image.png&originHeight=846&originWidth=1080&originalType=binary&ratio=1&rotation=0&showTitle=false&size=433265&status=done&style=none&taskId=u1c11a58f-a13b-4959-be82-4cdf4652ba5&title=&width=540)
<a name="FOFLV"></a>
##### 确保进程在运行态
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665568146220-b14e5c20-efe9-4c29-93eb-6073ca8ce17c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=175&id=u84ed00fd&name=image.png&originHeight=350&originWidth=1576&originalType=binary&ratio=1&rotation=0&showTitle=false&size=409545&status=done&style=none&taskId=u84907fe9-7ae0-4a62-a5f6-a576cc53c86&title=&width=788)
<a name="sVNUi"></a>
##### 减少进程间切换
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665568251135-c418b58e-43c4-451a-b668-e5c7f634d87e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=416&id=u9824dcc6&name=image.png&originHeight=832&originWidth=1546&originalType=binary&ratio=1&rotation=0&showTitle=false&size=411160&status=done&style=none&taskId=u03335c73-61e2-4996-aeb8-4b82e9e826c&title=&width=773)
<a name="z5MLf"></a>
##### 延迟处理新连接
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665568499889-79c802d1-1367-4409-a216-fe5cfe1c6e5b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=136&id=u3f9a63d9&name=image.png&originHeight=272&originWidth=968&originalType=binary&ratio=1&rotation=0&showTitle=false&size=125443&status=done&style=none&taskId=u42686dd0-a423-49a1-96f2-d32f131c54a&title=&width=484)

**如何查看上下文切换次数？**<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665568695618-8b7c35f8-c258-4ad0-b742-c9618b436206.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=404&id=ud0783d85&name=image.png&originHeight=808&originWidth=1504&originalType=binary&ratio=1&rotation=0&showTitle=false&size=472221&status=done&style=none&taskId=u1a83374b-fc24-43fc-a94e-820a69c1441&title=&width=752)<br />**什么决定CPU时间片的大小？**<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665568817897-65a93e3f-79e6-4e2e-a263-005da1b21277.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=396&id=u977eaeaf&name=image.png&originHeight=792&originWidth=1406&originalType=binary&ratio=1&rotation=0&showTitle=false&size=720379&status=done&style=none&taskId=u182ecd24-6550-40bd-bdc4-0b2fc496890&title=&width=703)<br />**O1调度算法（CFS）**<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665568916028-617ede10-fde1-4ec9-9332-a87789000f3f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=436&id=u023ea6ae&name=image.png&originHeight=872&originWidth=1324&originalType=binary&ratio=1&rotation=0&showTitle=false&size=344218&status=done&style=none&taskId=u993ca40e-1ed5-4c60-a226-7fb99b1de67&title=&width=662)
<a name="EbB8S"></a>
##### 设置worker进程的静态优先级
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665569069818-1be1383e-4355-4926-a699-2976722d3c3f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=106&id=uaefb933a&name=image.png&originHeight=212&originWidth=1026&originalType=binary&ratio=1&rotation=0&showTitle=false&size=85467&status=done&style=none&taskId=u0d49282c-d6a5-4573-9f04-58f7ea458e9&title=&width=513)
<a name="RiUi4"></a>
#### 5.2.2 多核间的负载均衡
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665569386847-f3c7ce0b-c31c-4dd1-aa84-b405461a4168.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=292&id=ue55fb14c&name=image.png&originHeight=584&originWidth=1494&originalType=binary&ratio=1&rotation=0&showTitle=false&size=197219&status=done&style=none&taskId=uf8d74769-8cb1-4478-aadf-a1e378ed0e2&title=&width=747)<br />使用linux内核3.9以上，打开reuseport，提高性能。
<a name="Fq95p"></a>
##### 多队列网卡对多核CPU的优化（RSS、RPS、RFS）
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665569505437-aab42b6e-0a5b-405f-951d-a0462dda6cb7.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=311&id=u0e2a6ab0&name=image.png&originHeight=622&originWidth=1642&originalType=binary&ratio=1&rotation=0&showTitle=false&size=223631&status=done&style=none&taskId=ueffc01f5-25a2-45ef-93fa-e13a085b4fc&title=&width=821)
<a name="DcfqQ"></a>
##### 绑定worker到指定CPU，提升CPU的缓存利用率
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665569695267-129a727e-6efd-48ed-9a63-b5198cfc0c3d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=316&id=u94d5911e&name=image.png&originHeight=632&originWidth=882&originalType=binary&ratio=1&rotation=0&showTitle=false&size=239188&status=done&style=none&taskId=u6179efcf-5afe-4f0f-9499-1f118ed1a22&title=&width=441)<br />worker_cpu_affinity:<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665569882146-19716192-e49b-4086-81bf-a2513999df00.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=103&id=u5dac64a8&name=image.png&originHeight=206&originWidth=1070&originalType=binary&ratio=1&rotation=0&showTitle=false&size=73402&status=done&style=none&taskId=udebf23c1-a041-4740-9edd-3425ab1f3e4&title=&width=535) 
<a name="ykbzr"></a>
##### NUMA架构,提升CPU访问内存的效率
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665569933093-cd4223c3-a50a-4bcc-bedb-1f36a1515edb.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=210&id=u7c39eb82&name=image.png&originHeight=420&originWidth=1360&originalType=binary&ratio=1&rotation=0&showTitle=false&size=165629&status=done&style=none&taskId=u041d307b-1dd1-4e82-bdc6-2e751e82dcf&title=&width=680)
<a name="SxLpc"></a>
### 5.3 网络效率
<a name="wnsJk"></a>
#### 5.3.1 控制TCP三次握手参数
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665572891851-7ddb4837-47a8-42cf-92ee-040b3d063439.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=757&id=ua8de3ebf&name=image.png&originHeight=1514&originWidth=1468&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1003569&status=done&style=none&taskId=u9c5232cd-154c-47d3-8cf6-7e6b9c1827e&title=&width=734)
<a name="v0hNZ"></a>
##### SYN_SENT状态
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665573180928-6c85d09f-7636-4701-a0e6-e67c43765826.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=242&id=ua4048796&name=image.png&originHeight=484&originWidth=1238&originalType=binary&ratio=1&rotation=0&showTitle=false&size=200867&status=done&style=none&taskId=ued298f8f-3cfb-4979-8148-0ff07372837&title=&width=619)
<a name="vb4Uy"></a>
##### 主动建立连接时应用层超时时间
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665573315483-c0baeb38-a265-4621-8444-b2655ed72571.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=243&id=u7074cca6&name=image.png&originHeight=486&originWidth=950&originalType=binary&ratio=1&rotation=0&showTitle=false&size=224138&status=done&style=none&taskId=u4e1a110d-4ba7-495a-abc2-0aa65df9779&title=&width=475)
<a name="C6VgR"></a>
##### SYN_RECVD状态
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665573377617-0fb3b4fc-2e54-434a-a7db-c2ecc0332d45.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=228&id=ua4500755&name=image.png&originHeight=456&originWidth=1134&originalType=binary&ratio=1&rotation=0&showTitle=false&size=216583&status=done&style=none&taskId=uda2fc3e8-e3fe-40ee-a1be-041ffa555d8&title=&width=567)
<a name="S2e93"></a>
##### Linux服务器处理三次握手
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665573484062-981b4704-e99e-42e6-8ceb-9a3f015ed55f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=419&id=u3dc96abd&name=image.png&originHeight=838&originWidth=1364&originalType=binary&ratio=1&rotation=0&showTitle=false&size=280425&status=done&style=none&taskId=u0533261f-136b-46db-bcc4-2682023967f&title=&width=682)
<a name="joAtI"></a>
#### 5.3.2 建立TCP连接的优化
<a name="BJXA4"></a>
##### 如何应对SYN攻击
<a name="lGj72"></a>
#### ![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665573692897-3ac28334-0de6-480f-8045-7b9979ca9acd.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=300&id=u4415660f&name=image.png&originHeight=600&originWidth=1360&originalType=binary&ratio=1&rotation=0&showTitle=false&size=369472&status=done&style=none&taskId=ue1398946-14fa-47a1-9882-b031a5304a6&title=&width=680)
<a name="JASNh"></a>
###### 设置tcp_syncookies
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665573995561-c620fe34-26d7-4cb3-9400-6ef8c8ab75ba.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=401&id=u90e6683b&name=image.png&originHeight=802&originWidth=1532&originalType=binary&ratio=1&rotation=0&showTitle=false&size=446952&status=done&style=none&taskId=u5255fe23-df33-4759-a7c8-92759e590f3&title=&width=766)
<a name="EiK5C"></a>
###### 设置句柄数上线
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665574123326-e291d970-0e64-4d99-8cab-ba01ed51bc61.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=386&id=u5e5c575a&name=image.png&originHeight=772&originWidth=876&originalType=binary&ratio=1&rotation=0&showTitle=false&size=235781&status=done&style=none&taskId=u833c2b44-de9a-450d-90ca-6c96e46d597&title=&width=438) 
<a name="j1iH2"></a>
###### 设置worker进程最大连接数量
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665574289527-2984098a-be74-4aff-8deb-1583c9f8d955.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=156&id=u5fb15e7e&name=image.png&originHeight=312&originWidth=894&originalType=binary&ratio=1&rotation=0&showTitle=false&size=107515&status=done&style=none&taskId=u3adb9865-2881-473b-abea-6fd28fcf558&title=&width=447)
<a name="JUs0q"></a>
###### 设置两个队列的长度
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665574378708-9d3267df-8d1c-481b-87a3-c1d80b1a7dcc.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=291&id=uedd4f45a&name=image.png&originHeight=582&originWidth=1336&originalType=binary&ratio=1&rotation=0&showTitle=false&size=220010&status=done&style=none&taskId=u4e3cc477-ebc9-4490-b887-43bf46d1d14&title=&width=668)
<a name="D5KDY"></a>
###### 开启TCP Fast Open
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665574524732-9a68c3c2-c534-499e-bcfe-94de57655085.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=334&id=uc28045ca&name=image.png&originHeight=668&originWidth=1100&originalType=binary&ratio=1&rotation=0&showTitle=false&size=204548&status=done&style=none&taskId=u6a7c4875-9871-4c36-b52b-9843fa62b4d&title=&width=550)<br />说明：正常TCP三次握手需要等待server返回syn+ack后，发送ack+http请求，fast open tcp是第一次建立连接后，client保存cookie,第二次直接带上cookie请求sever，减少前面2次握手。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665574665846-9eb9e3b8-cebf-4f39-ad20-a5b689970a31.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=334&id=u494f899f&name=image.png&originHeight=668&originWidth=1334&originalType=binary&ratio=1&rotation=0&showTitle=false&size=306391&status=done&style=none&taskId=u512904a8-7a3e-46e1-afa7-ecf863b7ebb&title=&width=667)
<a name="FLhdA"></a>
#### 5.3.3 传输数据阶段滑动窗口和读写缓冲区
<a name="bEeYj"></a>
##### 滑动窗口
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665574907216-e8866dbb-d169-4141-9e59-968c5c61b053.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=437&id=u90631b0e&name=image.png&originHeight=874&originWidth=1370&originalType=binary&ratio=1&rotation=0&showTitle=false&size=568305&status=done&style=none&taskId=u0c4fac4d-f809-4821-a128-d79912915a0&title=&width=685)<br />通告窗口？<br />收到对方的syn后，在回复ack时需要告诉请求方我还有多大的空间接收你的内容，这就是通告窗口。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665575226394-05081d6d-854e-40c1-8e26-13493f4e7bd3.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=408&id=u4bd06efd&name=image.png&originHeight=816&originWidth=1248&originalType=binary&ratio=1&rotation=0&showTitle=false&size=544169&status=done&style=none&taskId=u248a094d-dfd5-450e-9e04-db56f68de59&title=&width=624)
<a name="UcXrL"></a>
##### 发送TCP消息
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665575283120-d0926011-0866-4595-9a28-2cab11aa5143.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=468&id=u1b7b3cb7&name=image.png&originHeight=936&originWidth=1010&originalType=binary&ratio=1&rotation=0&showTitle=false&size=366528&status=done&style=none&taskId=u492c9f4f-28d9-41cf-9bad-a293f081090&title=&width=505)
<a name="iowqn"></a>
##### TCP接收消息
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665575583401-ad749ab1-455e-4ff0-acd3-6fbdb2c05ab7.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=434&id=u01445075&name=image.png&originHeight=868&originWidth=1148&originalType=binary&ratio=1&rotation=0&showTitle=false&size=459778&status=done&style=none&taskId=u8c39a1e6-af28-457e-a59f-af2bb0c29a2&title=&width=574)
<a name="r8kQA"></a>
##### TCP接收消息发生CS（进程间切换）
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665575927288-cc46c14a-1d3f-4c96-a282-fe9ae6f3002f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=451&id=uc1fc9ca5&name=image.png&originHeight=902&originWidth=1308&originalType=binary&ratio=1&rotation=0&showTitle=false&size=535393&status=done&style=none&taskId=ubf55069a-de33-4422-bac8-a4bfc6e20f1&title=&width=654)
<a name="mQZud"></a>
##### TCP消息接收时新报文到达
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665575998079-1a02e585-da26-49e3-bebc-93985eff2e7f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=455&id=ue8169b09&name=image.png&originHeight=910&originWidth=1090&originalType=binary&ratio=1&rotation=0&showTitle=false&size=485925&status=done&style=none&taskId=u1fb0c6fb-9e6b-4d81-bb3e-e1e583ebe6b&title=&width=545)
<a name="EwQrC"></a>
##### Nginx的超时指令和滑动窗口
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665576092795-7895f5b3-2b72-48aa-a92c-362964eb3e40.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=446&id=u6ce1b17c&name=image.png&originHeight=892&originWidth=1692&originalType=binary&ratio=1&rotation=0&showTitle=false&size=334927&status=done&style=none&taskId=u68a04f00-eabf-4eae-a1a7-ebee6bcac62&title=&width=846)
<a name="EFXML"></a>
##### TCP传输时的丢包重试
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665576180403-fc9c4180-2afd-4115-803d-679134e2408e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=211&id=ue8d4ab02&name=image.png&originHeight=422&originWidth=1330&originalType=binary&ratio=1&rotation=0&showTitle=false&size=211831&status=done&style=none&taskId=uf006ec0d-9d48-44be-84bf-ec9ed740449&title=&width=665)
<a name="TEifo"></a>
#### 5.3.4 优化缓冲区和传输效率
<a name="Wklfv"></a>
##### TCP缓冲区
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665576451547-b1d4f4fc-68e6-4ac4-a8d6-4a6a0fa54044.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=309&id=ua32101e3&name=image.png&originHeight=618&originWidth=1120&originalType=binary&ratio=1&rotation=0&showTitle=false&size=341842&status=done&style=none&taskId=ua973404f-f492-4f80-b09b-c3bf5c35927&title=&width=560)
<a name="T0lPz"></a>
##### TCP调整接收窗口和应用缓存
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665576590300-c81b5820-a3ec-4a51-b7fc-2ba54c33d68f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=97&id=u415ebc4f&name=image.png&originHeight=194&originWidth=708&originalType=binary&ratio=1&rotation=0&showTitle=false&size=56322&status=done&style=none&taskId=u6b441f9f-6838-40bf-941e-5690b1a6dac&title=&width=354) <br />BDP=带宽*时延，吞吐量=窗口/时延<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665576720420-ef9f4166-7c22-44f8-858f-9288e85ec188.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=233&id=uc586d8a3&name=image.png&originHeight=466&originWidth=1148&originalType=binary&ratio=1&rotation=0&showTitle=false&size=99457&status=done&style=none&taskId=ucdf416bd-a190-4171-88cd-af84aa5a261&title=&width=574)
<a name="JD7Jc"></a>
##### 禁用Nagle算法？
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665576884830-4d87e43a-9e3f-496f-9c3c-09d1f9e80b55.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=465&id=ud3e7b226&name=image.png&originHeight=930&originWidth=1586&originalType=binary&ratio=1&rotation=0&showTitle=false&size=439516&status=done&style=none&taskId=u598cf7c6-cd0e-4db8-ba85-b0692ec8c05&title=&width=793)
<a name="aSVlA"></a>
##### Nginx可以避免发送小报文
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665577106075-b7372759-0f30-462d-af2d-02a4429fda41.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=74&id=u0f3fed86&name=image.png&originHeight=148&originWidth=674&originalType=binary&ratio=1&rotation=0&showTitle=false&size=58756&status=done&style=none&taskId=u1d6467a6-c3f9-4018-aab8-0cf65a0fc34&title=&width=337)
<a name="DHRm9"></a>
##### 启用CORK算法
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665577201160-40c39ab6-c8a1-466b-9fb3-5264091778d4.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=110&id=ub2a820c8&name=image.png&originHeight=220&originWidth=1104&originalType=binary&ratio=1&rotation=0&showTitle=false&size=111214&status=done&style=none&taskId=u52b04d85-8f4d-4545-b5c2-b864cfa773d&title=&width=552)
<a name="Gkvh8"></a>
#### 5.3.5 慢启动和拥塞窗口
> 滑动窗口：发送方主动限制流量
> 滑动窗口：接收方限制限制流量
> 实际流量：滑动窗口和滑动窗口的最小值

<a name="IDp3W"></a>
##### 拥塞窗口
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665642605271-bc379528-1d1b-4487-8106-87174cbd48f2.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=374&id=u13e2fdca&name=image.png&originHeight=748&originWidth=1322&originalType=binary&ratio=1&rotation=0&showTitle=false&size=375483&status=done&style=none&taskId=uf00ede79-a801-49a2-b2bf-e38fea8ac86&title=&width=661)
<a name="MhSFL"></a>
##### RTT和RTO
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665642828191-6fb306eb-8dcf-4692-b22a-21556d57295a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=273&id=u17046483&name=image.png&originHeight=546&originWidth=1434&originalType=binary&ratio=1&rotation=0&showTitle=false&size=227361&status=done&style=none&taskId=u3d006780-ff79-4a05-adf4-0dd034adf1e&title=&width=717) 
<a name="BNrgL"></a>
#### 5.3.6 TCP协议的keepalive功能
<a name="SiVez"></a>
##### 应用场景
检查实际断连的连接<br />用于维持和客户端的防火墙有活跃的网络包
<a name="wB7qP"></a>
##### 设置
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665643114125-5e3c3283-ee4c-4113-91d2-6120e93502ae.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=370&id=u5dd73189&name=image.png&originHeight=740&originWidth=1208&originalType=binary&ratio=1&rotation=0&showTitle=false&size=223558&status=done&style=none&taskId=uf749ead6-ae02-4fda-9d3e-054d98dc7ab&title=&width=604)
<a name="evtP9"></a>
#### 5.3.7 减少关闭连接时的time_wait端口数量
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665643408320-4b4e56e3-ca2b-43cd-b015-4f8d1eb5d62d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=166&id=u593fbb59&name=image.png&originHeight=332&originWidth=812&originalType=binary&ratio=1&rotation=0&showTitle=false&size=201813&status=done&style=none&taskId=ua09ebc07-d4e4-4577-8c84-cb8d388e248&title=&width=406)
<a name="V2IhX"></a>
##### 服务器被动关闭连接端的状态
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665643547124-c7b30085-e22c-492a-9dea-963acbfd5020.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=158&id=u41305f73&name=image.png&originHeight=316&originWidth=1328&originalType=binary&ratio=1&rotation=0&showTitle=false&size=201774&status=done&style=none&taskId=u3d45a45e-e3f0-4d11-bc01-21217c3ae15&title=&width=664)
<a name="tHOja"></a>
##### 服务器主动关闭连接端的状态
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665643623773-ac5931c8-4818-4c38-997a-c6ea39d39d59.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=212&id=u5c5acdfb&name=image.png&originHeight=424&originWidth=1068&originalType=binary&ratio=1&rotation=0&showTitle=false&size=198403&status=done&style=none&taskId=u575a4eda-d00d-4bdf-8215-cc3b171694a&title=&width=534)
<a name="hiSuH"></a>
##### 优化time_wait
time_wait状态过短或者不存在会怎么样？<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665643797100-6ec8b179-d617-40fe-a3e7-73f01cce3ad2.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=367&id=u69df1954&name=image.png&originHeight=734&originWidth=1614&originalType=binary&ratio=1&rotation=0&showTitle=false&size=388904&status=done&style=none&taskId=u0b75916d-2edf-4787-9c7c-9e157e092ac&title=&width=807)
<a name="sQU99"></a>
###### tcp_tw_reuse
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665643979951-88ed728b-48be-4f7c-b480-f3adef6b0fd9.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=396&id=u568c903f&name=image.png&originHeight=792&originWidth=1702&originalType=binary&ratio=1&rotation=0&showTitle=false&size=428064&status=done&style=none&taskId=u17ddf045-6e53-4d43-bf78-a3e719a054c&title=&width=851) ![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665644078812-ea5f5606-a7b2-4f24-ae2c-c2fb0d5f4c70.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=284&id=u5fc9ded7&name=image.png&originHeight=568&originWidth=1646&originalType=binary&ratio=1&rotation=0&showTitle=false&size=354908&status=done&style=none&taskId=u675babd1-52e8-4e76-8d2a-e668b9805b9&title=&width=823)
<a name="OZ8tQ"></a>
#### 5.3.8 lingering_close延迟关闭TCP连接
<a name="rPfcz"></a>
##### lingering_close延迟的意义？
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665644286222-aaf21db8-fd5a-4785-99d5-8c313f85df5c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=104&id=ub5e4028c&name=image.png&originHeight=208&originWidth=1454&originalType=binary&ratio=1&rotation=0&showTitle=false&size=240329&status=done&style=none&taskId=u000f6c46-f0d3-4d51-b767-2a428ebc623&title=&width=727) 
<a name="QkDGx"></a>
##### lingering配置指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665644430919-662881db-538d-41f7-be29-99ba6f51e869.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=448&id=u4f3baab7&name=image.png&originHeight=896&originWidth=1514&originalType=binary&ratio=1&rotation=0&showTitle=false&size=519312&status=done&style=none&taskId=u891b0b25-7f69-469f-ba85-0dc0e319685&title=&width=757)
<a name="kJAj0"></a>
##### 以RTS代替正常的四次握手关闭连接
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665644786555-a3beee31-f4da-4a4e-97e6-65fac8ecb5e1.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=171&id=u57245eea&name=image.png&originHeight=342&originWidth=1444&originalType=binary&ratio=1&rotation=0&showTitle=false&size=211101&status=done&style=none&taskId=u7f36cbe5-64a5-4351-a591-222b824d299&title=&width=722) 
<a name="lakzw"></a>
#### 5.3.9 应用层协议优化
<a name="XOIMw"></a>
##### TLS/SSL优化握手性能
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665644943741-67a0c258-7868-41c8-9e2f-625e1a50a6d4.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=360&id=ueba71844&name=image.png&originHeight=720&originWidth=1612&originalType=binary&ratio=1&rotation=0&showTitle=false&size=428311&status=done&style=none&taskId=u47ce4d4e-f54e-422a-ada3-d7c665be92b&title=&width=806)
<a name="JflfG"></a>
##### TLS/SSL中的会话票证tickets
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665645052286-3e789f5a-c416-4c36-8309-adbf39b99343.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=383&id=uf5bde46f&name=image.png&originHeight=766&originWidth=1574&originalType=binary&ratio=1&rotation=0&showTitle=false&size=449523&status=done&style=none&taskId=u5a7da1f5-ee71-4a23-9368-2cbd3e1ab77&title=&width=787)
<a name="m5Rvs"></a>
##### HTTP长链接
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665645246020-ec0416f0-d208-44ca-90c1-e0ac88c4fdfc.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=407&id=u038f44a1&name=image.png&originHeight=814&originWidth=1566&originalType=binary&ratio=1&rotation=0&showTitle=false&size=300106&status=done&style=none&taskId=u680fd490-69d7-4fd9-8d61-f0fe00a8d8a&title=&width=783)
<a name="UbjTz"></a>
##### gzip压缩模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665645311873-719d9c79-2769-4d69-93f8-cac8d7604e68.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=278&id=ub292c1e2&name=image.png&originHeight=556&originWidth=1482&originalType=binary&ratio=1&rotation=0&showTitle=false&size=203695&status=done&style=none&taskId=ufac32252-5373-426c-b67b-4eeb47e5051&title=&width=741)<br />压缩哪些请求的响应？<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665645381741-0bab89f7-f2c3-4202-92c8-3b94e157c15d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=413&id=ud4a94dc1&name=image.png&originHeight=826&originWidth=1268&originalType=binary&ratio=1&rotation=0&showTitle=false&size=305888&status=done&style=none&taskId=uc7b298c2-c09a-4ef2-adcf-891afbd2f05&title=&width=634)<br />是否压缩下游的响应？<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665645446001-8c33d868-781f-4b8b-bbbb-0a57995c62ac.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=445&id=u7c396a42&name=image.png&originHeight=890&originWidth=1626&originalType=binary&ratio=1&rotation=0&showTitle=false&size=571587&status=done&style=none&taskId=u246f8843-319d-486a-aade-a63618c4faa&title=&width=813)<br />其他压缩参数：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665645553029-24fbf184-a126-4254-a74e-536ae9e35c4e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=328&id=u1aef315c&name=image.png&originHeight=656&originWidth=1084&originalType=binary&ratio=1&rotation=0&showTitle=false&size=235240&status=done&style=none&taskId=u751ebc74-3a9e-4e63-ac61-5e7fdf0d0a1&title=&width=542)
<a name="QV4GL"></a>
##### 升级更高效的http2.0协议
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665645652160-884f0b9f-d31a-4623-92a3-c3c1ec2bfb00.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=84&id=u7b33da7c&name=image.png&originHeight=168&originWidth=432&originalType=binary&ratio=1&rotation=0&showTitle=false&size=61751&status=done&style=none&taskId=u64044983-a026-4279-8ceb-dcbd70613da&title=&width=216)

<a name="zv0hw"></a>
### 5.4 磁盘IO效率
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665645765864-bddf9cb9-e8e6-4f67-8c1b-3e602b7c9046.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=412&id=u8f77c124&name=image.png&originHeight=824&originWidth=1282&originalType=binary&ratio=1&rotation=0&showTitle=false&size=417159&status=done&style=none&taskId=u9219e54b-f10e-4f75-b014-910669f68e5&title=&width=641)
<a name="tYeCU"></a>
#### 5.4.1 大致优化方向
<a name="piNc4"></a>
##### 减少磁盘IO
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665645894781-ba1c5f2e-ff20-473a-9cbb-368244918581.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=374&id=u0ac1e57d&name=image.png&originHeight=748&originWidth=1404&originalType=binary&ratio=1&rotation=0&showTitle=false&size=292876&status=done&style=none&taskId=u0acd40ee-311a-4019-95c8-05ae2d23eda&title=&width=702)
<a name="AkAkg"></a>
##### 直接IO绕开磁盘高速缓存
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665646024159-de57c07c-cafb-44ca-8245-273a42d89e87.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=215&id=ubf28152f&name=image.png&originHeight=430&originWidth=1540&originalType=binary&ratio=1&rotation=0&showTitle=false&size=184142&status=done&style=none&taskId=uc89d304f-f6ac-4719-9904-9544f605fef&title=&width=770)<br />**直接IO适用于大文件:**<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665646145200-1e11ee68-9baf-4242-9c19-332fcdf61d9d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=281&id=ub09f7399&name=image.png&originHeight=562&originWidth=1514&originalType=binary&ratio=1&rotation=0&showTitle=false&size=262896&status=done&style=none&taskId=uf0b29fb3-aa22-4cc6-b22f-c4a1916c3d9&title=&width=757)
<a name="TNCFZ"></a>
##### 异步IO
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665646282152-2364bad1-7051-4ee6-b9c6-ad45bd3125aa.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=227&id=u6d78c828&name=image.png&originHeight=454&originWidth=1522&originalType=binary&ratio=1&rotation=0&showTitle=false&size=185825&status=done&style=none&taskId=ud6a74288-f4d0-440b-bfe5-f28394b065f&title=&width=761)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665646349049-43b17e75-b00d-46ff-9189-e7b0e7ef1d16.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=213&id=ubf8a3e2c&name=image.png&originHeight=426&originWidth=1318&originalType=binary&ratio=1&rotation=0&showTitle=false&size=138708&status=done&style=none&taskId=u3221bdcc-38d0-4caa-bdb0-4e8782dfbb3&title=&width=659)
<a name="qqfve"></a>
##### 异步读IO线程池
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665646441603-7c030ee1-1bad-4724-95f9-d39c7870e99e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=337&id=u23e906a5&name=image.png&originHeight=674&originWidth=1396&originalType=binary&ratio=1&rotation=0&showTitle=false&size=207827&status=done&style=none&taskId=ua0dce056-1356-447d-b8d2-cc7f234287f&title=&width=698)<br />做静态资源服务读取文件时使用异步读IO线程池：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665646643397-254a60c6-d209-4cb6-a2bf-1ba1774fae2d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=87&id=u9bba1ee0&name=image.png&originHeight=174&originWidth=1272&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113405&status=done&style=none&taskId=ucd315d49-3e0a-4475-9c49-bde906ebb29&title=&width=636)
<a name="KbX9z"></a>
##### 异步IO缓存
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665646721659-92613694-20a3-4e31-878f-739494d49f32.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=148&id=ucff39d20&name=image.png&originHeight=296&originWidth=932&originalType=binary&ratio=1&rotation=0&showTitle=false&size=141145&status=done&style=none&taskId=ub5ffacc0-c301-4657-987f-d203cae8bd6&title=&width=466) 
<a name="KxoHr"></a>
#### 5.4.2 减少磁盘读写次数
<a name="Y2V2G"></a>
##### empty_gif模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665648648694-5179cc73-d6af-44e0-aac3-2fa6370b6708.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=453&id=u623e638c&name=image.png&originHeight=906&originWidth=1674&originalType=binary&ratio=1&rotation=0&showTitle=false&size=672930&status=done&style=none&taskId=u89aed00e-fb15-42dc-bb61-0765e800983&title=&width=837)
<a name="HNnqN"></a>
##### access日志的压缩
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665648804165-4d0902c8-1f7f-4806-92ec-4054e97c712d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=241&id=uf9b4cbd7&name=image.png&originHeight=482&originWidth=1650&originalType=binary&ratio=1&rotation=0&showTitle=false&size=224367&status=done&style=none&taskId=u7644119d-2763-4746-834e-35b05da0b14&title=&width=825)
<a name="sqoO3"></a>
##### error.log日志输出到内存
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665648930207-7347ab8c-ccf8-4f7c-90cd-eeea19abbc9e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=402&id=ub432bcea&name=image.png&originHeight=804&originWidth=1764&originalType=binary&ratio=1&rotation=0&showTitle=false&size=434869&status=done&style=none&taskId=udf4dd588-51dc-4f8c-a67a-7fedba6595d&title=&width=882)
<a name="sPHDA"></a>
##### syslog协议
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665649144537-cdbe7fd5-3b22-49a2-b4f8-172b9a69b1eb.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=431&id=u4df04574&name=image.png&originHeight=862&originWidth=1524&originalType=binary&ratio=1&rotation=0&showTitle=false&size=312780&status=done&style=none&taskId=uf3c633c7-76a5-4e69-9744-8129c178b18&title=&width=762)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665649305505-b37fcc29-3ab7-4b1c-96ed-82ddd625041d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=400&id=u4cfc407a&name=image.png&originHeight=800&originWidth=1604&originalType=binary&ratio=1&rotation=0&showTitle=false&size=299382&status=done&style=none&taskId=u8a5814b6-3bdf-47a7-8a0c-9c7b183361b&title=&width=802)<br />rsyslog与nginx:<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665649363503-07880b08-ccb8-4d8c-b923-07a8d1efadbd.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=141&id=u1cc6065d&name=image.png&originHeight=282&originWidth=1204&originalType=binary&ratio=1&rotation=0&showTitle=false&size=89139&status=done&style=none&taskId=uf14ed5e7-55e3-481a-a175-eca06e6321d&title=&width=602)
<a name="H14Pd"></a>
#### 5.4.3 零拷贝与gzip_static模块
<a name="vzvIB"></a>
##### sendfile 零拷贝提升性能 
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665649637078-b981e979-32eb-4117-bd0b-12f29c791e78.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=365&id=ue76cc631&name=image.png&originHeight=730&originWidth=1712&originalType=binary&ratio=1&rotation=0&showTitle=false&size=368046&status=done&style=none&taskId=u96d96347-28fb-43a7-a4f3-405f161331f&title=&width=856)<br />注意：直接IO会自动禁用sendfile<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665649864976-1c3f5d76-0ae4-4046-84ac-9d63810ab253.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=162&id=ufdb351da&name=image.png&originHeight=324&originWidth=752&originalType=binary&ratio=1&rotation=0&showTitle=false&size=91794&status=done&style=none&taskId=u82fe898e-83d2-426c-bfa2-56040c8fa68&title=&width=376)
<a name="lGf0Q"></a>
##### gzip_static模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665649918362-bd301e2d-755c-4a4d-9593-ce13562356ea.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=255&id=ua0c6a394&name=image.png&originHeight=510&originWidth=1420&originalType=binary&ratio=1&rotation=0&showTitle=false&size=246498&status=done&style=none&taskId=u28f8a6e9-36bd-483f-a9e2-707cb7fc210&title=&width=710)
<a name="qGjWI"></a>
##### gunzip模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665650078388-db5db7a9-c3de-4be7-8ba6-67183741fee3.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=296&id=u32982092&name=image.png&originHeight=592&originWidth=1426&originalType=binary&ratio=1&rotation=0&showTitle=false&size=329438&status=done&style=none&taskId=u3ef691c7-5b8e-45c5-8c17-1ee3272935c&title=&width=713)
<a name="mE7Ro"></a>
### 5.5 监控分析Nginx运行状态
<a name="gPktO"></a>
#### 5.5.1 使用gperftools定位Nginx性能问题
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665650896255-294cf2e2-7dcd-4798-9e97-1fcdcebfe8e9.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=490&id=HNDDF&name=image.png&originHeight=980&originWidth=1634&originalType=binary&ratio=1&rotation=0&showTitle=false&size=481647&status=done&style=none&taskId=uf91fd995-2426-4d0b-9624-16748ac27fd&title=&width=817)<br />**文本展示说明：**<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665650967787-d4364abb-1a30-4dd3-ab38-fe6fdc0f5a4f.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=401&id=ulceg&name=image.png&originHeight=802&originWidth=1316&originalType=binary&ratio=1&rotation=0&showTitle=false&size=606341&status=done&style=none&taskId=ub5cb3019-b0bd-48b6-bff4-9af33932721&title=&width=658)
<a name="w2ssW"></a>
#### 5.5.2 使用stub_status模块监控Nginx状态
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665651616313-676f929a-a734-4497-a85a-7294a77127d6.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=387&id=u94bbd38d&name=image.png&originHeight=774&originWidth=1806&originalType=binary&ratio=1&rotation=0&showTitle=false&size=479709&status=done&style=none&taskId=ub65aa491-1bfc-4432-b8b7-072e1175459&title=&width=903)
<a name="sKlvl"></a>
##### stub_status模块监控项
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665651688239-c68b6e2a-4226-4c67-a853-4c31b2158e71.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=494&id=ub81baf26&name=image.png&originHeight=988&originWidth=1884&originalType=binary&ratio=1&rotation=0&showTitle=false&size=708631&status=done&style=none&taskId=ud2b3a0bf-1b94-4452-81cf-d7074bd70fd&title=&width=942)
<a name="lphwY"></a>
## 六、从源码视角深度使用Nginx和OpenResty
<a name="IuUt4"></a>
### 6.1 Nginx与第三方模块的关联关系
<a name="EyG9J"></a>
#### 6.1.1 第三方模块源代码的快速阅读方法
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665728834353-4179ccab-c4ea-4994-a77d-0c1023186c09.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=453&id=u25a72d09&name=image.png&originHeight=906&originWidth=1490&originalType=binary&ratio=1&rotation=0&showTitle=false&size=610678&status=done&style=none&taskId=u1b026bf5-48d2-470a-a9e9-b8b2569fbd9&title=&width=745)
<a name="ElokD"></a>
##### config结构
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665728912323-c667c938-a9b8-4f35-9000-85f6f32e887b.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=392&id=u87389fcd&name=image.png&originHeight=784&originWidth=1582&originalType=binary&ratio=1&rotation=0&showTitle=false&size=505571&status=done&style=none&taskId=u921caa4d-d9ea-4726-8de4-df13588d508&title=&width=791)
<a name="Vfj15"></a>
##### configure脚本分析
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665729010905-e539e3b2-94e9-4a35-8c2a-64fe2354bc57.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=280&id=u781cb194&name=image.png&originHeight=560&originWidth=1602&originalType=binary&ratio=1&rotation=0&showTitle=false&size=399451&status=done&style=none&taskId=ub24d7063-13f6-47f8-96e8-6c6fa5c90af&title=&width=801)
<a name="NqCXE"></a>
##### configure执行结果
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665729112339-5f471462-6800-474a-8112-447ea6afc407.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=457&id=u490ac203&name=image.png&originHeight=914&originWidth=1420&originalType=binary&ratio=1&rotation=0&showTitle=false&size=701462&status=done&style=none&taskId=ub1475f14-a6b8-4601-82d7-3f4adeabea7&title=&width=710)<br />（1）configure概要，使用了哪些库或者功能<br />（2）一些重要文件的路径
<a name="LyYYR"></a>
#### 6.1.2 Nginx启动流程
<a name="k9ZYX"></a>
##### HTTP第三方模块初始化
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665730094569-110e13bb-bd35-42e0-b349-46cb52702248.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=523&id=u6675e141&name=image.png&originHeight=1046&originWidth=1658&originalType=binary&ratio=1&rotation=0&showTitle=false&size=651369&status=done&style=none&taskId=u6d345397-c9f1-46ff-b508-803c1857439&title=&width=829)
<a name="V1B8u"></a>
##### HTTP模块的11个阶段：初始化
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665730299506-8f2bf1bc-ecb8-4a1c-a357-8cc9586c1d61.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=457&id=uff177a21&name=image.png&originHeight=914&originWidth=1908&originalType=binary&ratio=1&rotation=0&showTitle=false&size=610973&status=done&style=none&taskId=uad823767-5202-42b9-922e-6ebccdf636f&title=&width=954)
<a name="lvc1Q"></a>
##### 添加模块到11个阶段的两种常用方式
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665730554667-3580b201-8e4f-42e7-80ad-3b4f5f7502d8.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=433&id=ua40d8531&name=image.png&originHeight=866&originWidth=1850&originalType=binary&ratio=1&rotation=0&showTitle=false&size=603571&status=done&style=none&taskId=ud9acd923-0fc3-495f-8fa0-490ce4fb9d0&title=&width=925)
<a name="HydnB"></a>
##### 过滤模块的单链表
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665730636551-a79e056a-bf06-4691-b112-e713d90e2a11.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=426&id=u27a86832&name=image.png&originHeight=852&originWidth=2164&originalType=binary&ratio=1&rotation=0&showTitle=false&size=699664&status=done&style=none&taskId=ue0f32fb5-9840-47b1-a096-26103ef379a&title=&width=1082)
<a name="fozTC"></a>
##### 添加过滤模块的方式
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665730810034-2bb220c3-cf22-4baf-8985-773a62073c62.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=522&id=u924c0681&name=image.png&originHeight=1044&originWidth=1646&originalType=binary&ratio=1&rotation=0&showTitle=false&size=729318&status=done&style=none&taskId=u3ffc5341-3bf3-462d-bff5-6df8f9c6b48&title=&width=823) 
<a name="uBHrT"></a>
#### 6.1.3 Rewrite脚本
<a name="EU3H7"></a>
##### 协程与Rewrite脚本
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665731140260-83dda82b-c6db-4952-8f3f-a52bb84d94e4.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=438&id=ue74500e8&name=image.png&originHeight=876&originWidth=876&originalType=binary&ratio=1&rotation=0&showTitle=false&size=200773&status=done&style=none&taskId=u46223dc5-a1c3-4dd1-a5ae-0f31709f1e6&title=&width=438)
<a name="EI1Sj"></a>
##### Rewrite脚本设置变量
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665731208402-77f48aed-692d-45b6-92c9-0fa698fba7c3.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=488&id=ueb8ec321&name=image.png&originHeight=976&originWidth=1846&originalType=binary&ratio=1&rotation=0&showTitle=false&size=416536&status=done&style=none&taskId=uc0c26f39-1c36-4de4-a085-7531ccf8f82&title=&width=923)
<a name="hDEBI"></a>
##### 脚本式编程：指令的实现
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665731334804-e493485f-b23e-4282-aa03-3d2e30652fac.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=184&id=u2456e1fc&name=image.png&originHeight=368&originWidth=1644&originalType=binary&ratio=1&rotation=0&showTitle=false&size=186768&status=done&style=none&taskId=u40c8ea9e-6d48-4eda-8dce-f1744745490&title=&width=822)
<a name="wY6fC"></a>
#### 6.1.4 if指令
<a name="zId6l"></a>
##### 当if指令块连续出现时
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665731399077-9f532d43-15ab-4664-b64c-417e60d35236.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=400&id=ud0a5fb62&name=image.png&originHeight=800&originWidth=1644&originalType=binary&ratio=1&rotation=0&showTitle=false&size=503978&status=done&style=none&taskId=u1cd78372-0506-4389-a6af-bae153b228a&title=&width=822)<br />说明：当if指令连续出现时，最后一个if为真的模块将一直影响到该模块结束。
<a name="QYwaE"></a>
##### if指令出现问题的根本原因
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665731898263-fb473bf9-1f1a-4321-9ad7-a720fab75669.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=354&id=ue32d4d58&name=image.png&originHeight=708&originWidth=1740&originalType=binary&ratio=1&rotation=0&showTitle=false&size=575159&status=done&style=none&taskId=u69718f3b-74d4-4708-b1a3-5dddf5da25d&title=&width=870)
<a name="jIkDU"></a>
##### if指令的正确姿势
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665731978520-45ca96e4-bbe3-4fb6-a4b0-c2bfdfba94ee.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=242&id=ucf5448d8&name=image.png&originHeight=484&originWidth=1796&originalType=binary&ratio=1&rotation=0&showTitle=false&size=500592&status=done&style=none&taskId=u28b9615b-d8bf-4078-b6fe-23c21d3627f&title=&width=898)
<a name="WMgyH"></a>
#### 6.1.5 解读Nginx核心转储文件（coredump）
<a name="zn3Dx"></a>
##### coredump核心转储文件
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665732220758-c30580a9-f8cd-4d53-948c-36bb374ac30d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=243&id=u98fb5704&name=image.png&originHeight=486&originWidth=1338&originalType=binary&ratio=1&rotation=0&showTitle=false&size=161609&status=done&style=none&taskId=u681e53d3-faa3-4b15-bef2-1201fda9cc3&title=&width=669)
<a name="kJKyS"></a>
##### gdb调试基本命令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665732305102-b437f2fd-61d8-4168-a81a-01e875b37adf.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=461&id=u4c948e33&name=image.png&originHeight=922&originWidth=1178&originalType=binary&ratio=1&rotation=0&showTitle=false&size=271656&status=done&style=none&taskId=udb76131c-95e4-43f0-994f-ece6a5487e5&title=&width=589)
<a name="InPFJ"></a>
##### 启用多进程模式
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665732662864-9fad06e1-96e0-4a2c-8a46-40f5eae65178.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=96&id=u42c5cbf2&name=image.png&originHeight=192&originWidth=652&originalType=binary&ratio=1&rotation=0&showTitle=false&size=71478&status=done&style=none&taskId=uaef58679-0c67-48f9-a80d-b376af9397e&title=&width=326)
<a name="VySWA"></a>
##### Debug定位问题：出现错误时的应对方案
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665732755505-b80c99df-434f-4fcd-a2e5-0aea7f27893e.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=464&id=uc8e41445&name=image.png&originHeight=928&originWidth=1864&originalType=binary&ratio=1&rotation=0&showTitle=false&size=482573&status=done&style=none&taskId=u2eb8c988-beeb-4ede-9a69-a35d6c2e842&title=&width=932)
<a name="eUfen"></a>
#### 6.1.6 通过debug日志定位问题
<a name="qtXyK"></a>
##### 控制debug级别error.log日志的输出
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665732944317-5675cd4d-5252-4a7e-af87-e867f9c6609a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=236&id=u3f51e249&name=image.png&originHeight=472&originWidth=1648&originalType=binary&ratio=1&rotation=0&showTitle=false&size=268161&status=done&style=none&taskId=uaf75121e-0b86-4d9c-a2ea-24b3c28e33c&title=&width=824)
<a name="bcPOg"></a>
##### debug日志类别
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665733014541-f4d235f3-2cf2-4669-8ec0-6a01e674412a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=406&id=u2ee2845b&name=image.png&originHeight=812&originWidth=768&originalType=binary&ratio=1&rotation=0&showTitle=false&size=271335&status=done&style=none&taskId=uc0e18caf-8331-4329-8d05-d0662c6f021&title=&width=384)

<a name="Zx38O"></a>
### 6.2  OpenResty的用法
<a name="grJBS"></a>
#### 6.2.1 OpenResty概述
<a name="y0noA"></a>
##### OpenResty组成部分
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665737485616-99c18c29-b965-4b54-ac6a-2f33876a3a04.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=311&id=u220a6080&name=image.png&originHeight=622&originWidth=1824&originalType=binary&ratio=1&rotation=0&showTitle=false&size=215640&status=done&style=none&taskId=ue487464f-bb84-4a92-9882-d60978dedd3&title=&width=912)
<a name="RYytS"></a>
##### OpenResty运行机制
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665737684573-79d0e726-b960-4678-a0b5-1612b3f30d92.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=403&id=u61b72b4b&name=image.png&originHeight=806&originWidth=1782&originalType=binary&ratio=1&rotation=0&showTitle=false&size=415342&status=done&style=none&taskId=ub71edda7-f36b-4674-8268-29ae8577f56&title=&width=891)
<a name="Knql6"></a>
##### OpenResty中的SDK
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665737799121-91765152-fdab-4da7-b325-ee1bf6ffcc82.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=436&id=u9d58d817&name=image.png&originHeight=872&originWidth=960&originalType=binary&ratio=1&rotation=0&showTitle=false&size=254792&status=done&style=none&taskId=u8713e5fd-e4e5-4ac4-9395-86bf7e8f78d&title=&width=480)
<a name="gMKEa"></a>
##### OpenResty的使用要点
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665737967886-4d519b9e-0ab3-4a31-8643-46428526614c.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=446&id=u01d546f0&name=image.png&originHeight=892&originWidth=1780&originalType=binary&ratio=1&rotation=0&showTitle=false&size=829148&status=done&style=none&taskId=u60203141-db3f-4213-b02e-3821b82140a&title=&width=890) 
<a name="ZKyWo"></a>
#### 6.2.2 OpenResty中的Nginx模块
<a name="hpiPe"></a>
##### 核心模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738160571-08c9dd9f-c0a3-4fd3-ac83-d798aa51f2e7.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=426&id=uc3dbca6e&name=image.png&originHeight=852&originWidth=1816&originalType=binary&ratio=1&rotation=0&showTitle=false&size=719908&status=done&style=none&taskId=u14314523-b2e5-4b1c-bb3b-d877a93fc48&title=&width=908)
<a name="dGhV4"></a>
##### 反向代理模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738217648-4e48a980-11ed-4d90-8335-ff62e60d8b96.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=493&id=ue7e10b06&name=image.png&originHeight=986&originWidth=1804&originalType=binary&ratio=1&rotation=0&showTitle=false&size=843893&status=done&style=none&taskId=u51206997-92d2-4354-8a97-14c115d5946&title=&width=902)
<a name="CcjfN"></a>
##### 工具模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738294759-2c7c6d2b-6a08-4fb7-b893-5204af0c2887.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=498&id=u1d638330&name=image.png&originHeight=996&originWidth=1774&originalType=binary&ratio=1&rotation=0&showTitle=false&size=969750&status=done&style=none&taskId=u67eb3af6-9aa3-440e-a796-60d480a1760&title=&width=887)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738394145-5dcfa236-3abf-4380-ae9b-ca4637312b41.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=506&id=u3ed52c20&name=image.png&originHeight=1012&originWidth=1802&originalType=binary&ratio=1&rotation=0&showTitle=false&size=826557&status=done&style=none&taskId=uc73f1b1b-30aa-4b28-8504-392b7e0097e&title=&width=901)
<a name="cfCF6"></a>
#### 6.2.3 OpenResty中的Lua模块
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738571666-f5de5e62-1198-436c-8cae-e40650cb6439.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=483&id=u6fbcb56f&name=image.png&originHeight=966&originWidth=1448&originalType=binary&ratio=1&rotation=0&showTitle=false&size=553576&status=done&style=none&taskId=ua520dcd0-c6e4-4867-b5da-75874d9e29c&title=&width=724)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738600967-e28166e1-0fac-49d1-85a2-61e668f34762.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=475&id=u768b233c&name=image.png&originHeight=950&originWidth=1384&originalType=binary&ratio=1&rotation=0&showTitle=false&size=598891&status=done&style=none&taskId=u99962add-c867-4df2-8b9b-13fab831fd3&title=&width=692)![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738640430-4a8e4193-6253-4b05-ae10-09289f89b783.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=509&id=u704921eb&name=image.png&originHeight=1018&originWidth=1640&originalType=binary&ratio=1&rotation=0&showTitle=false&size=707078&status=done&style=none&taskId=u36e77f1d-d38a-4605-853b-f7836ec7338&title=&width=820)
<a name="Mj7Op"></a>
#### 6.2.4 如何在Nginx中嵌入Lua代码
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738784646-0ef66812-01f3-4ef4-be45-742971162199.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=444&id=u54eb94be&name=image.png&originHeight=888&originWidth=980&originalType=binary&ratio=1&rotation=0&showTitle=false&size=192241&status=done&style=none&taskId=u11218b2a-1c68-4965-ac31-cbb02fee0c9&title=&width=490)
<a name="ZurNs"></a>
##### Nginx启动过程中嵌入Lua代码
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738854959-2d14a2d4-2d54-4ca7-8b2c-cf136d88b241.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=263&id=u34b5f63a&name=image.png&originHeight=526&originWidth=1606&originalType=binary&ratio=1&rotation=0&showTitle=false&size=334788&status=done&style=none&taskId=u61d21170-cf20-41da-92b4-fc19a9f59c8&title=&width=803)
<a name="k3Tjx"></a>
##### 在11个HTTP阶段中嵌入Lua代码
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665738973238-68a2bac3-20bb-488f-8f18-df3d1c07a399.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=460&id=ucc29bdf8&name=image.png&originHeight=920&originWidth=1748&originalType=binary&ratio=1&rotation=0&showTitle=false&size=840429&status=done&style=none&taskId=u585c69ef-cc69-4420-baf4-932d282a5e9&title=&width=874)
<a name="w9AqS"></a>
##### 控制rewrite/access是否延迟执行Lua代码
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665739138744-9960037a-4104-49c4-af1c-e4479b77b71d.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=282&id=u0bde7a7f&name=image.png&originHeight=564&originWidth=1352&originalType=binary&ratio=1&rotation=0&showTitle=false&size=281961&status=done&style=none&taskId=ue498546c-8c66-4e6e-942c-8b356305c17&title=&width=676)
<a name="HvYze"></a>
##### Http反向代理流程嵌入Lua代码（balancer_by_lua）
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665739259072-f1ef83de-41b4-47e2-aa54-e3aa5aae05aa.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=456&id=u9bbb3c28&name=image.png&originHeight=912&originWidth=1650&originalType=binary&ratio=1&rotation=0&showTitle=false&size=587841&status=done&style=none&taskId=u56250dbe-f7f9-4c30-a67b-b047a741f10&title=&width=825)
<a name="LDwUQ"></a>
##### Http反向代理收到响应-加工响应内容
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665739361359-255d6726-a9a4-4d20-b78c-1a182b310e30.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=427&id=u2f3dcdb7&name=image.png&originHeight=854&originWidth=1584&originalType=binary&ratio=1&rotation=0&showTitle=false&size=703823&status=done&style=none&taskId=u8fd9c67c-12f1-4bd7-9d19-de2e3fc3980&title=&width=792)
<a name="yHwtP"></a>
##### 在负载均衡和过滤响应时嵌入Lua代码
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665739432885-c8177d00-a6d4-4e61-b886-bb01fe2e4767.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=383&id=u457882b5&name=image.png&originHeight=766&originWidth=1772&originalType=binary&ratio=1&rotation=0&showTitle=false&size=705956&status=done&style=none&taskId=u0933cada-668b-446d-8ba1-3c861bdaddf&title=&width=886)
<a name="x4HJm"></a>
##### 在OpenSSL处理SSL协议时嵌入Lua代码
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665739493785-9f30ebd4-c7ee-46d7-8ffc-dd5eba5c51f9.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=386&id=uc1944bf8&name=image.png&originHeight=772&originWidth=1550&originalType=binary&ratio=1&rotation=0&showTitle=false&size=469118&status=done&style=none&taskId=ud1dfe3c0-4e30-4893-b8ab-16db9243834&title=&width=775) 
<a name="eZZoI"></a>
##### 在Lua代码中获取当前阶段
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665739573724-70db50bf-6087-4dce-8f77-dd5786a033a9.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=421&id=ua73806a1&name=image.png&originHeight=842&originWidth=1614&originalType=binary&ratio=1&rotation=0&showTitle=false&size=683117&status=done&style=none&taskId=u2af63f42-584d-4195-9ab0-a0d24cfecdb&title=&width=807)
<a name="H3Cbq"></a>
#### 6.2.5 Openresty中Lua和C代码交互原理
<a name="RtYno"></a>
##### Lua FFI
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665739731403-e0e938ab-079a-4302-afc9-e4640db21878.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=603&id=u2b937f91&name=image.png&originHeight=1206&originWidth=2300&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1020278&status=done&style=none&taskId=uaeb17d96-c18c-4906-8fac-dccdaf34d62&title=&width=1150)
<a name="ldcYo"></a>
##### 系统级配置指令
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665739853526-8f1e866b-5dfd-4e5a-af11-84dd957d1b5a.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=569&id=ue25a1219&name=image.png&originHeight=1138&originWidth=2284&originalType=binary&ratio=1&rotation=0&showTitle=false&size=801470&status=done&style=none&taskId=ua403167f-abab-40aa-bfbd-812a37d0184&title=&width=1142)
<a name="XTHZf"></a>
##### 取得配置参数的SDK
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665740369071-00efb1a2-21b6-4108-90f5-3ca542835cfc.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=585&id=u9193abea&name=image.png&originHeight=1170&originWidth=2208&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1351697&status=done&style=none&taskId=u28b7dab6-dbf2-435f-9ddd-1b6e4228b19&title=&width=1104)
<a name="gfHjR"></a>
#### 6.2.6 获取、修改请求和响应的SDK
<a name="pCGk0"></a>
##### 读取、修改变量的SDK
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665740277738-53e97b4c-6ac9-4fcd-a41c-2df20e663914.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=166&id=uded0cbd8&name=image.png&originHeight=332&originWidth=1378&originalType=binary&ratio=1&rotation=0&showTitle=false&size=285136&status=done&style=none&taskId=u6f6c9410-cc26-4f73-925a-add311ae920&title=&width=689)
<a name="t5v4P"></a>
##### 客户端提前关闭连接
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665740399399-12ab51bc-490c-4dca-8aa3-a06ad3eca8d2.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=225&id=u1cf997da&name=image.png&originHeight=450&originWidth=1376&originalType=binary&ratio=1&rotation=0&showTitle=false&size=236434&status=done&style=none&taskId=ud90c6be7-9d46-4f90-a9c2-586ef65d6f4&title=&width=688) 
<a name="CezhR"></a>
##### 获取请求头部的SDK
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665740461309-ef764225-625a-4b5f-811d-0f9689f64be8.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=319&id=u454ab4f9&name=image.png&originHeight=638&originWidth=1578&originalType=binary&ratio=1&rotation=0&showTitle=false&size=401731&status=done&style=none&taskId=u91f5220c-3165-4291-afe2-ecf9b2185ab&title=&width=789)
<a name="NHnlC"></a>
##### 获取请求URL的SDK
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665740597202-7fbaa6de-b159-41fb-aa02-7dea97d41064.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=397&id=uda921cb8&name=image.png&originHeight=794&originWidth=1686&originalType=binary&ratio=1&rotation=0&showTitle=false&size=502754&status=done&style=none&taskId=u5e5a08f9-41da-46f8-9982-cae799a59d2&title=&width=843)
<a name="QP1F3"></a>
##### 获取请求Body的SDK
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22003621/1665740668288-a040c5bf-ecbf-43a6-a238-ebfe51c60a94.png#clientId=u80d883e9-bb46-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=451&id=u5d67f7ec&name=image.png&originHeight=902&originWidth=1762&originalType=binary&ratio=1&rotation=0&showTitle=false&size=863268&status=done&style=none&taskId=u9c173ea1-2690-4794-9df6-c86f8e7cfd5&title=&width=881)
<a name="Oxz7y"></a>
##### HTTP请求方法名





